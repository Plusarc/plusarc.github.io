<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="google88d81a02a91db82f" />










  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Plusaber&apos;s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Plusaber's Blog">
<meta property="og:url" content="http://yoursite.com/page/62/index.html">
<meta property="og:site_name" content="Plusaber's Blog">
<meta property="og:description" content="Plusaber&apos;s Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Plusaber's Blog">
<meta name="twitter:description" content="Plusaber&apos;s Blog">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/62/"/>


  <title> Plusaber's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-hk">

  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-79158075-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Plusaber's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            標籤
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/10/10/Design Pattern_Strategy pattern/" itemprop="url">
                  Strategy Pattern
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-10-10T00:00:00+09:00" content="2014-10-10">
              2014-10-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index">
                    <span itemprop="name">Design Pattern</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/10/10/Design Pattern_Strategy pattern/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/10/10/Design Pattern_Strategy pattern/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>假设我们要实现鸭子对象及其行为，假设鸭子行为有鸣叫，颜色，飞行等。</p>
<h1 id="Several-method"><a href="#Several-method" class="headerlink" title="Several method"></a>Several method</h1><h2 id="With-Extending"><a href="#With-Extending" class="headerlink" title="With Extending"></a>With Extending</h2><p>很自然的做法是定义一个鸭子父类，然后定义特定鸭子的子类。</p>
<p>由于不同的鸭子有不同的鸣叫，颜色，飞行等行为，如果把这些行为都放在鸭子父类中，则会导致部分不具有这些行为的鸭子也变得具有这些行为，一种弥补方法是对于这些行为什么都不做，但是会导致代码僵化，如果需要改动则需要修改所有鸭子的代码。</p>
<h2 id="With-Interface"><a href="#With-Interface" class="headerlink" title="With Interface"></a>With Interface</h2><ul>
<li>另一种实现方法是使用接口，把会飞，会叫这些行为各自独立抽象出接口，对于需要具有这些行为的鸭子，使这些鸭子实现相应的接口即可。看起来很不错，但是一个问题是，接口不具有实现代码，也就是无法达到代码的复用，如果某种功能需要更改，比如飞行行为。在这个问题下，如果许多鸭子其实是具有相同的飞行行为的，如果需要进行调整，则同样需要修改所有这些鸭子的飞行行为。</li>
</ul>
<h2 id="Strategy-mode"><a href="#Strategy-mode" class="headerlink" title="Strategy mode"></a>Strategy mode</h2><p>这里问题的关键是：<strong>没有分离出变化部分和稳定部分</strong>。一个设计原则是：</p>
<p><strong>找出应用中可能需要变化之处，把它们独立出来，不要和哪些不需要变化的代码混在一起。</strong></p>
<ul>
<li>根据上面的分析，我们应该把变化的部分和不变的不变的部分区分开来。</li>
</ul>
<p>假设在这个问题下fly()和quack()行为是会随着鸭子的不同而改变的，但并不是每种鸭子的行为都是不同功能的，部分鸭子会共享某种飞行行为或quack行为。这里我们不使用接口来抽象这些行为，因为前面提到，部分鸭子会共享某种飞行行为或quack行为，使用抽象则会导致无法复用这些代码。这里我们分别建立一组抽象来代表每个行为（可以为接口）。</p>
<p>然后对于几种不同的行为，分别实现具体类继承定义的抽象behavior。然后在鸭子类引用这些类的实例，通过调用这些实例的实现方法来实现鸭子的相应行为。也就是具体行为的实现是在这些具体行为类中实现的，鸭子只是调用这些实现方法来实现相应行为。</p>
<p>上面解释的过于抽象，简单说来关键在于：<br><strong>鸭子现在将飞行和鸣叫的动作『委托』别人处理(独立的behavior接口)，而不是定义在鸭子类内部的飞行方法或鸣叫方法(仍然会有相关方法，但是其内容就是简单的引用behavior类的具体实现)。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Duck</span> </span>&#123;</div><div class="line">	FlyBehaviour flyb;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performFly</span><span class="params">()</span> </span>&#123;</div><div class="line">		flyb.fly();  <span class="comment">// 委托给行为类</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallarDuck</span> <span class="keyword">extends</span> <span class="title">Duck</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MalllardDuck</span><span class="params">()</span> </span>&#123;</div><div class="line">		flyb = <span class="keyword">new</span> HighFlyBehavior();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NanoDuck</span> <span class="keyword">extends</span> <span class="title">Duck</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MalllardDuck</span><span class="params">()</span> </span>&#123;</div><div class="line">		flyb = <span class="keyword">new</span> SpaceFlyBehavior();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外，在鸭子类中应用behavior类时，需要注意：<br><strong>针对接口编程，而不是针对具体实现编程。</strong></p>
<p>也就是我们在鸭子类中的依赖应该是抽象behavior类引用，而不是behavior的具体实现类，否则会造成鸭子类behavior限定于某个实现类，不利于后面的改变扩展。</p>
<ul>
<li>进一步增强，实现动态设定行为。</li>
</ul>
<p>前面我们通过在鸭子类内部引用behaviour类来完成具体行为，具体是在鸭子类构造函数内完成behaviour的实例化。由于具体行为是由behaviour类的实例完成，这也就是给我们提供了动态改变鸭子实例的行为，比如通过setFlyBehaviour(FlyBehavior fb)方法设定新的行为实现类，我们便可以在运行时改变鸭子的行为。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Duck</span> </span>&#123;</div><div class="line">	FlyBehaviour flyb;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performFly</span><span class="params">()</span> </span>&#123;</div><div class="line">		flyb.fly();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlyBehaviour</span><span class="params">(FlyBehavior fb)</span> </span>&#123;</div><div class="line">		flyb = fb;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>很多时候”有一个”可能比”是一个”更好，这也是一个重要的设计原则：<br><strong>多用组合，少用继承。</strong><br>前面提到的还有：<br><strong>找出应用中可能需要变化之处，把它们独立出来，不要和哪些不需要变化的代码混在一起。</strong><br><strong>针对接口编程，而不是针对具体实现编程。</strong></p>
<p>使用组合建立系统具有很大的弹性，不仅可将算法族封装成类，更可以在运行时动态的改变行为，只要组合的行为对象符合正确的接口标准即可。</p>
<h1 id="Strategy-Pattern"><a href="#Strategy-Pattern" class="headerlink" title="Strategy Pattern"></a>Strategy Pattern</h1><p>前面使用的模式就是策略模式。策略模式定义了算法族，并分别封装起来，让它们之间可以互相替换。此模式让算法的变化独立于使用算法的类。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/10/04/SourceCode_Begining/" itemprop="url">
                  Some good project to read
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-10-04T00:00:00+09:00" content="2014-10-04">
              2014-10-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/sourcecode/" itemprop="url" rel="index">
                    <span itemprop="name">sourcecode</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/10/04/SourceCode_Begining/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/10/04/SourceCode_Begining/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一些适合阅读源码的项目介绍:<br><a href="https://www.zhihu.com/question/34544815" target="_blank" rel="external">github上可供新手阅读和玩耍的java项目有哪些？？</a></p>
<p>Project list:<br><a href="https://github.com/apache/commons-lang" target="_blank" rel="external">comons-lang</a><br><a href="https://github.com/apache/log4j" target="_blank" rel="external">log4j</a><br><a href="https://github.com/google/guava" target="_blank" rel="external">Google Guava</a><br><a href="https://github.com/apache/zookeeper" target="_blank" rel="external">zookeeper</a><br><a href="https://github.com/aosabook/500lines" target="_blank" rel="external">500lines</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/10/02/Kaggle_Preparation/" itemprop="url">
                  Kaggle_Preparation
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-10-02T00:00:00+09:00" content="2014-10-02">
              2014-10-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/kaggle/" itemprop="url" rel="index">
                    <span itemprop="name">kaggle</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/10/02/Kaggle_Preparation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/10/02/Kaggle_Preparation/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Kaggle平台入门资料和参考"><a href="#Kaggle平台入门资料和参考" class="headerlink" title="Kaggle平台入门资料和参考"></a>Kaggle平台入门资料和参考</h1><p><a href="http://blog.csdn.net/u012162613/article/details/41929171" target="_blank" rel="external">大数据竞赛平台——Kaggle 入门篇</a><br><a href="https://www.kaggle.com/wiki/Tutorials" target="_blank" rel="external">Kaggle-Tutorials</a><br><a href="https://www.kaggle.com/c/titanic" target="_blank" rel="external">Competition Demo_Titanic: Machine Learning from Disaster</a><br><a href="http://nanjunxiao.github.io/2015/07/30/Kaggle实战一/#1-_Bike_Sharing_Demand" target="_blank" rel="external">Kaggle实战(一)</a></p>
<p>Some other concerning information:<br><a href="http://www.36dsj.com/archives/27004" target="_blank" rel="external">开始搞Kaggle比赛</a><br><a href="http://nbviewer.ipython.org/gist/whbzju/ff06fce9fd738dcf8096" target="_blank" rel="external">kaggle上的自行车出租数量预测</a><br><a href="http://www.wujiame.com/blog/2015/04/18/kaggle-bike/" target="_blank" rel="external">Kaggle入门总结</a><br><a href="http://www.zhihu.com/question/24533374" target="_blank" rel="external">参加kaggle竞赛是怎样一种体验？</a><br><a href="http://www.wujiame.com/blog/2015/02/16/random-forest/" target="_blank" rel="external">Random Forest</a><br><a href="http://www.zhihu.com/question/23987009" target="_blank" rel="external">Kaggle如何入门？</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/10/01/Developing_Lucene(4)/" itemprop="url">
                  Lucene(4)_Document analysis
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-10-01T00:00:00+09:00" content="2014-10-01">
              2014-10-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Developing/" itemprop="url" rel="index">
                    <span itemprop="name">Developing</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/10/01/Developing_Lucene(4)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/10/01/Developing_Lucene(4)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Analysis是指将field的内容转换为最基本的索引表示单元–项(Term)，也就是token+field名。分析器对分析操作进行了封装，提供一系列操作将文本转换为tokens，可能包括：提取单词、取出标点符号、转为小写、去除停用词、词干还原等。这个过程称为tokenizaiton，从文本提取token，与其域名(field)结合后，就形成了项(term)。</p>
<p>使用Lucene时，选择一个合适的分析器是非常关键的，决定于语言、行业等。Lucene提供了许多内置分析器可以满足一般需要，同时如果我们需要自定义分析器，Lucene的构建模块也可以使得这一过程变得简单。</p>
<h2 id="使用分析器-analyzers"><a href="#使用分析器-analyzers" class="headerlink" title="使用分析器(analyzers)"></a>使用分析器(analyzers)</h2><p>分析操作将出现在任何需要将文本转换为Term的时候，对于Lucene核心来说，主要包括两个过程：建立索引期间和使用QueryParser对象进行搜索时。</p>
<p>下面是使用4个内置分析器分别分析两个短语，让我们先对分析操作有一个直观的认识。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Analyzing &quot;The quick brown fox jumped over the lazy dog&quot;</div><div class="line">          WhitespaceAnalyzer:</div><div class="line">            [The] [quick] [brown] [fox] [jumped] [over] [the] [lazy] [dog]</div><div class="line">          SimpleAnalyzer:</div><div class="line">            [the] [quick] [brown] [fox] [jumped] [over] [the] [lazy] [dog]</div><div class="line">          StopAnalyzer:</div><div class="line">            [quick] [brown] [fox] [jumped] [over] [lazy] [dog]</div><div class="line">          StandardAnalyzer:</div><div class="line">            [quick] [brown] [fox] [jumped] [over] [lazy] [dog]</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Analyzing &quot;XY&amp;Z Corporation - xyz@example.com&quot;</div><div class="line">  WhitespaceAnalyzer:</div><div class="line">    [XY&amp;Z] [Corporation] [-] [xyz@example.com]</div><div class="line">  SimpleAnalyzer:</div><div class="line">    [xy] [z] [corporation] [xyz] [example] [com]</div><div class="line">  StopAnalyzer:</div><div class="line">    [xy] [z] [corporation] [xyz] [example] [com]</div><div class="line">  StandardAnalyzer:</div><div class="line">    [xy&amp;z] [corporation] [xyz@example.com]</div></pre></td></tr></table></figure>
<p>可以看出分析结果中的词汇单元取决于对应的分析器。</p>
<ul>
<li>WhitespaceAnalyzer，该分析器仅仅功过空格来分割文本信息，并不对生成的token进行其他处理。</li>
<li>SimpleAnalyzer，通过非字母字符来分割文本信息，然后统一为小写形式。</li>
<li>StopAnalyzer，在上面的基础上去除停用词。</li>
<li>StandardAnalyzer，这是Lucene最复杂的核心分析器，包含大量的逻辑操作来之别某些种类的token，比如公司名称，实体，e-mail等。同样会将token转换为小写形式并去除停用词和标点符号。</li>
</ul>
<h3 id="索引过程的analysis"><a href="#索引过程的analysis" class="headerlink" title="索引过程的analysis"></a>索引过程的analysis</h3><p>在索引期间，文档field的内容需要被转换为token，用于indexing。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Analyzer analyzer = <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30);</div><div class="line">        IndexWriter writer = <span class="keyword">new</span> IndexWriter(directory, analyzer,</div><div class="line">                                IndexWriter.MaxFieldLength.UNLIMITED);</div></pre></td></tr></table></figure>
<p><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_5.png" alt="Lucene_5"></p>
<p>通常需要实例化一个Analyzer对象，然后将其传递给IndexWriter对象。如果没有指定则会使用默认的分析器。另外如果某个文档需要特殊的分析器处理的话，在addDocument和updateDocument时也可以指定分析器。</p>
<p>为了确保文本信息被分析器处理，可以在创建field时指定Field.Index.ANALYZED或Field.Index.ANLYZED_NO_NORMS参数。如果需要将整个field内容作为一个token处理（也就是不需要tokenlization），可以设置为Field.Index.NOT_ANALYZED或Field.Index.NOT_NO_ANALYZED。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Field(String, String, Field.Store.YES, Field.Index.ANALYZED) </div><div class="line"><span class="comment">//creates a tokenized and stored field. Rest assured the original</span></div><div class="line"><span class="comment">//String value is stored. But the output of the designated </span></div><div class="line"><span class="comment">//Analyzer dictates what’s indexed and available for searching.</span></div><div class="line"></div><div class="line"><span class="comment">//The following code demonstrates indexing of a document where</span></div><div class="line"><span class="comment">//one field is analyzed and stored, and the second field is </span></div><div class="line"><span class="comment">//analyzed but not stored:</span></div><div class="line"></div><div class="line">Document doc = <span class="keyword">new</span> Document();</div><div class="line">        doc.add(<span class="keyword">new</span> Field(<span class="string">"title"</span>, <span class="string">"This is the title"</span>, </div><div class="line">        	Field.Store.YES, Field.Index.ANALYZED));</div></pre></td></tr></table></figure>
<h3 id="QueryParser分析"><a href="#QueryParser分析" class="headerlink" title="QueryParser分析"></a>QueryParser分析</h3><p>QueryParser同样需要使用analyzer将query分解为各个term。分析器会接受queyr expression的连续的独立文本片段，但不会接收整个表达式。如：<br><code>&quot;president obama&quot; +harvard +professor</code><br>QueryParser会调用三次分析器，分别处理<code>&quot;president obama&quot;</code>，<code>harvard</code>，<code>professor</code>。</p>
<h2 id="What’s-inside-an-analyzer"><a href="#What’s-inside-an-analyzer" class="headerlink" title="What’s inside an analyzer?"></a>What’s inside an analyzer?</h2><p>Analyzer是一个抽象类，是所有分析器的基类。只需要实现一个抽象方法，将text转换为TokenStream实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span></span></div></pre></td></tr></table></figure>
<p>TokenStream用于循环遍历所有terms。</p>
<p>下面是简单的SimpleAnalyzer类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAnalyzer</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LowerCaseTokenizer(reader);</div><div class="line">          &#125;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> TokenStream <span class="title">reusableTokenStream</span><span class="params">(String fieldName, Reader reader</span></span></div><div class="line">               <span class="keyword">throws</span> IOException &#123;</div><div class="line">            Tokenizer tokenizer = (Tokenizer) <span class="title">getPreviousTokenStream</span><span class="params">()</span>;</div><div class="line">            <span class="keyword">if</span> (tokenizer == <span class="keyword">null</span>) &#123;</div><div class="line">              tokenizer = <span class="keyword">new</span> LowerCaseTokenizer(reader);</div><div class="line">              setPreviousTokenStream(tokenizer);</div><div class="line">            &#125; <span class="keyword">else</span></div><div class="line">              tokenizer.reset(reader);</div><div class="line">            <span class="keyword">return</span> tokenizer;</div><div class="line">&#125; &#125;</div></pre></td></tr></table></figure>
<p>LowerCasetokenizer对象根据文本中的非字母字符来分割文本，并将所有字母换成小写形式。resusableTokenStream()方法是一个可选方法，分析器可以实现这个方法实现更好的效率，因为这个方法实现了重复利用前面线程创建的TokenStream。</p>
<h3 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h3><p>token是分析过程中产生的基本单元。一个token带有其text值已经其他一些元数据，例如起始位置终止位置偏移量、类型等。文本被tokenlize之后，每个token的位置信息都是相对于前面一个token的位置的增量值进行保存，表示所有token都是连续的。</p>
<p><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_6.png" alt=""></p>
<p>在tokenlize之后，每个token连接field形成term被传递给索引。位置增量(position increment)、起点(start)和终点偏移量(end offset)和有效负载(payload)是token一起附带到索引的元数据。</p>
<p>位置增量使得当前token和前一个token在位置上关联起来。一般来说位置增量为1，表示每个token存在于field中唯一且连续的位置上。位置增量因子会直接影响短语查询(phrase queries)和跨度查询(span queries)，因为这些查询需要知道field中各个term之间的距离。</p>
<p>如果位置增量大于1，则允许token之间有空隙，可以用这个空隙来表示被删除的单词。<br>位置增量为0的token表示该token放置与与前一个token相同的位置上。同义词分析器可以通过0增量来表示插入的同义词。</p>
<h3 id="分析TokenStream"><a href="#分析TokenStream" class="headerlink" title="分析TokenStream"></a>分析TokenStream</h3><p>TokenStream是一个能在被调用后产生token序列的类，TokenStream类有两种不同类型：Tokenizer类和TokenFilter类。注意TokenFilter类可以封装另一个TokenStream抽象类对象。</p>
<p><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_7.png" alt=""></p>
<p>Tokenizer对象通过java.io.Reaser对象读取字符并创建token，而TokenFilter则负责处理输入的token，然后通过新增、删除或修改属性的方式来产生新的token。</p>
<p>当分析器从它的tokenStream方法或者reusableTokenStream方法返回tokenStream对象后，就可以用一个tokenizer对象创建tokens序列，然后再链接任意数量的tokenFilter对象来对这些tokens进行修改。这被称为分析器链（analyzer chain）。</p>
<p><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_8.png" alt=""></p>
<p>下面是Lucene的核心Tokenizer类和TokenFilter类。</p>
<table>
<thead>
<tr>
<th>Class name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>TokenStream</td>
<td>Abstract Tokenizer base class.</td>
</tr>
<tr>
<td>Tokenizer</td>
<td>TokenStream whose input is a Reader.</td>
</tr>
<tr>
<td>CharTokenizer</td>
<td>Parent class of character-based tokenizers, with abstract isTokenChar() method. Emits tokens for contiguous blocks when isTokenChar() returns true. Also provides the capability to normalize (for example, lowercase) characters. Tokens are limited to a maximum size of 255 characters.</td>
</tr>
<tr>
<td>WhitespaceTokenizer</td>
<td>CharTokenizer with isTokenChar() true for all nonwhitespace characters.</td>
</tr>
<tr>
<td>KeywordTokenizer</td>
<td>Tokenizes the entire input string as a single token.</td>
<td></td>
</tr>
<tr>
<td>LetterTokenizer</td>
<td>Tokenizes the entire input string as a single token. CharTokenizer with isTokenChar() true when Character.isLetter is true.</td>
</tr>
<tr>
<td>LowerCaseTokenizer</td>
<td>LetterTokenizer that normalizes all characters to lowercase.</td>
</tr>
<tr>
<td>SinkTokenizer</td>
<td>A Tokenizer that absorbs tokens, caches them in a private list, and can later iterate over the tokens it had previously cached. This is used in conjunction with TeeTokenizer to “split” a TokenStream.</td>
</tr>
<tr>
<td>StandardTokenizer</td>
<td>Sophisticated grammar-based tokenizer, emitting tokens for high-level types like email addresses (see section 4.3.2 for more details). Each emitted token is tagged with a special type, some of which are handled specially by StandardFilter.</td>
</tr>
<tr>
<td>TokenFilter</td>
<td>TokenStream whose input is another TokenStream.</td>
</tr>
<tr>
<td>LowerCaseFilter</td>
<td>Lowercases token text.</td>
</tr>
<tr>
<td>StopFilter</td>
<td>Removes words that exist in a provided set of words.</td>
</tr>
<tr>
<td>PorterStemFilter</td>
<td>Stems each token using the Porter stemming algorithm. For example, country and countries both stem to countri.</td>
</tr>
<tr>
<td>TeeTokenFilter</td>
<td>Splits a TokenStream by passing each token it iterates through into a SinkTokenizer. It also returns the token unnmodified to its caller.</td>
</tr>
<tr>
<td>ASCIIFoldingFilter</td>
<td>Maps accented characters to their unaccented counterparts.</td>
</tr>
<tr>
<td>CachingTokenFilter</td>
<td>Saves all tokens from the input stream and can replay the stream once reset is called.</td>
</tr>
<tr>
<td>LengthFilter</td>
<td>Accepts tokens whose text length falls within a specified range.</td>
</tr>
<tr>
<td>StandardFilter</td>
<td>Designed to be fed by a StandardTokenizer. Removes dots from acronyms and ’s (apostrophe followed by s) from words with apostrophes.</td>
</tr>
</tbody>
</table>
<p>下面是生成一个分析链的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StopFilter(<span class="keyword">true</span>,</div><div class="line">                          <span class="keyword">new</span> LowerCaseTokenizer(reader),</div><div class="line">                          stopWords);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个分析器中，LowerCaseTokenizer对象会通过Reader对象输出原始tokens，然后这些token将会被StopFilter处理。</p>
<p><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_9.png" alt=""></p>
<h3 id="观察分析器分析过程"><a href="#观察分析器分析过程" class="headerlink" title="观察分析器分析过程"></a>观察分析器分析过程</h3><p>通常情况下，分析过程所产生的token会在没有展示的情况下用于索引操作或者检索。下面我们具体观察一些具体的分析过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.StopAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.SimpleAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.WhitespaceAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnalyzerDemo</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] examples = &#123;</div><div class="line">    <span class="string">"The quick brown fox jumped over the lazy dog"</span>,</div><div class="line">    <span class="string">"XY&amp;Z Corporation - xyz@example.com"</span></div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Analyzer[] analyzers = <span class="keyword">new</span> Analyzer[] &#123; </div><div class="line">    <span class="keyword">new</span> WhitespaceAnalyzer(),</div><div class="line">    <span class="keyword">new</span> SimpleAnalyzer(),</div><div class="line">    <span class="keyword">new</span> StopAnalyzer(Version.LUCENE_30),</div><div class="line">    <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30)</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">    String[] strings = examples;</div><div class="line">    <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;    <span class="comment">// A</span></div><div class="line">      strings = args;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (String text : strings) &#123;</div><div class="line">      analyze(text);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">analyze</span><span class="params">(String text)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"Analyzing \""</span> + text + <span class="string">"\""</span>);</div><div class="line">    <span class="keyword">for</span> (Analyzer analyzer : analyzers) &#123;</div><div class="line">      String name = analyzer.getClass().getSimpleName();</div><div class="line">      System.out.println(<span class="string">"  "</span> + name + <span class="string">":"</span>);</div><div class="line">      System.out.print(<span class="string">"    "</span>);</div><div class="line">      AnalyzerUtils.displayTokens(analyzer, text); <span class="comment">// B</span></div><div class="line">      System.out.println(<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// #A Analyze command-line strings, if specified</span></div><div class="line"><span class="comment">// #B Real work done in here</span></div></pre></td></tr></table></figure>
<p>下面的AnalyzerUtils调用了analyzer对text进行分析，并将得到的token直接输出，而不是用于索引。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> junit.framework.Assert;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.AttributeSource;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.SimpleAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.TermAttribute;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.TypeAttribute;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.PositionIncrementAttribute;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.OffsetAttribute;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.StringReader;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 4</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnalyzerUtils</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayTokens</span><span class="params">(Analyzer analyzer,</span></span></div><div class="line">                                   String text) <span class="keyword">throws</span> IOException &#123;</div><div class="line">    displayTokens(analyzer.tokenStream(<span class="string">"contents"</span>, <span class="keyword">new</span> StringReader(text)));  <span class="comment">//A</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayTokens</span><span class="params">(TokenStream stream)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line"></div><div class="line">    TermAttribute term = stream.addAttribute(TermAttribute.class);</div><div class="line">    <span class="keyword">while</span>(stream.incrementToken()) &#123;</div><div class="line">      System.out.print(<span class="string">"["</span> + term.term() + <span class="string">"] "</span>);    <span class="comment">//B</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/*</span></div><div class="line">    #A Invoke analysis process</div><div class="line">    #B Print token text surrounded by brackets</div><div class="line">  */</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPositionIncrement</span><span class="params">(AttributeSource source)</span> </span>&#123;</div><div class="line">    PositionIncrementAttribute attr = source.addAttribute(PositionIncrementAttribute.class);</div><div class="line">    <span class="keyword">return</span> attr.getPositionIncrement();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getTerm</span><span class="params">(AttributeSource source)</span> </span>&#123;</div><div class="line">    TermAttribute attr = source.addAttribute(TermAttribute.class);</div><div class="line">    <span class="keyword">return</span> attr.term();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getType</span><span class="params">(AttributeSource source)</span> </span>&#123;</div><div class="line">    TypeAttribute attr = source.addAttribute(TypeAttribute.class);</div><div class="line">    <span class="keyword">return</span> attr.type();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setPositionIncrement</span><span class="params">(AttributeSource source, <span class="keyword">int</span> posIncr)</span> </span>&#123;</div><div class="line">    PositionIncrementAttribute attr = source.addAttribute(PositionIncrementAttribute.class);</div><div class="line">    attr.setPositionIncrement(posIncr);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTerm</span><span class="params">(AttributeSource source, String term)</span> </span>&#123;</div><div class="line">    TermAttribute attr = source.addAttribute(TermAttribute.class);</div><div class="line">    attr.setTermBuffer(term);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(AttributeSource source, String type)</span> </span>&#123;</div><div class="line">    TypeAttribute attr = source.addAttribute(TypeAttribute.class);</div><div class="line">    attr.setType(type);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayTokensWithPositions</span></span></div><div class="line">    <span class="params">(Analyzer analyzer, String text)</span> <span class="keyword">throws</span> IOException &#123;</div><div class="line"></div><div class="line">    TokenStream stream = analyzer.tokenStream(<span class="string">"contents"</span>,</div><div class="line">                                              <span class="keyword">new</span> StringReader(text));</div><div class="line">    TermAttribute term = stream.addAttribute(TermAttribute.class);</div><div class="line">    PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>(stream.incrementToken()) &#123;</div><div class="line">      <span class="keyword">int</span> increment = posIncr.getPositionIncrement();</div><div class="line">      <span class="keyword">if</span> (increment &gt; <span class="number">0</span>) &#123;</div><div class="line">        position = position + increment;</div><div class="line">        System.out.println();</div><div class="line">        System.out.print(position + <span class="string">": "</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      System.out.print(<span class="string">"["</span> + term.term() + <span class="string">"] "</span>);</div><div class="line">    &#125;</div><div class="line">    System.out.println();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayTokensWithFullDetails</span><span class="params">(Analyzer analyzer,</span></span></div><div class="line">                                                  String text) <span class="keyword">throws</span> IOException &#123;</div><div class="line"></div><div class="line">    TokenStream stream = analyzer.tokenStream(<span class="string">"contents"</span>,                        <span class="comment">// #A</span></div><div class="line">                                              <span class="keyword">new</span> StringReader(text));</div><div class="line"></div><div class="line">    TermAttribute term = stream.addAttribute(TermAttribute.class);        <span class="comment">// #B</span></div><div class="line">    PositionIncrementAttribute posIncr =                                  <span class="comment">// #B </span></div><div class="line">    	stream.addAttribute(PositionIncrementAttribute.class);              <span class="comment">// #B</span></div><div class="line">    OffsetAttribute offset = stream.addAttribute(OffsetAttribute.class);  <span class="comment">// #B</span></div><div class="line">    TypeAttribute type = stream.addAttribute(TypeAttribute.class);        <span class="comment">// #B</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>(stream.incrementToken()) &#123;                                  <span class="comment">// #C</span></div><div class="line"></div><div class="line">      <span class="keyword">int</span> increment = posIncr.getPositionIncrement();                 <span class="comment">// #D</span></div><div class="line">      <span class="keyword">if</span> (increment &gt; <span class="number">0</span>) &#123;                                            <span class="comment">// #D</span></div><div class="line">        position = position + increment;                              <span class="comment">// #D</span></div><div class="line">        System.out.println();                                         <span class="comment">// #D</span></div><div class="line">        System.out.print(position + <span class="string">": "</span>);                            <span class="comment">// #D</span></div><div class="line">      &#125;</div><div class="line"></div><div class="line">      System.out.print(<span class="string">"["</span> +                                 <span class="comment">// #E</span></div><div class="line">                       term.term() + <span class="string">":"</span> +                   <span class="comment">// #E</span></div><div class="line">                       offset.startOffset() + <span class="string">"-&gt;"</span> +         <span class="comment">// #E</span></div><div class="line">                       offset.endOffset() + <span class="string">":"</span> +            <span class="comment">// #E</span></div><div class="line">                       type.type() + <span class="string">"] "</span>);                  <span class="comment">// #E</span></div><div class="line">    &#125;</div><div class="line">    System.out.println();</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/*</span></div><div class="line">    #A Perform analysis</div><div class="line">    #B Obtain attributes of interest</div><div class="line">    #C Iterate through all tokens</div><div class="line">    #D Compute position and print</div><div class="line">    #E Print all token details</div><div class="line">   */</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assertAnalyzesTo</span><span class="params">(Analyzer analyzer, String input,</span></span></div><div class="line">                                      String[] output) <span class="keyword">throws</span> Exception &#123;</div><div class="line">    TokenStream stream = analyzer.tokenStream(<span class="string">"field"</span>, <span class="keyword">new</span> StringReader(input));</div><div class="line"></div><div class="line">    TermAttribute termAttr = stream.addAttribute(TermAttribute.class);</div><div class="line">    <span class="keyword">for</span> (String expected : output) &#123;</div><div class="line">      Assert.assertTrue(stream.incrementToken());</div><div class="line">      Assert.assertEquals(expected, termAttr.term());</div><div class="line">    &#125;</div><div class="line">    Assert.assertFalse(stream.incrementToken());</div><div class="line">    stream.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayPositionIncrements</span><span class="params">(Analyzer analyzer, String text)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">    TokenStream stream = analyzer.tokenStream(<span class="string">"contents"</span>, <span class="keyword">new</span> StringReader(text));</div><div class="line">    PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);</div><div class="line">    <span class="keyword">while</span> (stream.incrementToken()) &#123;</div><div class="line">      System.out.println(<span class="string">"posIncr="</span> + posIncr.getPositionIncrement());</div><div class="line">    &#125;   </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    System.out.println(<span class="string">"SimpleAnalyzer"</span>);</div><div class="line">    displayTokensWithFullDetails(<span class="keyword">new</span> SimpleAnalyzer(),</div><div class="line">        <span class="string">"The quick brown fox...."</span>);</div><div class="line"></div><div class="line">    System.out.println(<span class="string">"\n----"</span>);</div><div class="line">    System.out.println(<span class="string">"StandardAnalyzer"</span>);</div><div class="line">    displayTokensWithFullDetails(<span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30),</div><div class="line">        <span class="string">"I'll email you at xyz@example.com"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">#1 Invoke analysis process</div><div class="line">#2 Output token text surrounded by brackets</div><div class="line">*/</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  AnalyzerUtils.displayTokensWithFullDetails(<span class="keyword">new</span> SimpleAnalyzer(),</div><div class="line">      <span class="string">"The quick brown fox...."</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1: [the:0-&gt;3:word]</div><div class="line">2: [quick:4-&gt;9:word]</div><div class="line">3: [brown:10-&gt;15:word]</div><div class="line">4: [fox:16-&gt;19:word]</div></pre></td></tr></table></figure>
<p>可以看到，每个token都被置于与前一token邻接的位置上，这里所有的token都是单词类型的。</p>
<p><strong>属性</strong><br>需要注意的TokenStream不会显式生成包含所有token属性的token对象，而是是必须与token对应的可重用的属性结构进行交互获得这些属性，这么做主要是考虑扩展性和效率。</p>
<p>TokenStream继承类AttributeSource。AttributeSouce是一种有效并通用的类，用于提供可扩展的属性并且不需要运行时类型转换。Lucene在分析期间可以使用预定义的属性，同样我们也可以加入预定义的属性，需要实现Attribute接口。</p>
<p>Lucene内置的token属性：</p>
<table>
<thead>
<tr>
<th>Token attribute interface</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>TermAttribute</td>
<td>Token’s text</td>
</tr>
<tr>
<td>PositionIncrementAttribute</td>
<td>Position increment (defaults to 1)</td>
</tr>
<tr>
<td>OffsetAttribute</td>
<td>Start and end character offset</td>
</tr>
<tr>
<td>TypeAttribute</td>
<td>Token’s type (defaults to word)</td>
</tr>
<tr>
<td>FlagsAttribute</td>
<td>Bits to encode custom flags</td>
</tr>
<tr>
<td>PayloadAttribute</td>
<td>Per-token byte[] payload (see section 6.5)</td>
</tr>
</tbody>
</table>
<p>通过这个可重用的API，我们可以首先通过调用addAttribute方法来获取所需要的属性，该方法会返回一个实现对应接口的具体类的实例。然后我们可以调用TokenStream的incrementToken()方法来顺序访问所有的token。如果该方法成功移动到下一个token则会返回true，这时之前获得的属性实例都会将内部状态修改为下一个token的属性，我们可以通过这些属性实例进行交互获得token的属性值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">TokenStream stream = analyzer.tokenStream(<span class="string">"contents"</span>,</div><div class="line">                                          <span class="keyword">new</span> StringReader(text));</div><div class="line">                                          </div><div class="line">PositionIncrementAttribute posIncr =  stream.addAttribute(PositionIncrementAttribute.class);</div><div class="line"><span class="keyword">while</span> (stream.incrementToken()) &#123;</div><div class="line">  System.out.println(<span class="string">"posIncr="</span> + posIncr.getPositionIncrement());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意通过上面的属性实例是双向的，我们也可以为token设置属性，</p>
<p>另外，我们也可以控制PositionIncrement，也就是控制是否移到下一个词，也就是通过保持位置不变，我们可以在当前位置添加很多词，而不是原来当前位置的一个词，通过TokenPositionIncrementAttribute.setPositionIncrement(0)可以实现，同样也可以跳过一些词，一般token与token之间的增量是1.<br>通过这种方法我们可以在同一位置添加同义词，从而实现同义词的去querying。</p>
<p>另外有时我们需要对当前处理的token进行一个完整的备份，用于之后回到当前这个状态。我们可以通过调用captureState来实现记录当前状态，然会一个State对象(保存了所有的状态，属性)。之后我们可以调用restoreStore进行恢复。注意这个方法的代价很高，一般应该尽量避免。</p>
<p>起始和结束位置偏移量可以用于TermVector类进行索引，通常可用于高亮现实搜索结果。</p>
<p>我们还可以设置token类型，如StandardAnalyzer对<code>I’ll email you at xyz@exam- ple.com</code>的处理结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1: [i&apos;ll:0-&gt;4:&lt;APOSTROPHE&gt;]</div><div class="line">2: [email:5-&gt;10:&lt;ALPHANUM&gt;]</div><div class="line">3: [you:11-&gt;14:&lt;ALPHANUM&gt;]</div><div class="line">5: [xyz@example.com:18-&gt;33:&lt;EMAIL&gt;]</div></pre></td></tr></table></figure>
<p>token类型还可以用于metaphone和同义词分析器。但是默认情况下。Lucene并不将token类型编入索引，而只是在分析时使用，因此如果有这个需求时，我们需要使用TypeAsPayload的token filter将类型作为有效负载记录下来。</p>
<h3 id="TokenFilter的顺序很重要"><a href="#TokenFilter的顺序很重要" class="headerlink" title="TokenFilter的顺序很重要"></a>TokenFilter的顺序很重要</h3><p>TokenFilter链在处理token时顺序很重要，如果过滤停用词时，我们需要首先使用LowerCaseFilter，然后再使用StopFilter。如果使用错误的顺序StopFilter，LowerCaseFilter，那么<code>The</code>有可能不会被过滤掉，因为StopFilter默认所有字符已经是小写所以只会匹配<code>the</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// correct version</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopAnalyzer2</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Set stopWords;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StopAnalyzer2</span><span class="params">()</span> </span>&#123;</div><div class="line">    stopWords = StopAnalyzer.ENGLISH_STOP_WORDS_SET;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StopAnalyzer2</span><span class="params">(String[] stopWords)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.stopWords = StopFilter.makeStopSet(stopWords);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StopFilter(<span class="keyword">true</span>, <span class="keyword">new</span> LowerCaseFilter(<span class="keyword">new</span> LetterTokenizer(reader)),</div><div class="line">        stopWords);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// wrong version</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopAnalyzerFlawed</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> Set stopWords;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StopAnalyzerFlawed</span><span class="params">()</span> </span>&#123;</div><div class="line">    stopWords = StopAnalyzer.ENGLISH_STOP_WORDS_SET;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StopAnalyzerFlawed</span><span class="params">(String[] stopWords)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.stopWords = StopFilter.makeStopSet(stopWords);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Ordering mistake here</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LowerCaseFilter(</div><div class="line">           <span class="keyword">new</span> StopFilter(<span class="keyword">true</span>, <span class="keyword">new</span> LetterTokenizer(reader),</div><div class="line">                          stopWords));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用内置分析器"><a href="#使用内置分析器" class="headerlink" title="使用内置分析器"></a>使用内置分析器</h2><p>Lucene的一些常用分析器：</p>
<table>
<thead>
<tr>
<th>Analyzer</th>
<th>Steps taken</th>
</tr>
</thead>
<tbody>
<tr>
<td>WhitespaceAnalyzer</td>
<td>Splits tokens at whitespace.</td>
</tr>
<tr>
<td>SimpleAnalyzer</td>
<td>Divides text at nonletter characters and lowercases.</td>
</tr>
<tr>
<td>StopAnalyzer</td>
<td>Divides text at nonletter characters, lowercases, and removes stop words.</td>
</tr>
<tr>
<td>KeywordAnalyzer</td>
<td>Treats entire text as a single token.</td>
</tr>
<tr>
<td>StandardAnalyzer</td>
<td>Tokenizes based on a sophisticated grammar that recognizes email addresses, acronyms, Chinese-Japanese-Korean characters, alphanumer- ics, and more. It also lowercases and removes stop words.</td>
</tr>
</tbody>
</table>
<p><strong>StopAnalyzer</strong><br>StopAnalyzer分析器除了完成基本的token拆分和小写化功能之外，还负责移除停用词(stop words)。StopAnalyzer类内置了如下一个常用常用英文停用词集合，该集合有<code>ENGLISH_STOP_WORDS_SET</code>定义，默认包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&quot;a&quot;, &quot;an&quot;, &quot;and&quot;, &quot;are&quot;, &quot;as&quot;, &quot;at&quot;, &quot;be&quot;, &quot;but&quot;, &quot;by&quot;,</div><div class="line">        &quot;for&quot;, &quot;if&quot;, &quot;in&quot;, &quot;into&quot;, &quot;is&quot;, &quot;it&quot;,  &quot;no&quot;, &quot;not&quot;, &quot;of&quot;, &quot;on&quot;,</div><div class="line">        &quot;or&quot;, &quot;such&quot;,&quot;that&quot;, &quot;the&quot;, &quot;their&quot;, &quot;then&quot;, &quot;there&quot;, &quot;these&quot;,</div><div class="line">        &quot;they&quot;, &quot;this&quot;, &quot;to&quot;, &quot;was&quot;, &quot;will&quot;, &quot;with&quot;</div></pre></td></tr></table></figure>
<p>StopAnalyzer有一个可重载的构造方法，允许通过这个方法传入子集的停用词集合。</p>
<p><strong>StandardAnalyzer</strong><br>StandardAnalyzer是最复杂强大也是最使用的Lucene内置分析器。</p>
<p><strong>分析器的选择</strong></p>
<p>大部分应用程序都不使用任意一种内置分析器，而是选择创建自己的分析器链，因为很多情况下都有特殊的需求，如自定义停用词列表，特殊的tokenlization操作等。</p>
<p>后面的部分将介绍如何创建自己的实用分析器，包括两种常用功能：近音词查询和同义词扩展。</p>
<h2 id="近音词查询-Sounds-like-querying"><a href="#近音词查询-Sounds-like-querying" class="headerlink" title="近音词查询(Sounds-like querying)"></a>近音词查询(Sounds-like querying)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaphoneAnalyzerTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testKoolKat</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RAMDirectory directory = <span class="keyword">new</span> RAMDirectory();</div><div class="line">    Analyzer analyzer = <span class="keyword">new</span> MetaphoneReplacementAnalyzer();</div><div class="line"></div><div class="line">    IndexWriter writer = <span class="keyword">new</span> IndexWriter(directory, analyzer, <span class="keyword">true</span>,</div><div class="line">                                         IndexWriter.MaxFieldLength.UNLIMITED);</div><div class="line"></div><div class="line">    Document doc = <span class="keyword">new</span> Document();</div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"contents"</span>, <span class="comment">//#A</span></div><div class="line">                      <span class="string">"cool cat"</span>,</div><div class="line">                      Field.Store.YES,</div><div class="line">                      Field.Index.ANALYZED));</div><div class="line">    writer.addDocument(doc);</div><div class="line">    writer.close();</div><div class="line"></div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(directory);</div><div class="line"></div><div class="line">    Query query = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,  <span class="comment">//#B</span></div><div class="line">                                  <span class="string">"contents"</span>, analyzer)    <span class="comment">//#B</span></div><div class="line">                              .parse(<span class="string">"kool kat"</span>);          <span class="comment">//#B</span></div><div class="line"></div><div class="line">    TopDocs hits = searcher.search(query, <span class="number">1</span>);</div><div class="line">    assertEquals(<span class="number">1</span>, hits.totalHits);   <span class="comment">//#C</span></div><div class="line">    <span class="keyword">int</span> docID = hits.scoreDocs[<span class="number">0</span>].doc;</div><div class="line">    doc = searcher.doc(docID);</div><div class="line">    assertEquals(<span class="string">"cool cat"</span>, doc.get(<span class="string">"contents"</span>));   <span class="comment">//#D</span></div><div class="line"></div><div class="line">    searcher.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">    #A Index document</div><div class="line">    #B Parse query text</div><div class="line">    #C Verify match</div><div class="line">    #D Retrieve original value</div><div class="line">  */</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    MetaphoneReplacementAnalyzer analyzer =</div><div class="line">                                 <span class="keyword">new</span> MetaphoneReplacementAnalyzer();</div><div class="line">    AnalyzerUtils.displayTokens(analyzer,</div><div class="line">                   <span class="string">"The quick brown fox jumped over the lazy dog"</span>);</div><div class="line"></div><div class="line">    System.out.println(<span class="string">""</span>);</div><div class="line">    AnalyzerUtils.displayTokens(analyzer,</div><div class="line">                   <span class="string">"Tha quik brown phox jumpd ovvar tha lazi dag"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关键是MetaphoneReplacementAnalyzer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaphoneReplacementAnalyzer</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MetaphoneReplacementFilter(</div><div class="line">                   <span class="keyword">new</span> LetterTokenizer(reader));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaphoneReplacementFilter</span> <span class="keyword">extends</span> <span class="title">TokenFilter</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String METAPHONE = <span class="string">"metaphone"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Metaphone metaphoner = <span class="keyword">new</span> Metaphone();</div><div class="line">  <span class="keyword">private</span> TermAttribute termAttr;</div><div class="line">  <span class="keyword">private</span> TypeAttribute typeAttr;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MetaphoneReplacementFilter</span><span class="params">(TokenStream input)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(input);</div><div class="line">    termAttr = addAttribute(TermAttribute.class);</div><div class="line">    typeAttr = addAttribute(TypeAttribute.class);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">incrementToken</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!input.incrementToken())                    <span class="comment">//#A  </span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;                                 <span class="comment">//#A  </span></div><div class="line"></div><div class="line">    String encoded;</div><div class="line">    encoded = metaphoner.encode(termAttr.term());   <span class="comment">//#B</span></div><div class="line">    termAttr.setTermBuffer(encoded);                <span class="comment">//#C</span></div><div class="line">    typeAttr.setType(METAPHONE);                    <span class="comment">//#D</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的核心是将一个词转化为它的语音词根(phonetic root)，也就是Metaphne algorithm，这里使用了Apache Commons Codec project的实现。</p>
<p>具体实现是将每个incoming的token的text在同一位置替换为该token的phonetic root，并设置为类型为METAPHONE。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String encoded;</div><div class="line">encoded = metaphoner.encode(termAttr.term());</div><div class="line">termAttr.setTermBuffer(encoded);</div><div class="line">typeAttr.setType(METAPHONE);</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  MetaphoneReplacementAnalyzer analyzer =</div><div class="line">                               <span class="keyword">new</span> MetaphoneReplacementAnalyzer();</div><div class="line">  AnalyzerUtils.displayTokens(analyzer,</div><div class="line">                 <span class="string">"The quick brown fox jumped over the lazy dog"</span>);</div><div class="line"></div><div class="line">  System.out.println(<span class="string">""</span>);</div><div class="line">  AnalyzerUtils.displayTokens(analyzer,</div><div class="line">                 <span class="string">"Tha quik brown phox jumpd ovvar tha lazi dag"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以发现samples经过metaphone encoder处理后是完全一样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[0] [KK] [BRN] [FKS] [JMPT] [OFR] [0] [LS] [TKS]</div><div class="line">[0] [KK] [BRN] [FKS] [JMPT] [OFR] [0] [LS] [TKS]</div></pre></td></tr></table></figure>
<p>在实际情况下，我们只在特殊情况下使用sound-like querying，因为sound-like querying通常也会匹配许多完全不相关的结果。Google的策略是只有在用户现有的query存在拼写错误或者几乎没有匹配结果的情况下，才会使用sounld-like querying为用户提供suggestion。</p>
<h2 id="同义词查询"><a href="#同义词查询" class="headerlink" title="同义词查询"></a>同义词查询</h2><p>一种处理同义词的方法是使得analyzer将token的同义词插入到现在正在处理的token stream中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJumps</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">  TokenStream stream =</div><div class="line">    synonymAnalyzer.tokenStream(<span class="string">"contents"</span>,                   <span class="comment">// #A</span></div><div class="line">                                <span class="keyword">new</span> StringReader(<span class="string">"jumps"</span>));   <span class="comment">// #A</span></div><div class="line">  TermAttribute term = stream.addAttribute(TermAttribute.class);</div><div class="line">  PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);</div><div class="line"></div><div class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">  String[] expected = <span class="keyword">new</span> String[]&#123;<span class="string">"jumps"</span>,              <span class="comment">// #B</span></div><div class="line">                                   <span class="string">"hops"</span>,               <span class="comment">// #B</span></div><div class="line">                                   <span class="string">"leaps"</span>&#125;;             <span class="comment">// #B</span></div><div class="line">  <span class="keyword">while</span>(stream.incrementToken()) &#123;</div><div class="line">    assertEquals(expected[i], term.term());</div><div class="line"></div><div class="line">    <span class="keyword">int</span> expectedPos;      <span class="comment">// #C</span></div><div class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;         <span class="comment">// #C</span></div><div class="line">      expectedPos = <span class="number">1</span>;    <span class="comment">// #C</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;              <span class="comment">// #C</span></div><div class="line">      expectedPos = <span class="number">0</span>;    <span class="comment">// #C</span></div><div class="line">    &#125;                     <span class="comment">// #C</span></div><div class="line">    assertEquals(expectedPos,                      <span class="comment">// #C</span></div><div class="line">                 posIncr.getPositionIncrement());  <span class="comment">// #C</span></div><div class="line">    i++;</div><div class="line">  &#125;</div><div class="line">  assertEquals(<span class="number">3</span>, i);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SynonymAnalyzer首先需要detect具有同义词的token的出现，然后将这个token的synonyms插入到相同位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.LowerCaseFilter;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.StopFilter;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.StopAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardTokenizer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardFilter;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"><span class="keyword">import</span> java.io.Reader;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 4</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynonymAnalyzer</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> SynonymEngine engine;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SynonymAnalyzer</span><span class="params">(SynonymEngine engine)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.engine = engine;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</div><div class="line">    TokenStream result = <span class="keyword">new</span> SynonymFilter(</div><div class="line">                          <span class="keyword">new</span> StopFilter(<span class="keyword">true</span>,</div><div class="line">                            <span class="keyword">new</span> LowerCaseFilter(</div><div class="line">                              <span class="keyword">new</span> StandardFilter(</div><div class="line">                                <span class="keyword">new</span> StandardTokenizer(</div><div class="line">                                 Version.LUCENE_30, reader))),</div><div class="line">                            StopAnalyzer.ENGLISH_STOP_WORDS_SET),</div><div class="line">                          engine</div><div class="line">                         );</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenFilter;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.TermAttribute;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.PositionIncrementAttribute;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.AttributeSource;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.Stack;</div><div class="line"><span class="keyword">import</span> lia.analysis.AnalyzerUtils;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 4</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynonymFilter</span> <span class="keyword">extends</span> <span class="title">TokenFilter</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOKEN_TYPE_SYNONYM = <span class="string">"SYNONYM"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Stack&lt;String&gt; synonymStack;</div><div class="line">  <span class="keyword">private</span> SynonymEngine engine;</div><div class="line">  <span class="keyword">private</span> AttributeSource.State current;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TermAttribute termAtt;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PositionIncrementAttribute posIncrAtt;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SynonymFilter</span><span class="params">(TokenStream in, SynonymEngine engine)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(in);</div><div class="line">    synonymStack = <span class="keyword">new</span> Stack&lt;String&gt;();                     <span class="comment">//#1 </span></div><div class="line">    <span class="keyword">this</span>.engine = engine;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.termAtt = addAttribute(TermAttribute.class);</div><div class="line">    <span class="keyword">this</span>.posIncrAtt = addAttribute(PositionIncrementAttribute.class);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">incrementToken</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (synonymStack.size() &gt; <span class="number">0</span>) &#123;                          <span class="comment">//#2</span></div><div class="line">      String syn = synonymStack.pop();                      <span class="comment">//#2</span></div><div class="line">      restoreState(current);                                <span class="comment">//#2</span></div><div class="line">      termAtt.setTermBuffer(syn);</div><div class="line">      posIncrAtt.setPositionIncrement(<span class="number">0</span>);                   <span class="comment">//#3</span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!input.incrementToken())                            <span class="comment">//#4  </span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (addAliasesToStack()) &#123;                              <span class="comment">//#5 </span></div><div class="line">      current = captureState();                             <span class="comment">//#6</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;                                            <span class="comment">//#7</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addAliasesToStack</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    String[] synonyms = engine.getSynonyms(termAtt.term()); <span class="comment">//#8</span></div><div class="line">    <span class="keyword">if</span> (synonyms == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (String synonym : synonyms) &#123;                       <span class="comment">//#9</span></div><div class="line">      synonymStack.push(synonym);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">#1 Define synonym buffer</div><div class="line">#2 Pop buffered synonyms</div><div class="line">#3 Set position increment to 0</div><div class="line">#4 Read next token</div><div class="line">#5 Push synonyms onto stack</div><div class="line">#6 Save current token</div><div class="line">#7 Return current token</div><div class="line">#8 Retrieve synonyms</div><div class="line">#9 Push synonyms onto stack</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>考虑到SynonymEngine的可扩展性，因此SynoymEngine类被设计成只有一个方法的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SynonymEngine</span> </span>&#123;</div><div class="line">      String[] getSynonyms(String s) <span class="keyword">throws</span> IOException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是一个简单的测试实现方法，实际上Lucene提供了一个基于WordNet的强大的SynonymEngine类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSynonymEngine</span> <span class="keyword">implements</span> <span class="title">SynonymEngine</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, String[]&gt; map = <span class="keyword">new</span> HashMap&lt;String, String[]&gt;();</div><div class="line"></div><div class="line">  <span class="keyword">static</span> &#123;</div><div class="line">    map.put(<span class="string">"quick"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"fast"</span>, <span class="string">"speedy"</span>&#125;);</div><div class="line">    map.put(<span class="string">"jumps"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"leaps"</span>, <span class="string">"hops"</span>&#125;);</div><div class="line">    map.put(<span class="string">"over"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"above"</span>&#125;);</div><div class="line">    map.put(<span class="string">"lazy"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"apathetic"</span>, <span class="string">"sluggish"</span>&#125;);</div><div class="line">    map.put(<span class="string">"dog"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"canine"</span>, <span class="string">"pooch"</span>&#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> String[] getSynonyms(String s) &#123;</div><div class="line">    <span class="keyword">return</span> map.get(s);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完整测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynonymAnalyzerTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> IndexSearcher searcher;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> SynonymAnalyzer synonymAnalyzer =</div><div class="line">                      <span class="keyword">new</span> SynonymAnalyzer(<span class="keyword">new</span> TestSynonymEngine());</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    RAMDirectory directory = <span class="keyword">new</span> RAMDirectory();</div><div class="line"></div><div class="line">    IndexWriter writer = <span class="keyword">new</span> IndexWriter(directory,</div><div class="line">                                         synonymAnalyzer,  <span class="comment">//#1  </span></div><div class="line">                                         IndexWriter.MaxFieldLength.UNLIMITED);</div><div class="line">    Document doc = <span class="keyword">new</span> Document();</div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"content"</span>,</div><div class="line">                      <span class="string">"The quick brown fox jumps over the lazy dog"</span>,</div><div class="line">                      Field.Store.YES,</div><div class="line">                      Field.Index.ANALYZED));  <span class="comment">//#2</span></div><div class="line">    writer.addDocument(doc);</div><div class="line">                                  </div><div class="line">    writer.close();</div><div class="line"></div><div class="line">    searcher = <span class="keyword">new</span> IndexSearcher(directory, <span class="keyword">true</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    searcher.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJumps</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    TokenStream stream =</div><div class="line">      synonymAnalyzer.tokenStream(<span class="string">"contents"</span>,                   <span class="comment">// #A</span></div><div class="line">                                  <span class="keyword">new</span> StringReader(<span class="string">"jumps"</span>));   <span class="comment">// #A</span></div><div class="line">    TermAttribute term = stream.addAttribute(TermAttribute.class);</div><div class="line">    PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    String[] expected = <span class="keyword">new</span> String[]&#123;<span class="string">"jumps"</span>,              <span class="comment">// #B</span></div><div class="line">                                     <span class="string">"hops"</span>,               <span class="comment">// #B</span></div><div class="line">                                     <span class="string">"leaps"</span>&#125;;             <span class="comment">// #B</span></div><div class="line">    <span class="keyword">while</span>(stream.incrementToken()) &#123;</div><div class="line">      assertEquals(expected[i], term.term());</div><div class="line"></div><div class="line">      <span class="keyword">int</span> expectedPos;      <span class="comment">// #C</span></div><div class="line">      <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;         <span class="comment">// #C</span></div><div class="line">        expectedPos = <span class="number">1</span>;    <span class="comment">// #C</span></div><div class="line">      &#125; <span class="keyword">else</span> &#123;              <span class="comment">// #C</span></div><div class="line">        expectedPos = <span class="number">0</span>;    <span class="comment">// #C</span></div><div class="line">      &#125;                     <span class="comment">// #C</span></div><div class="line">      assertEquals(expectedPos,                      <span class="comment">// #C</span></div><div class="line">                   posIncr.getPositionIncrement());  <span class="comment">// #C</span></div><div class="line">      i++;</div><div class="line">    &#125;</div><div class="line">    assertEquals(<span class="number">3</span>, i);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">    #A Analyze with SynonymAnalyzer</div><div class="line">    #B Check for correct synonyms</div><div class="line">    #C Verify synonyms positions</div><div class="line">  */</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchByAPI</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    TermQuery tq = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"content"</span>, <span class="string">"hops"</span>));  <span class="comment">//#1</span></div><div class="line">    assertEquals(<span class="number">1</span>, TestUtil.hitCount(searcher, tq));</div><div class="line"></div><div class="line">    PhraseQuery pq = <span class="keyword">new</span> PhraseQuery();    <span class="comment">//#2</span></div><div class="line">    pq.add(<span class="keyword">new</span> Term(<span class="string">"content"</span>, <span class="string">"fox"</span>));    <span class="comment">//#2</span></div><div class="line">    pq.add(<span class="keyword">new</span> Term(<span class="string">"content"</span>, <span class="string">"hops"</span>));   <span class="comment">//#2</span></div><div class="line">    assertEquals(<span class="number">1</span>, TestUtil.hitCount(searcher, pq));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">    #1 Search for "hops"</div><div class="line">    #2 Search for "fox hops"</div><div class="line">  */</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWithQueryParser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Query query = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,                   <span class="comment">// 1</span></div><div class="line">                                  <span class="string">"content"</span>,                                <span class="comment">// 1</span></div><div class="line">                                  synonymAnalyzer).parse(<span class="string">"\"fox jumps\""</span>);  <span class="comment">// 1</span></div><div class="line">    assertEquals(<span class="number">1</span>, TestUtil.hitCount(searcher, query));                   <span class="comment">// 1</span></div><div class="line">    System.out.println(<span class="string">"With SynonymAnalyzer, \"fox jumps\" parses to "</span> +</div><div class="line">                                         query.toString(<span class="string">"content"</span>));</div><div class="line"></div><div class="line">    query = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,                         <span class="comment">// 2</span></div><div class="line">                            <span class="string">"content"</span>,                                      <span class="comment">// 2</span></div><div class="line">                            <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30)).parse(<span class="string">"\"fox jumps\""</span>); <span class="comment">// B</span></div><div class="line">    assertEquals(<span class="number">1</span>, TestUtil.hitCount(searcher, query));                   <span class="comment">// 2</span></div><div class="line">    System.out.println(<span class="string">"With StandardAnalyzer, \"fox jumps\" parses to "</span> +</div><div class="line">                                         query.toString(<span class="string">"content"</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">    #1 SynonymAnalyzer finds the document</div><div class="line">    #2 StandardAnalyzer also finds document</div><div class="line">  */</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="词干分析-Stemming-analysis"><a href="#词干分析-Stemming-analysis" class="headerlink" title="词干分析(Stemming analysis)"></a>词干分析(Stemming analysis)</h2><h2 id="域分析-Field-variations"><a href="#域分析-Field-variations" class="headerlink" title="域分析(Field variations)"></a>域分析(Field variations)</h2><h2 id="语言分析-Stemming-analysis"><a href="#语言分析-Stemming-analysis" class="headerlink" title="语言分析(Stemming analysis)"></a>语言分析(Stemming analysis)</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/09/21/Developing_Lucene(3)/" itemprop="url">
                  Lucene(3)_Search
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-09-21T00:00:00+09:00" content="2014-09-21">
              2014-09-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Developing/" itemprop="url" rel="index">
                    <span itemprop="name">Developing</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/09/21/Developing_Lucene(3)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/09/21/Developing_Lucene(3)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="实现简单的搜索功能"><a href="#实现简单的搜索功能" class="headerlink" title="实现简单的搜索功能"></a>实现简单的搜索功能</h2><p>使用Lucene进行搜索时，我们可以自己构建查询语句，也可以是使用Lucene的QueryParser类将用户输入的文本转换为Query对象。</p>
<h3 id="对于term的检索"><a href="#对于term的检索" class="headerlink" title="对于term的检索"></a>对于term的检索</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> junit.framework.TestCase;</div><div class="line"></div><div class="line"><span class="keyword">import</span> lia.common.TestUtil;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.SimpleAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.index.Term;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.queryParser.QueryParser;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.TopDocs;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.Query;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.TermQuery;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 3</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicSearchingTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTerm</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Directory dir = TestUtil.getBookIndexDirectory(); <span class="comment">//A</span></div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(dir);  <span class="comment">//B</span></div><div class="line"></div><div class="line">    Term t = <span class="keyword">new</span> Term(<span class="string">"subject"</span>, <span class="string">"ant"</span>);</div><div class="line">    Query query = <span class="keyword">new</span> TermQuery(t);</div><div class="line">    TopDocs docs = searcher.search(query, <span class="number">10</span>);</div><div class="line">    assertEquals(<span class="string">"Ant in Action"</span>,                <span class="comment">//C</span></div><div class="line">                 <span class="number">1</span>, docs.totalHits);                         <span class="comment">//C</span></div><div class="line"></div><div class="line">    t = <span class="keyword">new</span> Term(<span class="string">"subject"</span>, <span class="string">"junit"</span>);</div><div class="line">    docs = searcher.search(<span class="keyword">new</span> TermQuery(t), <span class="number">10</span>);</div><div class="line">    assertEquals(<span class="string">"Ant in Action, "</span> +                                 <span class="comment">//D</span></div><div class="line">                 <span class="string">"JUnit in Action, Second Edition"</span>,                  <span class="comment">//D</span></div><div class="line">                 <span class="number">2</span>, docs.totalHits);                                 <span class="comment">//D</span></div><div class="line"></div><div class="line">    searcher.close();</div><div class="line">    dir.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">    #A Obtain directory from TestUtil</div><div class="line">    #B Create IndexSearcher</div><div class="line">    #C Confirm one hit for "ant"</div><div class="line">    #D Confirm two hits for "junit"</div><div class="line">  */</div></pre></td></tr></table></figure>
<h3 id="解析用户输入的查询表达式-QueryParser"><a href="#解析用户输入的查询表达式-QueryParser" class="headerlink" title="解析用户输入的查询表达式:QueryParser"></a>解析用户输入的查询表达式:QueryParser</h3><p>Lucene的搜索方法需要一个Query对象作为参数。对查询表达式的解析就是将用户的query text，例如<code>mock OR junit</code>，转换为对应的Query对象。</p>
<p><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_4.png" alt="Lucene_4"></p>
<p>QueryParser为查询解析提供了强大的支持，可以处理复杂的条件表达式，最后生成的Query 会非常庞大而复杂。</p>
<p>QueryParser类需要使用一个分析器将查询语句分割为多个项。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">QueryParser parser = <span class="keyword">new</span> QueryParser(Version matchVersion,</div><div class="line">                                     String field,</div><div class="line">                                     Analyzer analyzer)</div></pre></td></tr></table></figure>
<p>Version matchVersion用于告诉Lucene使用哪个版本，以实现向后兼容。<br>field用于指示默认搜索的field，除了query里明确指示了应该搜索哪个域，例如<code>title:lucene</code>。<br>analyzer指定了用于分解query的分析器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryParser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Directory dir = TestUtil.getBookIndexDirectory();</div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(dir);</div><div class="line"></div><div class="line">    QueryParser parser = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,      <span class="comment">//A</span></div><div class="line">                                         <span class="string">"contents"</span>,                  <span class="comment">//A</span></div><div class="line">                                         <span class="keyword">new</span> SimpleAnalyzer());       <span class="comment">//A</span></div><div class="line"></div><div class="line">    Query query = parser.parse(<span class="string">"+JUNIT +ANT -MOCK"</span>);                  <span class="comment">//B</span></div><div class="line">    TopDocs docs = searcher.search(query, <span class="number">10</span>);</div><div class="line">    assertEquals(<span class="number">1</span>, docs.totalHits);</div><div class="line">    Document d = searcher.doc(docs.scoreDocs[<span class="number">0</span>].doc);</div><div class="line">    assertEquals(<span class="string">"Ant in Action"</span>, d.get(<span class="string">"title"</span>));</div><div class="line"></div><div class="line">    query = parser.parse(<span class="string">"mock OR junit"</span>);                            <span class="comment">//B</span></div><div class="line">    docs = searcher.search(query, <span class="number">10</span>);</div><div class="line">    assertEquals(<span class="string">"Ant in Action, "</span> + </div><div class="line">                 <span class="string">"JUnit in Action, Second Edition"</span>,</div><div class="line">                 <span class="number">2</span>, docs.totalHits);</div><div class="line"></div><div class="line">    searcher.close();</div><div class="line">    dir.close();</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/*</span></div><div class="line">#A Create QueryParser</div><div class="line">#B Parse user's text</div><div class="line">  */</div></pre></td></tr></table></figure>
<p><strong>query expressions以及其QueryParser分解</strong></p>
<table>
<thead>
<tr>
<th>Query expression</th>
<th>Matches documents that</th>
</tr>
</thead>
<tbody>
<tr>
<td>java</td>
<td>Contain the term java in the default field</td>
</tr>
<tr>
<td>java junit</td>
<td>Contain the term java or junit, or both, in the default field</td>
</tr>
<tr>
<td>java OR junit</td>
<td>Contain the term java or junit, or both, in the default field</td>
</tr>
<tr>
<td>+java +junit</td>
<td>Contain both java and junit in the default field</td>
</tr>
<tr>
<td>java AND junit</td>
<td>Contain both java and junit in the default field</td>
</tr>
<tr>
<td>title:ant</td>
<td>Contain the term ant in the title field</td>
</tr>
<tr>
<td>title:extreme –subject:sports</td>
<td>Contain extreme in the title field and don’t have sports in the subject field</td>
</tr>
<tr>
<td>title:extreme AND NOT subject:sports</td>
<td>Contain extreme in the title field and don’t have sports in the subject field</td>
</tr>
<tr>
<td>(agile OR extreme) AND methodology</td>
<td>Contain methodology and must also contain agile and/or extreme, all in the default field</td>
</tr>
<tr>
<td>title:”junit in action”</td>
<td>Contain the exact phrase “junit in action” in the title field</td>
</tr>
<tr>
<td>title:”junit action”~5</td>
<td>Contain the terms junit and action within five positions of one another, in the title field</td>
</tr>
<tr>
<td>java*</td>
<td>Contain terms that begin with java, like javaspaces, javaserver, java.net, and the exact tem java itself.</td>
</tr>
<tr>
<td>java~</td>
<td>Contain terms that are close to the word java, such as lava</td>
</tr>
<tr>
<td>lastmodified: [1/1/09 TO 12/31/09]</td>
<td>Have lastmodified field values between the dates January 1, 2009 and December 31, 2009</td>
</tr>
</tbody>
</table>
<h2 id="使用IndexSearcher"><a href="#使用IndexSearcher" class="headerlink" title="使用IndexSearcher"></a>使用IndexSearcher</h2><h3 id="创建IndexSearcher"><a href="#创建IndexSearcher" class="headerlink" title="创建IndexSearcher"></a>创建IndexSearcher</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Directory dir = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"/path/to/index"</span>));</div><div class="line">IndexReader reader = IndexReader.open(dir);</div><div class="line">IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);</div></pre></td></tr></table></figure>
<p>IndexReaser完成了诸如打开索引系统文件和提供底层reader API等繁重的工作，而IndexSearcher则要简单很多。打开一个IndexReader需要较大的系统开销，所有在搜索期间最好重复使用同一个或有限的几个IndexReader实例，只在有必要的时候才创建新的IndexReader。</p>
<p>另外还可以从Directory直接创建IndexSearcher，这时会创建这个searcher自己的IndexReader，searcher关闭时这个reader也会关闭，消耗比较大。</p>
<p>IndexReader的读操作总是基于它创建时的快照，如果index发生了改变而且我们需要IndexReader同步这些修改，我们需要重新创建一个IndexReader。如果已经有建立的reader，这时可以调用IndexReaser.reopen，会conver所有的change，同时资源消耗会远小于直接创建一个新的reader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">IndexReader newReader = reader.reopen();</div><div class="line"><span class="keyword">if</span> (reader != newReader) &#123;</div><div class="line">  reader.close();</div><div class="line">  reader = newReader;</div><div class="line">  searcher = <span class="keyword">new</span> IndexSearcher(reader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果索引有所变更，reopen方法返回一个新的reader，这是程序必须关闭reader并创建新的searcher。在实际的应用程序中，可能还有多个线程在使用旧的reader，我们要注意保证线程安全。</p>
<h3 id="实现搜索功能"><a href="#实现搜索功能" class="headerlink" title="实现搜索功能"></a>实现搜索功能</h3><p>在建立IndexSearcher实例后，使用<code>search(Query, int)</code>方法进行检索。另外更好高级的操作还有过滤和排序。</p>
<table>
<thead>
<tr>
<th>search method</th>
<th>when to use</th>
</tr>
</thead>
<tbody>
<tr>
<td>TopDocs search(Query query, int n)</td>
<td>Straightforward searches. The int n parameter specifies how many top-scoring documents to return.</td>
</tr>
<tr>
<td>TopDocs search(Query query, Filter filter, int n)</td>
<td>Searches constrained to a subset of available documents, based on filter criteria.</td>
</tr>
<tr>
<td>TopFieldDocs search(Query query, Filter filter, int n, Sort sort)</td>
<td>Searches constrained to a subset of available documents based on filter criteria, and sorted by a custom Sort object</td>
</tr>
<tr>
<td>void search(Query query, Collector results)</td>
<td>Used when you have custom logic to implement for each document visited, or you’d like to collect a different subset of documents than the top N by the sort criteria.</td>
</tr>
<tr>
<td>void search(Query query, Filter filter, Collector results)</td>
<td>Same as previous, except documents are only accepted if they pass the filter criteria.</td>
</tr>
</tbody>
</table>
<h3 id="Working-with-TopDocs"><a href="#Working-with-TopDocs" class="headerlink" title="Working with TopDocs"></a>Working with TopDocs</h3><table>
<thead>
<tr>
<th>TopDocs method or attribute</th>
<th>Return value</th>
</tr>
</thead>
<tbody>
<tr>
<td>totalHits</td>
<td>Number of documents that matched the search</td>
</tr>
<tr>
<td>scoreDocs</td>
<td>Array of ScoreDoc instances that contains the results</td>
</tr>
<tr>
<td>getMaxScore()</td>
<td>Returns best score of all matches, if scoring was done while searching (when sorting by field, you separately control whether scores are computed)</td>
</tr>
</tbody>
</table>
<h3 id="搜索结果分页"><a href="#搜索结果分页" class="headerlink" title="搜索结果分页"></a>搜索结果分页</h3><p>大部分情况下用户只在首页结果进行查找，但是分页仍是需要的，主要有下面两种解决方案：</p>
<ul>
<li>返回多页的结果并保存在ScoreDocs和IndexSearcher中。</li>
<li>重新发送查询请求(requerying)。</li>
</ul>
<p>Requerying一般是更好的解决方案，可以减少保存用户state，在很多用户的情况下，保存很多用户的state代价是非常大的。Lucene通常查询速度非常快，而且操作系统通常会cache最近查询的数据，使得很多情况下需要的数据还在RAM中。</p>
<h3 id="Near-real-time-search"><a href="#Near-real-time-search" class="headerlink" title="Near-real-time search"></a>Near-real-time search</h3><p>Lucene 2.9开始引入近实时检索，使得我们可以快速检索最近index新添加的内容，即是IndexWriter还没有把内容写入到磁盘。许多应用程序在提供搜索功能的同时，也在不断索引新添加的内容，需要维持一个不能段时间关闭的writter，而且需要在搜索时反映出这些新添加的内容。如果writer和reader处于同一个JVM中，我们就可以使用近实时检索(Near-real-time search)。</p>
<p>近实时检索可以是我们能够检索新创建但还未完成提交的段进行检索。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.*;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.*;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.*;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> junit.framework.TestCase;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 3</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NearRealTimeTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNearRealTime</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Directory dir = <span class="keyword">new</span> RAMDirectory();</div><div class="line">    IndexWriter writer = <span class="keyword">new</span> IndexWriter(dir, <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30), IndexWriter.MaxFieldLength.UNLIMITED);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</div><div class="line">      Document doc = <span class="keyword">new</span> Document();</div><div class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>, <span class="string">""</span>+i, Field.Store.NO, Field.Index.NOT_ANALYZED_NO_NORMS));</div><div class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"text"</span>, <span class="string">"aaa"</span>, Field.Store.NO, Field.Index.ANALYZED));</div><div class="line">      writer.addDocument(doc);</div><div class="line">    &#125;</div><div class="line">    IndexReader reader = writer.getReader();                 <span class="comment">// #1</span></div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);      <span class="comment">// #A</span></div><div class="line"></div><div class="line">    Query query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"text"</span>, <span class="string">"aaa"</span>));</div><div class="line">    TopDocs docs = searcher.search(query, <span class="number">1</span>);</div><div class="line">    assertEquals(<span class="number">10</span>, docs.totalHits);                        <span class="comment">// #B</span></div><div class="line"></div><div class="line">    writer.deleteDocuments(<span class="keyword">new</span> Term(<span class="string">"id"</span>, <span class="string">"7"</span>));             <span class="comment">// #2</span></div><div class="line"></div><div class="line">    Document doc = <span class="keyword">new</span> Document();                           <span class="comment">// #3</span></div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>,                                  <span class="comment">// #3</span></div><div class="line">                      <span class="string">"11"</span>,                                  <span class="comment">// #3</span></div><div class="line">                      Field.Store.NO,                        <span class="comment">// #3</span></div><div class="line">                      Field.Index.NOT_ANALYZED_NO_NORMS));   <span class="comment">// #3</span></div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"text"</span>,                                <span class="comment">// #3</span></div><div class="line">                      <span class="string">"bbb"</span>,                                 <span class="comment">// #3</span></div><div class="line">                      Field.Store.NO,                        <span class="comment">// #3</span></div><div class="line">                      Field.Index.ANALYZED));                <span class="comment">// #3</span></div><div class="line">    writer.addDocument(doc);                                 <span class="comment">// #3</span></div><div class="line">    </div><div class="line">    IndexReader newReader = reader.reopen();                 <span class="comment">// #4</span></div><div class="line">    assertFalse(reader == newReader);                        <span class="comment">// #5</span></div><div class="line">    reader.close();                                          <span class="comment">// #6</span></div><div class="line">    searcher = <span class="keyword">new</span> IndexSearcher(newReader);              </div><div class="line"></div><div class="line">    TopDocs hits = searcher.search(query, <span class="number">10</span>);               <span class="comment">// #7</span></div><div class="line">    assertEquals(<span class="number">9</span>, hits.totalHits);                         <span class="comment">// #7</span></div><div class="line"></div><div class="line">    query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"text"</span>, <span class="string">"bbb"</span>));          <span class="comment">// #8</span></div><div class="line">    hits = searcher.search(query, <span class="number">1</span>);                        <span class="comment">// #8</span></div><div class="line">    assertEquals(<span class="number">1</span>, hits.totalHits);                         <span class="comment">// #8</span></div><div class="line"></div><div class="line">    newReader.close();</div><div class="line">    writer.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">  #1 Create near-real-time reader</div><div class="line">  #A Wrap reader in IndexSearcher</div><div class="line">  #B Search returns 10 hits</div><div class="line">  #2 Delete 1 document</div><div class="line">  #3 Add 1 document</div><div class="line">  #4 Reopen reader</div><div class="line">  #5 Confirm reader is new</div><div class="line">  #6 Close old reader</div><div class="line">  #7 Verify 9 hits now</div><div class="line">  #8 Confirm new document matched</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">#1 IndexWriter returns a reader that's able to search all previously committed changes to the index, plus any uncommitted changes.  The returned reader is always readOnly.</div><div class="line">#2,#3 We make changes to the index, but do not commit them.</div><div class="line">#4,#5,#6 Ask the reader to reopen.  Note that this simply re-calls writer.getReader again under the hood.  Because we made changes, the newReader will be different from the old one so we must close the old one.</div><div class="line">#7, #8 The changes made with the writer are reflected in new searches.</div><div class="line">*/</div></pre></td></tr></table></figure>
<h2 id="Lucene的评分机制-scoring"><a href="#Lucene的评分机制-scoring" class="headerlink" title="Lucene的评分机制(scoring)"></a>Lucene的评分机制(scoring)</h2><h3 id="How-Lucene-scores"><a href="#How-Lucene-scores" class="headerlink" title="How Lucene scores"></a>How Lucene scores</h3><p>Lucene similarity scoring formula:</p>
<p>$$ \sum_{t\in d}(tf(t\in d)\times idf(t)^2\times boost(t.field\in d)\times coord(q, d)\times queryNorm(q)) $$</p>
<p>其中d指document，t指term，q指query。<br>通过这个方程我们可以计算文档对于query的评分，通常还需要将评分进行归一化处理，也就是除以最大评分。评分越大说明文档和query的匹配程度越高。Lucene根据匹配文档的得分进行排序，然后将结果返回。</p>
<p>This score is the raw score, which is a floating-point number &gt;= 0.0. Typically, if an application presents the score to the end user, it’s best to first normalize the scores by dividing all scores by the maximum score for the query. The larger the similarity score, the better the match of the document to the query. By default Lucene returns documents reverse-sorted by this score, meaning the top documents are the best matching ones. Table 3.5 describes each of the factors in the scoring formula.<br>Boost factors are built into the equation to let you affect a query or field’s influence on score. Field boosts come in explicitly in the equation as the boost(t.field in d) factor, set at indexing time. The default value of field boosts, logically, is 1.0. During indexing, a document can be assigned a boost, too. A document boost factor implicitly sets the starting field boost of all fields to the specified value. Field-specific boosts are multiplied by the starting value, giving the final value of the field boost factor. It’s pos- sible to add the same named field to a document multiple times, and in such situations the field boost is computed as all the boosts specified for that field and document mul- tiplied together. Section 2.5 discusses index-time boosting in more detail.<br>In addition to the explicit factors in this equation, other factors can be computed on a per-query basis as part of the queryNorm factor. Queries themselves can have an impact on the document score. Boosting a Query instance is sensible only in a multi- ple-clause query; if only a single term is used for searching, changing its boost would impact all matched documents equally. In a multiple-clause Boolean query, some doc- uments may match one clause but not another, enabling the boost factor to discrimi- nate between matching documents. Queries also default to a 1.0 boost factor.<br>Most of these scoring formula factors are controlled and implemented as a sub- class of the abstract Similarity class. DefaultSimilarity is the implementation used unless otherwise specified. More computations are performed under the covers of DefaultSimilarity; for example, the term frequency factor is the square root of the actual frequency. Because this is an “in action” book, it’s beyond the book’s scope to delve into the inner workings of these calculations. In practice, it’s extremely rare to need a change in these factors. Should you need to change them, please refer to Similarity’s Javadocs, and be prepared with a solid understanding of these factors and the effect your changes will have.<br>It’s important to note that a change in index-time boosts or the Similarity meth- ods used during indexing, such as lengthNorm, require that the index be rebuilt for all factors to be in sync.<br>Let’s say you’re baffled as to why a certain document got a good score to your Query. Lucene offers a nice feature to help provide the answer.</p>
<table>
<thead>
<tr>
<th>Factor</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tf(t in d)</code></td>
<td>Term frequency factor for the term (t) in the document (d)—how many times the term t occurs in the document.</td>
</tr>
<tr>
<td><code>idf(t)</code></td>
<td>Inverse document frequency of the term: a measure of how “unique” the term is. Very common terms have a low idf; very rare terms have a high idf.</td>
</tr>
<tr>
<td><code>boost(t.field in d)</code></td>
<td>Field and document boost, as set during indexing (see section 2.5). You may use this to statically boost certain fields and certain docu- ments over others.</td>
</tr>
<tr>
<td><code>lengthNorm(t.field in d)</code></td>
<td>Normalization value of a field, given the number of terms within the field. This value is computed during indexing and stored in the index norms. Shorter fields (fewer tokens) get a bigger boost from this factor.</td>
</tr>
<tr>
<td><code>coord(q, d)</code></td>
<td>Coordination factor, based on the number of query terms the document contains. The coordination factor gives an AND-like boost to documents that contain more of the search terms than other documents.</td>
</tr>
<tr>
<td><code>queryNorm(q)</code></td>
<td>Normalization value for a query, given the sum of the squared weights of each of the query terms.</td>
</tr>
</tbody>
</table>
<h2 id="多样化查询-Lucene’s-diverse-queries"><a href="#多样化查询-Lucene’s-diverse-queries" class="headerlink" title="多样化查询(Lucene’s diverse queries)"></a>多样化查询(Lucene’s diverse queries)</h2><h2 id="QueryParser"><a href="#QueryParser" class="headerlink" title="QueryParser"></a>QueryParser</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/61/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/61/">61</a><span class="page-number current">62</span><a class="page-number" href="/page/63/">63</a><span class="space">&hellip;</span><a class="page-number" href="/page/66/">66</a><a class="extend next" rel="next" href="/page/63/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/plusaber.jpg"
               alt="Plusaber" />
          <p class="site-author-name" itemprop="name">Plusaber</p>
          <p class="site-description motion-element" itemprop="description">Plusaber's Blog</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">327</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://leetcode.com/problemset/algorithms/" title="Leetcode" target="_blank">Leetcode</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.kaggle.com" title="Kaggle" target="_blank">Kaggle</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://jp.linkedin.com/in/zebangchen" title="LinkedIn" target="_blank">LinkedIn</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://portal.qiniu.com" title="Qiniu" target="_blank">Qiniu</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Plusaber</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'plusaber';
      var disqus_identifier = 'page/62/index.html';
      var disqus_title = "";
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  

  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  

  

  


</body>
</html>
