<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










  <meta name="google-site-verification" content="google88d81a02a91db82f">















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=7.1.1">


  <link rel="mask-icon" href="/favicon.ico?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: 'LP2H1MWXO2',
      apiKey: '69bf93a909694ef7f679098292b442ca',
      indexName: 'Plusaber',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Plusaber&apos;s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Plusaber&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/13/index.html">
<meta property="og:site_name" content="Plusaber&#39;s Blog">
<meta property="og:description" content="Plusaber&apos;s Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Plusaber&#39;s Blog">
<meta name="twitter:description" content="Plusaber&apos;s Blog">





  
  
  <link rel="canonical" href="http://yoursite.com/page/13/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Plusaber's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Plusaber's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/05/Java_Maven(1)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Plusaber">
      <meta itemprop="description" content="Plusaber's Blog">
      <meta itemprop="image" content="/images/plusaber.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Plusaber's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/11/05/Java_Maven(1)/" class="post-title-link" itemprop="url">Maven(1)_Maven基础</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-11-05 00:00:00" itemprop="dateCreated datePublished" datetime="2014-11-05T00:00:00+09:00">2014-11-05</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2014/11/05/Java_Maven(1)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/11/05/Java_Maven(1)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>参考<a href="http://ifeve.com/maven-1/" target="_blank" rel="noopener">Maven入门指南</a>，<a href="http://maven.apache.org/guides/getting-started/index.html" target="_blank" rel="noopener">Maven Getting Started Guide</a>，<a href="http://tutorials.jenkov.com/maven/maven-tutorial.html#maven-settings-files" target="_blank" rel="noopener">Maven Tutorial</a></p>
<p>Maven主要为开发者提供了一个可复用、可维护的工程模型，以及与基于这个模型的构建工具和一系列插件。</p>
<p>构建工具是将软件项目构建相关的过程自动化的工具。构建一个软件项目通常包含以下一个或多个过程：</p>
<ul>
<li>生成源码（如果项目使用自动生成源码）；</li>
<li>从源码生成项目文档；</li>
<li>编译源码；</li>
<li>将编译后的代码打包成JAR文件或者ZIP文件；</li>
<li>将打包好的代码安装到服务器、仓库或者其它的地方；</li>
</ul>
<p>有些项目可能需要更多的过程才能完成构建，这些过程一般也可以整合到构建工具中，因此它们也可以实现自动化。</p>
<p>自动化构建过程的好处是将手动构建过程中犯错的风险降到最低。而且，自动构建工具通常要比手动执行同样的构建过程要快。</p>
<h2 id="核心概念"><a class="markdownIt-Anchor" href="#核心概念"></a> 核心概念</h2>
<h3 id="pomxml"><a class="markdownIt-Anchor" href="#pomxml"></a> pom.xml</h3>
<p>Maven工程结构和内容被定义在一个xml文件中 - pom.xml，也就是project object model，此文件是整个Maven系统的基础组件，描述了项目的资源，源码，测试代码，依赖等。pom.xml位于项目的根目录下。</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Java_Maven_1.png" alt></p>
<p>在执行一条maven命令时，maven会读取项目的pom.xml文件，并根据pom.xml的相关内容执行命令。</p>
<h3 id="构建生命周期-阶段和目标"><a class="markdownIt-Anchor" href="#构建生命周期-阶段和目标"></a> 构建生命周期、阶段和目标</h3>
<p>Maven的构建过程从大到小被分为构建生命周期、阶段和目标，其关系为：</p>
<ul>
<li><strong>一个生命周期</strong>包含若干个<strong>阶段</strong></li>
<li><strong>一个阶段</strong>包含若干个<strong>目标</strong></li>
</ul>
<p>一般maven使用的命令形式为：<code>mvn command</code>，其中command命令就是构建生命周期、阶段或者目标的名字。如果command为一个生命周期，该生命周期的所有构建阶段都会被执行。如果command为一个生命周期具体的一个构建阶段，那么这个生命周期中，所有处于目标执行阶段之前的阶段以及该目标阶段都会被执行。</p>
<p>目标操作（goal）表示某个有助于项目构建和管理的特定的任务。</p>
<ul>
<li><strong>一个目标操作可以绑定0到多个构建阶段。</strong></li>
<li><strong>不绑定任何构建阶段的目标操作可以通过直接调用的方式执行。</strong></li>
</ul>
<p>执行的顺序取决于目标操作和构建阶段调用的次序。以下面的命令为例，参数clean和package是构建阶段而dependency:copy-dependencies是一个目标操作。</p>
<p><code>mvn clean dependency:copy-dependencies package</code></p>
<p>在这里，clean阶段会首先执行，然后是执行dependency:copy-dependencies目标操作，最后是执行package阶段。</p>
<h3 id="依赖和仓库"><a class="markdownIt-Anchor" href="#依赖和仓库"></a> 依赖和仓库</h3>
<p>一个大型项目一般都会需要依赖许多外部包，也就是这个项目的依赖。Maven设置了一个本地仓库，所有依赖都会被放在本地仓库（本地的一个目录）中。如果在本地仓库中不存在该依赖，则Maven会从中央仓库下载并放到本地仓库。</p>
<h3 id="插件"><a class="markdownIt-Anchor" href="#插件"></a> 插件</h3>
<p>Maven提供了一系列标准的构建生命周期和构建阶段、目标，如果仍无法满足项目构建的要求，可以使用查找并使用插件来满足需要。</p>
<p>Maven实际上是一个执行插件的框架，其所有的任务其实都是由插件完成。Maven插件通常用于：</p>
<ul>
<li>生成jar包文件</li>
<li>生成war包文件</li>
<li>编译源码文件</li>
<li>代码单元测试</li>
<li>生成项目文档</li>
<li>生成项目报告</li>
</ul>
<p><strong>一个插件通常提供一系列的目标操作，并且目标操作可以通过以下格式的命令执行</strong>：<br>
<code>mvn [插件名]:[目标操作名]</code><br>
例如，一个Java项目可以通过运行下面的命令使用maven-compiler-plugin的compile目标操作编译。<br>
<code>mvn compiler:compile</code></p>
<p><strong>另外插件目标也可以与绑定到构建阶段上（可以是现有的构建阶段）。这样在执行该构建阶段时，所绑定的目标也会一起被执行。</strong></p>
<p>例如在执行构建阶段时如果需要输出信息，可以使用maven-antrun-plugin插件来打印数据到控制台。</p>
<p>创建下面的pom.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="tag"><span class="string">    http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.companyname.projectgroup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>project<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-antrun-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">id</span>&gt;</span>id.clean<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">phase</span>&gt;</span>clean<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>run<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tasks</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">echo</span>&gt;</span>clean phase<span class="tag">&lt;/<span class="name">echo</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tasks</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">execution</span>&gt;</span>     </span><br><span class="line">   <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>执行<code>mvn clean</code>.</p>
<p>Maven将会开始处理并且输出clean生命周期的clean阶段的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO] ------------------------------------------------------------------</span><br><span class="line">[INFO] Building Unnamed - com.companyname.projectgroup:project:jar:1.0</span><br><span class="line">[INFO]    task-segment: [post-clean]</span><br><span class="line">[INFO] ------------------------------------------------------------------</span><br><span class="line">[INFO] [clean:clean &#123;execution: default-clean&#125;]</span><br><span class="line">[INFO] [antrun:run &#123;execution: id.clean&#125;]</span><br><span class="line">[INFO] Executing tasks</span><br><span class="line">     [echo] clean phase</span><br><span class="line">[INFO] Executed tasks</span><br><span class="line">[INFO] ------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESSFUL</span><br><span class="line">[INFO] ------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: &lt; 1 second</span><br><span class="line">[INFO] Finished at: Sat Jul 07 13:38:59 IST 2012</span><br><span class="line">[INFO] Final Memory: 4M/44M</span><br><span class="line">[INFO] ------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>上面的例子中阐明了下面几个关键概念：</p>
<ul>
<li>插件在pom.xml文件中是通过plugins节点明确指定的。</li>
<li><strong>每个插件可以有多个目标操作。</strong></li>
<li>你可以使用phase节点来定义插件从哪个节点开始处理。我们已使用的是clean阶段。</li>
<li>你可以通过绑定任务到插件的目标操作来配置要执行的任务。我们已经绑定了echo任务到maven-antrun-plugin插件的run目标操作。</li>
<li>以上，Maven会处理剩下的事情。若本地仓库中找不到，Maven会下载插件，并且开始处理。</li>
</ul>
<p>Maven提供了下面两类插件：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>构建插件（Build plugins）</td>
<td>这类插件在构建过程中执行，并且应该配置在pom.xml文件的&lt;build&gt;节点中。</td>
</tr>
<tr>
<td>报告插件（Reporting plugins）</td>
<td>这类插件在生成站点过程中执行，并且应该配置在pom.xml文件的<reporting>节点中。</reporting></td>
</tr>
</tbody>
</table>
<p>下面是一些常用的插件的列表：</p>
<table>
<thead>
<tr>
<th>插件</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>clean</td>
<td>构建完成后清理目标，删除目标目录。</td>
</tr>
<tr>
<td>compiler</td>
<td>编译Java源文件。</td>
</tr>
<tr>
<td>surefile</td>
<td>运行JUnit单元测试，生成测试报告。</td>
</tr>
<tr>
<td>jar</td>
<td>从当前项目生成JAR文件。</td>
</tr>
<tr>
<td>war</td>
<td>从当前项目生成WAR文件。</td>
</tr>
<tr>
<td>javadoc</td>
<td>生成项目的Javadoc。</td>
</tr>
<tr>
<td>antrun</td>
<td>运行任意指定构建阶段的一系列ant任务。</td>
</tr>
</tbody>
</table>
<h3 id="配置文件"><a class="markdownIt-Anchor" href="#配置文件"></a> 配置文件</h3>
<p>配置文件用于以不同的方式构建项目。比如可能需要在本地环境构建，用于开发和测试，也可能需要构建后用于开发环境。具体可以配置的一些内容包括：</p>
<ul>
<li>本地仓库的路径</li>
<li>当前编译配置选项等</li>
</ul>
<p>maven设置了两个配置文件，分别在：</p>
<ul>
<li>maven安装目录下： <code>$M2_HOME/conf/settings.xml</code></li>
<li>用户主目录中： <code>${user.home}/.m2/settings.xml</code></li>
</ul>
<p>如果两个文件都存在，则用户目录的配置会覆盖安装目下的配置。</p>
<p>在POM文件中增加不同的构建配置，可以启用不同的构建过程。当运行Maven时，可以指定要使用的配置。</p>
<h2 id="pom"><a class="markdownIt-Anchor" href="#pom"></a> POM</h2>
<p>POM意为项目对象模型(Project Object Model)，是Maven中基本单元。它是一个名为pom.xml的XML文件，总是存在于项目的更目录下。</p>
<p>POM包含了项目相关的信息和Maven用来构建一个或多个项目的各种配置详情。POM文件描述的是构建“什么”，而不是“如何”构建。如何构建是取决于Maven的构建阶段和目标。当然，如果需要，你也可以向Maven构建阶段中添加自定义的目标。</p>
<p>每一个项目都有一个POM文件。POM文件即pom.xml，应该放在项目的根目录下。一个项目如果分为多个子项目，一般来讲，父项目有一个POM文件，每一个子项目都有一个POM文件。在这种结构下，既可以一步构建整个项目，也可以各个子项目分开构建。</p>
<p>POM也包含了各种目标操作(goal)和插件。当执行一个任务或者目标操作时，Maven会查找当前目录下的POM。Maven读取POM，从中获得需要的配置信息，然后执行目标操作。部分Maven可以从POM中明确的配置列出如下：</p>
<ul>
<li>项目依赖（project dependencies）</li>
<li>插件（plugins）</li>
<li>目标操作（goals）</li>
<li>构建（build profiles）</li>
<li>项目版本（project version）</li>
<li>开发者（developers）</li>
<li>邮件列表（mailing list）</li>
</ul>
<p>一个最基本的POM文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="tag"><span class="string">                      http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mycompany.app<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>groupID</code>表示开发者或者开发公司的唯一ID，一般使用java包的根名作为groupID。<code>artifactId</code>一般是项目名。<code>version</code>指项目版本。</p>
<p>注意，项目在maven仓库的结构化目中，该结构化目录会与groupID匹配，每一个<code>.</code>会成为目录分隔符，每个词都表示一个目录。如groupID为<code>com.plusaber</code>项目将位于<code>MAVEN_REPO/com/plusaber</code>。类似的，<code>artifactId</code>也会成为<code>MAVEN_REPO/com/plusaber</code>的子目录，另外<code>artifactId</code>也是构建完项目后生成的jar包的文件名的一部分。</p>
<ul>
<li><strong>父po</strong>m</li>
</ul>
<p>所有的Maven pom文件都继承自一个父pom。如果没有指定父pom，则该pom文件继承自根pom。</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Java_Maven_2.png" alt></p>
<p>可以在pom文件指定父pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">”http://maven.apache.org/POM/4.0.0″</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">”http://www.w3.org/2001/XMLSchema-instance”</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">”http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="tag"><span class="attr">http:</span>//<span class="attr">maven.apache.org</span>/<span class="attr">xsd</span>/<span class="attr">maven-4.0.0.xsd</span>”&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../my-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-project<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>子pom的配置会覆盖父pom的配置，由于继承和覆盖的原因，无法直接通过查看子pom和父pom了解最后的有效pom。这时可以使用<code>mvn help:effective-pom</code>打印出当前的有效pom文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ================================================================= --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                                                                   --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Generated by Maven Help Plugin on 2012-07-05T11:41:51             --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- See: http://maven.apache.org/plugins/maven-help-plugin/           --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                                                                   --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ================================================================= --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ================================================================= --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                                                                   --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Effective POM for project                                         --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 'com.companyname.project-group:project-name:jar:1.0'              --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                                                                   --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ================================================================= --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/</span></span></span><br><span class="line"><span class="tag"><span class="string">2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 h</span></span></span><br><span class="line"><span class="tag"><span class="string">ttp://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.companyname.project-group<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>project<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>C:\MVN\project\src\main\java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scriptSourceDirectory</span>&gt;</span>src/main/scripts<span class="tag">&lt;/<span class="name">scriptSourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>C:\MVN\project\src\test\java<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>C:\MVN\project\target\classes<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testOutputDirectory</span>&gt;</span>C:\MVN\project\target\test-classes<span class="tag">&lt;/<span class="name">testOutputDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mergeId</span>&gt;</span>resource-0<span class="tag">&lt;/<span class="name">mergeId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>C:\MVN\project\src\main\resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testResources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">testResource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mergeId</span>&gt;</span>resource-1<span class="tag">&lt;/<span class="name">mergeId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>C:\MVN\project\src\test\resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">testResource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">testResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>C:\MVN\project\target<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>project-1.0<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-antrun-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2-beta-2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-clean-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-ear-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-ejb-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-install-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-plugin-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-rar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-release-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0-beta-8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-site-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0-beta-7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1-alpha-2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-help-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Maven Repository Switchboard<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.maven.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>never<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Maven Plugin Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.maven.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">reporting</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>C:\MVN\project\target/site<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">reporting</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在上面的完整的effective pom.xml中，你可以看到项目构建的所有信息，包括默认的源文件目录结构，输出路径，需要的插件，报告目录，这些信息Maven在执行期望的目标操作时都会用到。</p>
<p><strong>Maven的pom.xml在大部分情况要求手动写。Maven提供了很多archetype插件用来创建项目以及按规则创建项目结构和pom.xml文件。</strong></p>
<h2 id="maven命令"><a class="markdownIt-Anchor" href="#maven命令"></a> Maven命令</h2>
<p><code>mvn command</code>，其中command命令就是构建生命周期、阶段或者目标的名字。如果command为一个生命周期，该生命周期的所有构建阶段都会被执行。如果command为一个生命周期具体的一个构建阶段，那么这个生命周期中，所有处于目标执行阶段之前的阶段以及该目标阶段都会被执行。<br>
<code>mvn install</code><br>
<code>install</code>是默认生命周期的一个阶段，具体任务包括编译项目，将打包的jar文件复制到本地仓库。事实上，在执行install之前，默认生命周期位于install的所有阶段都被执行。</p>
<p>我们可以向mvn命令传入多个参数，执行多个构建周期或阶段，如：<br>
<code>mvn clean install</code><br>
clean是一个生命周期（简称周期），具体任务是删除maven输入目录中已编译的类文件，然后执行install构建阶段。一个一个顺序执行，互相没有影响。</p>
<p>也可以执行一个maven目标，这时参数需要将构建阶段与目标名以冒号相连。<br>
<code>mvn dependency:copy-dependencies</code>，执行<code>dependency</code>构建阶段中的<code>copy-dependencies</code>目标。</p>
<h2 id="maven目录结构"><a class="markdownIt-Anchor" href="#maven目录结构"></a> Maven目录结构</h2>
<p>maven的一个主要原则就是约定优先，maven设置了一个<a href="http://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html" target="_blank" rel="noopener">标准的目录结构</a>，如果在项目中遵循Maven的目录结构，就无需在pom文件中指定源码测试代码等目录。</p>
<table>
<thead>
<tr>
<th>dir/file</th>
<th>usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>src/main/java	Application/Library</td>
<td>sources</td>
</tr>
<tr>
<td>src/main/resources</td>
<td>Application/Library resources</td>
</tr>
<tr>
<td>src/main/filters</td>
<td>Resource filter files</td>
</tr>
<tr>
<td>src/main/webapp</td>
<td>Web application sources</td>
</tr>
<tr>
<td>src/test/java	Test</td>
<td>sources</td>
</tr>
<tr>
<td>src/test/resources</td>
<td>Test resources</td>
</tr>
<tr>
<td>src/test/filters	Test</td>
<td>resource filter files</td>
</tr>
<tr>
<td>src/it</td>
<td>Integration Tests (primarily for plugins)</td>
</tr>
<tr>
<td>src/assembly</td>
<td>Assembly descriptors</td>
</tr>
<tr>
<td>src/site</td>
<td>Site</td>
</tr>
<tr>
<td>LICENSE.txt</td>
<td>Project’s license</td>
</tr>
<tr>
<td>NOTICE.txt</td>
<td>Notices and attributions required by libraries that the project depends on</td>
</tr>
<tr>
<td>README.txt</td>
<td>Project’s readme</td>
</tr>
</tbody>
</table>
<h2 id="依赖"><a class="markdownIt-Anchor" href="#依赖"></a> 依赖</h2>
<h3 id="项目依赖"><a class="markdownIt-Anchor" href="#项目依赖"></a> 项目依赖</h3>
<p>Maven提供了依赖管理的功能。你只需要在pom文件里指定依赖jar包的名称、版本号，Maven会自动下载并放到你的Maven本地仓库中。如果这些外部jar包依赖了其它的库，它们也会被下载到你的Maven本地仓库。</p>
<p>可以通过在pom文件添加dependencies属性中指定项目依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="tag"><span class="string">                      http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mycompany.app<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jsoup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsoup<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAVEN_REPOSITORY_ROOT/junit/junit/4.11</span><br><span class="line">MAVEN_REPOSITORY_ROOT/org/jsoup/jsoup/1.7.1</span><br></pre></td></tr></table></figure>
<p>可以看到，每一个依赖也是由groupID，artifactId和version来描述，和pom文件开头用来标识项目的方式是一样的。</p>
<p>执行这个pom文件时，如果本地仓库已经有了这两个依赖，maven就不会去中央仓库下载（本地仓库的依赖可以被多个项目使用）。如果没有，maven则会去中央仓库寻找这些依赖并下载到本地仓库。</p>
<p>需要注意的是，有时候指定的依赖在maven的中央仓库里没有，这是我们需要手动下载这些依赖并放到mavne的本地仓库。这些依赖必须放到与groupId, artifactId和version匹配的字目录中，用<code>/</code>替换<code>.</code>并为每个字段创建相应目录。</p>
<h3 id="外部依赖"><a class="markdownIt-Anchor" href="#外部依赖"></a> 外部依赖</h3>
<p>Maven的外部依赖指的是不在Maven的仓库（包括本地仓库、中央仓库和远程仓库）中的依赖（jar包）。它可能位于你本地硬盘的某个地方，比如web应用的lib目录下。</p>
<p>可以配置外部依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mydependency<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mydependency<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;basedir&#125;\war\WEB-INF\lib\mydependency.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>groupId和artifactId为依赖的名称，即API的名称。scope属性为system。systemPath属性为jar文件的路径。${basedir}为pom文件所在的目录，路径中的其它部分是相对于该目录而言的。</p>
<h3 id="快照依赖"><a class="markdownIt-Anchor" href="#快照依赖"></a> 快照依赖</h3>
<p>快照依赖指的是那些还在开发中的依赖（jar包）。与其经常地更新版本号来获取最新版本，不如你直接依赖项目的快照版本。快照版本的每一个build版本都会被下载到本地仓库，即使该快照版本已经在本地仓库了。总是下载快照依赖可以确保本地仓库中的每一个build版本都是最新的。</p>
<p>在pom文件的最开头（设置groupId和artifactId的地方），在版本号后追加-SNAPSHOT，则告诉Maven你的项目是一个快照版本。如：</p>
<p><code>&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</code></p>
<p>在配置依赖时，在版本号后追加-SNAPSHOT表明依赖的是一个快照版本。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.jenkov&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;java-web-crawler&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>追加在version后的-SNAPSHOT告诉Maven这是一个快照版本。</p>
<h2 id="maven仓库"><a class="markdownIt-Anchor" href="#maven仓库"></a> Maven仓库</h2>
<p>Maven仓库就是存储jar包和一些元数据信息的目录，一般是用于根目录下的<code>.m2</code>文件夹，比如<code>/Users/admin/.m2</code>。其中的元数据即pom文件，描述了该jar包属于哪个项目，以及jar包所需的外部依赖。该元数据信息使得Maven可以递归地下载所有的依赖，直到整个依赖树都下载完毕并放到你的本地仓库中。参考<a href="http://maven.apache.org/guides/introduction/introduction-to-repositories.html" target="_blank" rel="noopener">Introduction to Repositories</a>。</p>
<p>Maven有三种类型的仓库：</p>
<ul>
<li>本地仓库</li>
<li>中央仓库</li>
<li>远程仓库</li>
</ul>
<p>Maven根据以上的顺序去仓库中搜索依赖。首先是本地仓库，然后是中央仓库，最后，如果pom文件中配置了远程仓库，则会去远程仓库中查找。</p>
<h4 id="本地仓库"><a class="markdownIt-Anchor" href="#本地仓库"></a> 本地仓库</h4>
<p>本地仓库就是开发者电脑上的一个目录。该仓库包含了Maven下载的所有依赖。一般来讲，一个本地仓库为多个不同的项目服务。因此，Maven只需下载一次，即使有多个项目都依赖它（如junit）。</p>
<p>通过mvn install命令可以将你自己的项目构建并安装到本地仓库中。这样，你的其它项目就可以通过在pom文件将该jar包作为外部依赖来使用。</p>
<p>Maven的本地仓库默认在你本机的用户目录下。不过，你可以在Maven的配置文件中修改本地仓库的路径。Maven的配置文件也在用户目录下(user-home/.m2)，文件名为settings.xml。以下示例为本地仓库指定其它的路径：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">localRepository</span>&gt;</span></span><br><span class="line">        d:\data\java\products\maven\repository</span><br><span class="line">    <span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="中央仓库"><a class="markdownIt-Anchor" href="#中央仓库"></a> 中央仓库</h4>
<p>Maven的中央仓库由Maven社区提供。默认情况下，所有不在本地仓库中的依赖都会去这个中央仓库查找。然后Maven会将这些依赖下载到你的本地仓库。访问中央仓库不需要做额外的配置。</p>
<h4 id="远程仓库"><a class="markdownIt-Anchor" href="#远程仓库"></a> 远程仓库</h4>
<p>远程仓库是位于web服务器上的一个仓库，Maven可以从该仓库下载依赖，就像从中央仓库下载依赖一样。远程仓库可以位于Internet上的任何地方，也可以是位于本地网络中。</p>
<p>远程仓库一般用于放置组织内部的项目，该项目由多个项目共享。比如，由多个内部项目共用的安全项目。该安全项目不能被外部访问，因此不能放在公开的中央仓库下，而应该放到内部的远程仓库中。</p>
<p>远程仓库中的依赖也会被Maven下载到本地仓库中。可以在pom文件里配置远程仓库。将以下的xml片段放到属性之后：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">id</span>&gt;</span>jenkov.code<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.jenkov.com/maven2/lib<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="maven的构建生命周期-阶段和目标"><a class="markdownIt-Anchor" href="#maven的构建生命周期-阶段和目标"></a> Maven的构建生命周期、阶段和目标</h2>
<p>当使用Maven构建项目时，会遵循一个构建生命周期。该生命周期分为多个构建阶段，而构建阶段又分为多个构建目标。参考<a href="http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html" target="_blank" rel="noopener">Introduction to the Build Lifecycle</a></p>
<h3 id="构建生命周期"><a class="markdownIt-Anchor" href="#构建生命周期"></a> 构建生命周期</h3>
<p>Maven有三个内嵌的构建生命周期：<code>clean</code>, <code>default</code>, <code>site</code>.</p>
<p>每一个构建生命期关注项目构建的不同方面。因此，它们是独立地执行的。Maven可以执行多个生命期，但是它们是串行执行的，相互独立，就像你执行了多条独立的Maven命令。</p>
<h4 id="clean生命周期"><a class="markdownIt-Anchor" href="#clean生命周期"></a> Clean生命周期</h4>
<p>当我们执行mvn的post-clean命令时，Maven调用clean生命周期，它包含以下阶段：</p>
<ul>
<li>pre-clean</li>
<li>clean</li>
<li>post-clean</li>
</ul>
<p>Maven的clean目标操作（clean:clean）在clean生命周期中被绑定到clean阶段。clean:clean 目标操作通过删除构建目录来删除一个项目构建的输出文件。这样，当mvn clean命令执行时，Maven会删除构建目录。</p>
<h4 id="default生命周期"><a class="markdownIt-Anchor" href="#default生命周期"></a> default生命周期</h4>
<p>构建生命周期是Maven的最主要的生命周期，用来构建应用。default生命期关注的是项目的编译和打包。clean生命期关注的是从输出目录中删掉临时文件，包括自动生成的源文件、编译后的类文件，之前版本的jar文件等。site生命期关注的是为项目生成文档。实际上，site可以使用文档为项目生成一个完整的网站。</p>
<h3 id="构建阶段"><a class="markdownIt-Anchor" href="#构建阶段"></a> 构建阶段</h3>
<p>每一个构建生命期被分为一系列的构建阶段，构建阶段又被分为构建目标。因此，整个构建过程由一系列的构建生命期、构建阶段和构建目标组成。</p>
<p>你可以执行一个构建生命期，如clean或site，一个构建阶段，如default生命期的install，或者一个构建目标，如dependency:copy-dependencies。注意：你不能直接执行default生命期，你需要指定default生命期中的一个构建阶段或者构建目标。</p>
<p>当你执行一个构建阶段时，所有在该构建阶段之前的构建阶段（根据标准构建顺序）都会被执行。因此，执行install阶段，意味着所有位于install阶段前的构建阶段都会被执行，然后才执行install阶段。</p>
<p>default生命期更多的关注于构建代码。由于你不能直接执行default生命期，你需要执行其中一个构建阶段或者构建目标。default生命期包含了相当多的构建阶段和目标，这里不会所有都介绍。最常用的构建阶段有：</p>
<ul>
<li><code>validate</code> - validate the project is correct and all necessary information is available</li>
<li><code>compile</code> - compile the source code of the project</li>
<li><code>test</code> - test the compiled source code using a suitable unit * testing framework. These tests should not require the code be packaged or deployed</li>
<li><code>package</code> - take the compiled code and package it in its distributable format, such as a JAR.</li>
<li><code>integration-test</code> - process and deploy the package if necessary into an environment where integration tests can be run</li>
<li><code>verify</code> - run any checks to verify the package is valid and meets quality criteria</li>
<li><code>install</code> - install the package into the local repository, for use as a dependency in other projects locally</li>
<li><code>deploy</code> - done in an integration or release environment, copies the final package to the remote repository for sharing with other developers and projects.</li>
</ul>
<p>完整的default周期的阶段：</p>
<table>
<thead>
<tr>
<th>生命周期阶段</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>validate（校验）</td>
<td>校验项目是否正确并且所有必要的信息可以完成项目的构建过程。</td>
</tr>
<tr>
<td>initialize（初始化）</td>
<td>初始化构建状态，比如设置属性值。</td>
</tr>
<tr>
<td>generate-sources（生成源代码）</td>
<td>生成包含在编译阶段中的任何源代码。</td>
</tr>
<tr>
<td>process-sources（处理源代码）</td>
<td>处理源代码，比如说，过滤任意值。</td>
</tr>
<tr>
<td>generate-resources（生成资源文件）</td>
<td>生成将会包含在项目包中的资源文件。</td>
</tr>
<tr>
<td>process-resources （处理资源文件）</td>
<td>复制和处理资源到目标目录，为打包阶段最好准备。</td>
</tr>
<tr>
<td>compile（编译）</td>
<td>编译项目的源代码。</td>
</tr>
<tr>
<td>process-classes（处理类文件）</td>
<td>处理编译生成的文件，比如说对Java class文件做字节码改善优化。</td>
</tr>
<tr>
<td>generate-test-sources（生成测试源代码）</td>
<td>生成包含在编译阶段中的任何测试源代码。</td>
</tr>
<tr>
<td>process-test-sources（处理测试源代码）</td>
<td>处理测试源代码，比如说，过滤任意值。</td>
</tr>
<tr>
<td>test-compile（编译测试源码）</td>
<td>编译测试源代码到测试目标目录.</td>
</tr>
<tr>
<td>process-test-classes（处理测试类文件）</td>
<td>处理测试源码编译生成的文件。</td>
</tr>
<tr>
<td>test（测试）</td>
<td>使用合适的单元测试框架运行测试（Juint是其中之一）。</td>
</tr>
<tr>
<td>prepare-package（准备打包）</td>
<td>在实际打包之前，执行任何的必要的操作为打包做准备。</td>
</tr>
<tr>
<td>package（打包）</td>
<td>将编译后的代码打包成可分发格式的文件，比如JAR、WAR或者EAR文件。</td>
</tr>
<tr>
<td>pre-integration-test（集成测试前）</td>
<td>在执行集成测试前进行必要的动作。比如说，搭建需要的环境。</td>
</tr>
<tr>
<td>integration-test（集成测试）</td>
<td>处理和部署项目到可以运行集成测试环境中。</td>
</tr>
<tr>
<td>post-integration-test（集成测试后）</td>
<td>在执行集成测试完成后进行必要的动作。比如说，清理集成测试环境。</td>
</tr>
<tr>
<td>verify （验证）</td>
<td>运行任意的检查来验证项目包有效且达到质量标准。</td>
</tr>
<tr>
<td>install（安装）</td>
<td>安装项目包到本地仓库，这样项目包可以用作其他本地项目的依赖。</td>
</tr>
<tr>
<td>deploy（部署）</td>
<td>将最终的项目包复制到远程仓库中与其他开发者和项目共享。</td>
</tr>
</tbody>
</table>
<h3 id="构建目标"><a class="markdownIt-Anchor" href="#构建目标"></a> 构建目标</h3>
<p>构建目标是Maven构建过程中最细化的步骤。一个目标可以与一个或多个构建阶段绑定，也可以不绑定。如果一个目标没有与任何构建阶段绑定，你只能将该目标的名称作为参数传递给mvn命令来执行它。如果一个目标绑定到多个构建阶段，该目标在绑定的构建阶段执行的同时被执行。</p>
<h3 id="maven构建配置"><a class="markdownIt-Anchor" href="#maven构建配置"></a> Maven构建配置</h3>
<p>Maven构建配置使你能使用不同的配置来构建项目。不用创建两个独立的pom文件。你只需使用不同的构建配置指定不同的配置文件，然后使用该配置文件构建项目即可。</p>
<p>关于构建配置的详细信息可以参考Maven POM参考的<a href="http://maven.apache.org/pom.html#Profiles" target="_blank" rel="noopener">Profile</a>部分。这里是一个快速的介绍。</p>
<p>Maven的构建配置在pom文件的profiles属性中指定，例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jenkov.crawler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-web-crawler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>test<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">activation</span>&gt;</span>...<span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">build</span>&gt;</span>...<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">modules</span>&gt;</span>...<span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">repositories</span>&gt;</span>...<span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span>...<span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>...<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">reporting</span>&gt;</span>...<span class="tag">&lt;/<span class="name">reporting</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>...<span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span>...<span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>构建配置描述的是当使用该配置构建项目时，对pom文件所做的修改，比如修改应用使用的配置文件等。profile属性中的值将会覆盖其上层的、位于pom文件中的配置。</p>
<p>在profile属性中，有一个activation子属性。该属性指定了启用该构建配置的条件。选择构建配置的一种方式是在settings.xml文件中指定；另一种方式是在Maven命令行使用<code>-P profile-name</code>指定。更多细节参考构建配置的文档。</p>
<h3 id="maven插件"><a class="markdownIt-Anchor" href="#maven插件"></a> Maven插件</h3>
<p>使用Maven插件，可以向构建过程添加自定义的动作。创建一个简单的Java类，该类继承一个特殊的Maven类，然后为项目创建一个pom文件。该插件应该位于其项目下。可以参考<a href="http://maven.apache.org/plugin-developers/index.html" target="_blank" rel="noopener">Plugin Developers Centre</a>。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/11/02/Design Pattern_Observer pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Plusaber">
      <meta itemprop="description" content="Plusaber's Blog">
      <meta itemprop="image" content="/images/plusaber.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Plusaber's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/11/02/Design Pattern_Observer pattern/" class="post-title-link" itemprop="url">Observer pattern</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-11-02 00:00:00" itemprop="dateCreated datePublished" datetime="2014-11-02T00:00:00+09:00">2014-11-02</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2014/11/02/Design Pattern_Observer pattern/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/11/02/Design Pattern_Observer pattern/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>观察者模式定义了对象之间的一对多依赖，观察者依赖于此主体，只要主体状态有变化，观察者就会被通知。</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Design_pattern_observer_1.png" alt="Design_pattern_observer_1"></p>
<p>一种基于Subject和Observer接口的实现：</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Design_pattern_observer_2.png" alt="Design_pattern_observer_2"></p>
<p>观察者模式提供了一种对象设计，让主题和观察者之间实现松耦合。</p>
<p>气象站的观察者模式设计：</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Design_pattern_observer_3.png" alt="Design_pattern_observer_3"></p>
<p>实现代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerObserver</span><span class="params">(Observer o)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer o)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DisplayElement</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherData</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> ArrayList observers;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> temperature;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> humidity;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> pressure;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">WeatherData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		observers = <span class="keyword">new</span> ArrayList();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerObserver</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">		observers.add(o);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> i = observers.indexOf(o);</span><br><span class="line">		<span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			observers.remove(i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; observers.size(); i++) &#123;</span><br><span class="line">			Observer observer = (Observer)observers.get(i);</span><br><span class="line">			observer.update(temperature, humidity, pressure);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measurementsChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		notifyObservers();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMeasurements</span><span class="params">(<span class="keyword">float</span> temperature, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">		<span class="keyword">this</span>.humidity = humidity;</span><br><span class="line">		<span class="keyword">this</span>.pressure = pressure;</span><br><span class="line">		measurementsChanged();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// other WeatherData methods here</span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getTemperature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> temperature;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getHumidity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> humidity;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPressure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pressure;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，观察者模式也有缺点，观察者无法主动获取所需要的数据，而是由主题对象一次推送所有数据，在某些情况并不合适，后面介绍的模式将解决这个问题。</p>
<p>另外Java内置有观察者模式，但是是基于抽象类，而不是接口的实现，在很多时候并不适用。在JDK中，Swing的JButton等组件加入Listener即是使用了观察者模式，当按扭事件被触发时，所有listener将会得到通知并做出相应行为。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/10/10/Design Pattern_Strategy pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Plusaber">
      <meta itemprop="description" content="Plusaber's Blog">
      <meta itemprop="image" content="/images/plusaber.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Plusaber's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/10/10/Design Pattern_Strategy pattern/" class="post-title-link" itemprop="url">Strategy Pattern</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-10-10 00:00:00" itemprop="dateCreated datePublished" datetime="2014-10-10T00:00:00+09:00">2014-10-10</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2014/10/10/Design Pattern_Strategy pattern/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/10/10/Design Pattern_Strategy pattern/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>假设我们要实现鸭子对象及其行为，假设鸭子行为有鸣叫，颜色，飞行等。</p>
<h1 id="several-method"><a class="markdownIt-Anchor" href="#several-method"></a> Several method</h1>
<h2 id="with-extending"><a class="markdownIt-Anchor" href="#with-extending"></a> With Extending</h2>
<p>很自然的做法是定义一个鸭子父类，然后定义特定鸭子的子类。</p>
<p>由于不同的鸭子有不同的鸣叫，颜色，飞行等行为，如果把这些行为都放在鸭子父类中，则会导致部分不具有这些行为的鸭子也变得具有这些行为，一种弥补方法是对于这些行为什么都不做，但是会导致代码僵化，如果需要改动则需要修改所有鸭子的代码。</p>
<h2 id="with-interface"><a class="markdownIt-Anchor" href="#with-interface"></a> With Interface</h2>
<ul>
<li>另一种实现方法是使用接口，把会飞，会叫这些行为各自独立抽象出接口，对于需要具有这些行为的鸭子，使这些鸭子实现相应的接口即可。看起来很不错，但是一个问题是，接口不具有实现代码，也就是无法达到代码的复用，如果某种功能需要更改，比如飞行行为。在这个问题下，如果许多鸭子其实是具有相同的飞行行为的，如果需要进行调整，则同样需要修改所有这些鸭子的飞行行为。</li>
</ul>
<h2 id="strategy-mode"><a class="markdownIt-Anchor" href="#strategy-mode"></a> Strategy mode</h2>
<p>这里问题的关键是：<strong>没有分离出变化部分和稳定部分</strong>。一个设计原则是：</p>
<p><strong>找出应用中可能需要变化之处，把它们独立出来，不要和哪些不需要变化的代码混在一起。</strong></p>
<ul>
<li>根据上面的分析，我们应该把变化的部分和不变的不变的部分区分开来。</li>
</ul>
<p>假设在这个问题下fly()和quack()行为是会随着鸭子的不同而改变的，但并不是每种鸭子的行为都是不同功能的，部分鸭子会共享某种飞行行为或quack行为。这里我们不使用接口来抽象这些行为，因为前面提到，部分鸭子会共享某种飞行行为或quack行为，使用抽象则会导致无法复用这些代码。这里我们分别建立一组抽象来代表每个行为（可以为接口）。</p>
<p>然后对于几种不同的行为，分别实现具体类继承定义的抽象behavior。然后在鸭子类引用这些类的实例，通过调用这些实例的实现方法来实现鸭子的相应行为。也就是具体行为的实现是在这些具体行为类中实现的，鸭子只是调用这些实现方法来实现相应行为。</p>
<p>上面解释的过于抽象，简单说来关键在于：<br>
<strong>鸭子现在将飞行和鸣叫的动作『委托』别人处理(独立的behavior接口)，而不是定义在鸭子类内部的飞行方法或鸣叫方法(仍然会有相关方法，但是其内容就是简单的引用behavior类的具体实现)。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">	FlyBehaviour flyb;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performFly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		flyb.fly();  <span class="comment">// 委托给行为类</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallarDuck</span> <span class="keyword">extends</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MalllardDuck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		flyb = <span class="keyword">new</span> HighFlyBehavior();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NanoDuck</span> <span class="keyword">extends</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MalllardDuck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		flyb = <span class="keyword">new</span> SpaceFlyBehavior();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外，在鸭子类中应用behavior类时，需要注意：<br>
<strong>针对接口编程，而不是针对具体实现编程。</strong></p>
<p>也就是我们在鸭子类中的依赖应该是抽象behavior类引用，而不是behavior的具体实现类，否则会造成鸭子类behavior限定于某个实现类，不利于后面的改变扩展。</p>
<ul>
<li>进一步增强，实现动态设定行为。</li>
</ul>
<p>前面我们通过在鸭子类内部引用behaviour类来完成具体行为，具体是在鸭子类构造函数内完成behaviour的实例化。由于具体行为是由behaviour类的实例完成，这也就是给我们提供了动态改变鸭子实例的行为，比如通过setFlyBehaviour(FlyBehavior fb)方法设定新的行为实现类，我们便可以在运行时改变鸭子的行为。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Duck</span> </span>&#123;</span><br><span class="line">	FlyBehaviour flyb;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performFly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		flyb.fly();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlyBehaviour</span><span class="params">(FlyBehavior fb)</span> </span>&#123;</span><br><span class="line">		flyb = fb;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="summary"><a class="markdownIt-Anchor" href="#summary"></a> Summary</h1>
<p>很多时候&quot;有一个&quot;可能比&quot;是一个&quot;更好，这也是一个重要的设计原则：<br>
<strong>多用组合，少用继承。</strong><br>
前面提到的还有：<br>
<strong>找出应用中可能需要变化之处，把它们独立出来，不要和哪些不需要变化的代码混在一起。</strong><br>
<strong>针对接口编程，而不是针对具体实现编程。</strong></p>
<p>使用组合建立系统具有很大的弹性，不仅可将算法族封装成类，更可以在运行时动态的改变行为，只要组合的行为对象符合正确的接口标准即可。</p>
<h1 id="strategy-pattern"><a class="markdownIt-Anchor" href="#strategy-pattern"></a> Strategy Pattern</h1>
<p>前面使用的模式就是策略模式。策略模式定义了算法族，并分别封装起来，让它们之间可以互相替换。此模式让算法的变化独立于使用算法的类。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/10/01/Developing_Lucene(4)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Plusaber">
      <meta itemprop="description" content="Plusaber's Blog">
      <meta itemprop="image" content="/images/plusaber.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Plusaber's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/10/01/Developing_Lucene(4)/" class="post-title-link" itemprop="url">Lucene(4)_Document analysis</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-10-01 00:00:00" itemprop="dateCreated datePublished" datetime="2014-10-01T00:00:00+09:00">2014-10-01</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Developing/" itemprop="url" rel="index"><span itemprop="name">Developing</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2014/10/01/Developing_Lucene(4)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/10/01/Developing_Lucene(4)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Analysis是指将field的内容转换为最基本的索引表示单元–项(Term)，也就是token+field名。分析器对分析操作进行了封装，提供一系列操作将文本转换为tokens，可能包括：提取单词、取出标点符号、转为小写、去除停用词、词干还原等。这个过程称为tokenizaiton，从文本提取token，与其域名(field)结合后，就形成了项(term)。</p>
<p>使用Lucene时，选择一个合适的分析器是非常关键的，决定于语言、行业等。Lucene提供了许多内置分析器可以满足一般需要，同时如果我们需要自定义分析器，Lucene的构建模块也可以使得这一过程变得简单。</p>
<h2 id="使用分析器analyzers"><a class="markdownIt-Anchor" href="#使用分析器analyzers"></a> 使用分析器(analyzers)</h2>
<p>分析操作将出现在任何需要将文本转换为Term的时候，对于Lucene核心来说，主要包括两个过程：建立索引期间和使用QueryParser对象进行搜索时。</p>
<p>下面是使用4个内置分析器分别分析两个短语，让我们先对分析操作有一个直观的认识。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Analyzing &quot;The quick brown fox jumped over the lazy dog&quot;</span><br><span class="line">          WhitespaceAnalyzer:</span><br><span class="line">            [The] [quick] [brown] [fox] [jumped] [over] [the] [lazy] [dog]</span><br><span class="line">          SimpleAnalyzer:</span><br><span class="line">            [the] [quick] [brown] [fox] [jumped] [over] [the] [lazy] [dog]</span><br><span class="line">          StopAnalyzer:</span><br><span class="line">            [quick] [brown] [fox] [jumped] [over] [lazy] [dog]</span><br><span class="line">          StandardAnalyzer:</span><br><span class="line">            [quick] [brown] [fox] [jumped] [over] [lazy] [dog]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Analyzing &quot;XY&amp;Z Corporation - xyz@example.com&quot;</span><br><span class="line">  WhitespaceAnalyzer:</span><br><span class="line">    [XY&amp;Z] [Corporation] [-] [xyz@example.com]</span><br><span class="line">  SimpleAnalyzer:</span><br><span class="line">    [xy] [z] [corporation] [xyz] [example] [com]</span><br><span class="line">  StopAnalyzer:</span><br><span class="line">    [xy] [z] [corporation] [xyz] [example] [com]</span><br><span class="line">  StandardAnalyzer:</span><br><span class="line">    [xy&amp;z] [corporation] [xyz@example.com]</span><br></pre></td></tr></table></figure>
<p>可以看出分析结果中的词汇单元取决于对应的分析器。</p>
<ul>
<li>WhitespaceAnalyzer，该分析器仅仅功过空格来分割文本信息，并不对生成的token进行其他处理。</li>
<li>SimpleAnalyzer，通过非字母字符来分割文本信息，然后统一为小写形式。</li>
<li>StopAnalyzer，在上面的基础上去除停用词。</li>
<li>StandardAnalyzer，这是Lucene最复杂的核心分析器，包含大量的逻辑操作来之别某些种类的token，比如公司名称，实体，e-mail等。同样会将token转换为小写形式并去除停用词和标点符号。</li>
</ul>
<h3 id="索引过程的analysis"><a class="markdownIt-Anchor" href="#索引过程的analysis"></a> 索引过程的analysis</h3>
<p>在索引期间，文档field的内容需要被转换为token，用于indexing。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Analyzer analyzer = <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30);</span><br><span class="line">        IndexWriter writer = <span class="keyword">new</span> IndexWriter(directory, analyzer,</span><br><span class="line">                                IndexWriter.MaxFieldLength.UNLIMITED);</span><br></pre></td></tr></table></figure>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Lucene_5.png" alt="Lucene_5"></p>
<p>通常需要实例化一个Analyzer对象，然后将其传递给IndexWriter对象。如果没有指定则会使用默认的分析器。另外如果某个文档需要特殊的分析器处理的话，在addDocument和updateDocument时也可以指定分析器。</p>
<p>为了确保文本信息被分析器处理，可以在创建field时指定Field.Index.ANALYZED或Field.Index.ANLYZED_NO_NORMS参数。如果需要将整个field内容作为一个token处理（也就是不需要tokenlization），可以设置为Field.Index.NOT_ANALYZED或Field.Index.NOT_NO_ANALYZED。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Field(String, String, Field.Store.YES, Field.Index.ANALYZED) </span><br><span class="line"><span class="comment">//creates a tokenized and stored field. Rest assured the original</span></span><br><span class="line"><span class="comment">//String value is stored. But the output of the designated </span></span><br><span class="line"><span class="comment">//Analyzer dictates what’s indexed and available for searching.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//The following code demonstrates indexing of a document where</span></span><br><span class="line"><span class="comment">//one field is analyzed and stored, and the second field is </span></span><br><span class="line"><span class="comment">//analyzed but not stored:</span></span><br><span class="line"></span><br><span class="line">Document doc = <span class="keyword">new</span> Document();</span><br><span class="line">        doc.add(<span class="keyword">new</span> Field(<span class="string">"title"</span>, <span class="string">"This is the title"</span>, </span><br><span class="line">        	Field.Store.YES, Field.Index.ANALYZED));</span><br></pre></td></tr></table></figure>
<h3 id="queryparser分析"><a class="markdownIt-Anchor" href="#queryparser分析"></a> QueryParser分析</h3>
<p>QueryParser同样需要使用analyzer将query分解为各个term。分析器会接受queyr expression的连续的独立文本片段，但不会接收整个表达式。如：<br>
<code>&quot;president obama&quot; +harvard +professor</code><br>
QueryParser会调用三次分析器，分别处理<code>&quot;president obama&quot;</code>，<code>harvard</code>，<code>professor</code>。</p>
<h2 id="whats-inside-an-analyzer"><a class="markdownIt-Anchor" href="#whats-inside-an-analyzer"></a> What’s inside an analyzer?</h2>
<p>Analyzer是一个抽象类，是所有分析器的基类。只需要实现一个抽象方法，将text转换为TokenStream实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span></span></span><br></pre></td></tr></table></figure>
<p>TokenStream用于循环遍历所有terms。</p>
<p>下面是简单的SimpleAnalyzer类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAnalyzer</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LowerCaseTokenizer(reader);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> TokenStream <span class="title">reusableTokenStream</span><span class="params">(String fieldName, Reader reader</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">throws</span> IOException &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">            Tokenizer tokenizer = (Tokenizer)</span> <span class="title">getPreviousTokenStream</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="keyword">if</span> (tokenizer == <span class="keyword">null</span>) &#123;</span><br><span class="line">              tokenizer = <span class="keyword">new</span> LowerCaseTokenizer(reader);</span><br><span class="line">              setPreviousTokenStream(tokenizer);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">              tokenizer.reset(reader);</span><br><span class="line">            <span class="keyword">return</span> tokenizer;</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>
<p>LowerCasetokenizer对象根据文本中的非字母字符来分割文本，并将所有字母换成小写形式。resusableTokenStream()方法是一个可选方法，分析器可以实现这个方法实现更好的效率，因为这个方法实现了重复利用前面线程创建的TokenStream。</p>
<h3 id="token"><a class="markdownIt-Anchor" href="#token"></a> Token</h3>
<p>token是分析过程中产生的基本单元。一个token带有其text值已经其他一些元数据，例如起始位置终止位置偏移量、类型等。文本被tokenlize之后，每个token的位置信息都是相对于前面一个token的位置的增量值进行保存，表示所有token都是连续的。</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Lucene_6.png" alt></p>
<p>在tokenlize之后，每个token连接field形成term被传递给索引。位置增量(position increment)、起点(start)和终点偏移量(end offset)和有效负载(payload)是token一起附带到索引的元数据。</p>
<p>位置增量使得当前token和前一个token在位置上关联起来。一般来说位置增量为1，表示每个token存在于field中唯一且连续的位置上。位置增量因子会直接影响短语查询(phrase queries)和跨度查询(span queries)，因为这些查询需要知道field中各个term之间的距离。</p>
<p>如果位置增量大于1，则允许token之间有空隙，可以用这个空隙来表示被删除的单词。<br>
位置增量为0的token表示该token放置与与前一个token相同的位置上。同义词分析器可以通过0增量来表示插入的同义词。</p>
<h3 id="分析tokenstream"><a class="markdownIt-Anchor" href="#分析tokenstream"></a> 分析TokenStream</h3>
<p>TokenStream是一个能在被调用后产生token序列的类，TokenStream类有两种不同类型：Tokenizer类和TokenFilter类。注意TokenFilter类可以封装另一个TokenStream抽象类对象。</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Lucene_7.png" alt></p>
<p>Tokenizer对象通过java.io.Reaser对象读取字符并创建token，而TokenFilter则负责处理输入的token，然后通过新增、删除或修改属性的方式来产生新的token。</p>
<p>当分析器从它的tokenStream方法或者reusableTokenStream方法返回tokenStream对象后，就可以用一个tokenizer对象创建tokens序列，然后再链接任意数量的tokenFilter对象来对这些tokens进行修改。这被称为分析器链（analyzer chain）。</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Lucene_8.png" alt></p>
<p>下面是Lucene的核心Tokenizer类和TokenFilter类。</p>
<table>
<thead>
<tr>
<th>Class name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>TokenStream</td>
<td>Abstract Tokenizer base class.</td>
</tr>
<tr>
<td>Tokenizer</td>
<td>TokenStream whose input is a Reader.</td>
</tr>
<tr>
<td>CharTokenizer</td>
<td>Parent class of character-based tokenizers, with abstract isTokenChar() method. Emits tokens for contiguous blocks when isTokenChar() returns true. Also provides the capability to normalize (for example, lowercase) characters. Tokens are limited to a maximum size of 255 characters.</td>
</tr>
<tr>
<td>WhitespaceTokenizer</td>
<td>CharTokenizer with isTokenChar() true for all nonwhitespace characters.</td>
</tr>
<tr>
<td>KeywordTokenizer</td>
<td>Tokenizes the entire input string as a single token.</td>
</tr>
<tr>
<td>LetterTokenizer</td>
<td>Tokenizes the entire input string as a single token. CharTokenizer with isTokenChar() true when Character.isLetter is true.</td>
</tr>
<tr>
<td>LowerCaseTokenizer</td>
<td>LetterTokenizer that normalizes all characters to lowercase.</td>
</tr>
<tr>
<td>SinkTokenizer</td>
<td>A Tokenizer that absorbs tokens, caches them in a private list, and can later iterate over the tokens it had previously cached. This is used in conjunction with TeeTokenizer to “split” a TokenStream.</td>
</tr>
<tr>
<td>StandardTokenizer</td>
<td>Sophisticated grammar-based tokenizer, emitting tokens for high-level types like email addresses (see section 4.3.2 for more details). Each emitted token is tagged with a special type, some of which are handled specially by StandardFilter.</td>
</tr>
<tr>
<td>TokenFilter</td>
<td>TokenStream whose input is another TokenStream.</td>
</tr>
<tr>
<td>LowerCaseFilter</td>
<td>Lowercases token text.</td>
</tr>
<tr>
<td>StopFilter</td>
<td>Removes words that exist in a provided set of words.</td>
</tr>
<tr>
<td>PorterStemFilter</td>
<td>Stems each token using the Porter stemming algorithm. For example, country and countries both stem to countri.</td>
</tr>
<tr>
<td>TeeTokenFilter</td>
<td>Splits a TokenStream by passing each token it iterates through into a SinkTokenizer. It also returns the token unnmodified to its caller.</td>
</tr>
<tr>
<td>ASCIIFoldingFilter</td>
<td>Maps accented characters to their unaccented counterparts.</td>
</tr>
<tr>
<td>CachingTokenFilter</td>
<td>Saves all tokens from the input stream and can replay the stream once reset is called.</td>
</tr>
<tr>
<td>LengthFilter</td>
<td>Accepts tokens whose text length falls within a specified range.</td>
</tr>
<tr>
<td>StandardFilter</td>
<td>Designed to be fed by a StandardTokenizer. Removes dots from acronyms and ’s (apostrophe followed by s) from words with apostrophes.</td>
</tr>
</tbody>
</table>
<p>下面是生成一个分析链的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StopFilter(<span class="keyword">true</span>,</span><br><span class="line">                          <span class="keyword">new</span> LowerCaseTokenizer(reader),</span><br><span class="line">                          stopWords);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个分析器中，LowerCaseTokenizer对象会通过Reader对象输出原始tokens，然后这些token将会被StopFilter处理。</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Lucene_9.png" alt></p>
<h3 id="观察分析器分析过程"><a class="markdownIt-Anchor" href="#观察分析器分析过程"></a> 观察分析器分析过程</h3>
<p>通常情况下，分析过程所产生的token会在没有展示的情况下用于索引操作或者检索。下面我们具体观察一些具体的分析过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.StopAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.SimpleAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.WhitespaceAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnalyzerDemo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] examples = &#123;</span><br><span class="line">    <span class="string">"The quick brown fox jumped over the lazy dog"</span>,</span><br><span class="line">    <span class="string">"XY&amp;Z Corporation - xyz@example.com"</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Analyzer[] analyzers = <span class="keyword">new</span> Analyzer[] &#123; </span><br><span class="line">    <span class="keyword">new</span> WhitespaceAnalyzer(),</span><br><span class="line">    <span class="keyword">new</span> SimpleAnalyzer(),</span><br><span class="line">    <span class="keyword">new</span> StopAnalyzer(Version.LUCENE_30),</span><br><span class="line">    <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    String[] strings = examples;</span><br><span class="line">    <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;    <span class="comment">// A</span></span><br><span class="line">      strings = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String text : strings) &#123;</span><br><span class="line">      analyze(text);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">analyze</span><span class="params">(String text)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"Analyzing \""</span> + text + <span class="string">"\""</span>);</span><br><span class="line">    <span class="keyword">for</span> (Analyzer analyzer : analyzers) &#123;</span><br><span class="line">      String name = analyzer.getClass().getSimpleName();</span><br><span class="line">      System.out.println(<span class="string">"  "</span> + name + <span class="string">":"</span>);</span><br><span class="line">      System.out.print(<span class="string">"    "</span>);</span><br><span class="line">      AnalyzerUtils.displayTokens(analyzer, text); <span class="comment">// B</span></span><br><span class="line">      System.out.println(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// #A Analyze command-line strings, if specified</span></span><br><span class="line"><span class="comment">// #B Real work done in here</span></span><br></pre></td></tr></table></figure>
<p>下面的AnalyzerUtils调用了analyzer对text进行分析，并将得到的token直接输出，而不是用于索引。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> junit.framework.Assert;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.AttributeSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.SimpleAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.TermAttribute;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.TypeAttribute;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.PositionIncrementAttribute;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.OffsetAttribute;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// From chapter 4</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnalyzerUtils</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayTokens</span><span class="params">(Analyzer analyzer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   String text)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    displayTokens(analyzer.tokenStream(<span class="string">"contents"</span>, <span class="keyword">new</span> StringReader(text)));  <span class="comment">//A</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayTokens</span><span class="params">(TokenStream stream)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    TermAttribute term = stream.addAttribute(TermAttribute.class);</span><br><span class="line">    <span class="keyword">while</span>(stream.incrementToken()) &#123;</span><br><span class="line">      System.out.print(<span class="string">"["</span> + term.term() + <span class="string">"] "</span>);    <span class="comment">//B</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #A Invoke analysis process</span></span><br><span class="line"><span class="comment">    #B Print token text surrounded by brackets</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPositionIncrement</span><span class="params">(AttributeSource source)</span> </span>&#123;</span><br><span class="line">    PositionIncrementAttribute attr = source.addAttribute(PositionIncrementAttribute.class);</span><br><span class="line">    <span class="keyword">return</span> attr.getPositionIncrement();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getTerm</span><span class="params">(AttributeSource source)</span> </span>&#123;</span><br><span class="line">    TermAttribute attr = source.addAttribute(TermAttribute.class);</span><br><span class="line">    <span class="keyword">return</span> attr.term();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getType</span><span class="params">(AttributeSource source)</span> </span>&#123;</span><br><span class="line">    TypeAttribute attr = source.addAttribute(TypeAttribute.class);</span><br><span class="line">    <span class="keyword">return</span> attr.type();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setPositionIncrement</span><span class="params">(AttributeSource source, <span class="keyword">int</span> posIncr)</span> </span>&#123;</span><br><span class="line">    PositionIncrementAttribute attr = source.addAttribute(PositionIncrementAttribute.class);</span><br><span class="line">    attr.setPositionIncrement(posIncr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTerm</span><span class="params">(AttributeSource source, String term)</span> </span>&#123;</span><br><span class="line">    TermAttribute attr = source.addAttribute(TermAttribute.class);</span><br><span class="line">    attr.setTermBuffer(term);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(AttributeSource source, String type)</span> </span>&#123;</span><br><span class="line">    TypeAttribute attr = source.addAttribute(TypeAttribute.class);</span><br><span class="line">    attr.setType(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> displayTokensWithPositions</span><br><span class="line">    (Analyzer analyzer, String text) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    TokenStream stream = analyzer.tokenStream(<span class="string">"contents"</span>,</span><br><span class="line">                                              <span class="keyword">new</span> StringReader(text));</span><br><span class="line">    TermAttribute term = stream.addAttribute(TermAttribute.class);</span><br><span class="line">    PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(stream.incrementToken()) &#123;</span><br><span class="line">      <span class="keyword">int</span> increment = posIncr.getPositionIncrement();</span><br><span class="line">      <span class="keyword">if</span> (increment &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        position = position + increment;</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.print(position + <span class="string">": "</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      System.out.print(<span class="string">"["</span> + term.term() + <span class="string">"] "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayTokensWithFullDetails</span><span class="params">(Analyzer analyzer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String text)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    TokenStream stream = analyzer.tokenStream(<span class="string">"contents"</span>,                        <span class="comment">// #A</span></span><br><span class="line">                                              <span class="keyword">new</span> StringReader(text));</span><br><span class="line"></span><br><span class="line">    TermAttribute term = stream.addAttribute(TermAttribute.class);        <span class="comment">// #B</span></span><br><span class="line">    PositionIncrementAttribute posIncr =                                  <span class="comment">// #B </span></span><br><span class="line">    	stream.addAttribute(PositionIncrementAttribute.class);              <span class="comment">// #B</span></span><br><span class="line">    OffsetAttribute offset = stream.addAttribute(OffsetAttribute.class);  <span class="comment">// #B</span></span><br><span class="line">    TypeAttribute type = stream.addAttribute(TypeAttribute.class);        <span class="comment">// #B</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(stream.incrementToken()) &#123;                                  <span class="comment">// #C</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> increment = posIncr.getPositionIncrement();                 <span class="comment">// #D</span></span><br><span class="line">      <span class="keyword">if</span> (increment &gt; <span class="number">0</span>) &#123;                                            <span class="comment">// #D</span></span><br><span class="line">        position = position + increment;                              <span class="comment">// #D</span></span><br><span class="line">        System.out.println();                                         <span class="comment">// #D</span></span><br><span class="line">        System.out.print(position + <span class="string">": "</span>);                            <span class="comment">// #D</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      System.out.print(<span class="string">"["</span> +                                 <span class="comment">// #E</span></span><br><span class="line">                       term.term() + <span class="string">":"</span> +                   <span class="comment">// #E</span></span><br><span class="line">                       offset.startOffset() + <span class="string">"-&gt;"</span> +         <span class="comment">// #E</span></span><br><span class="line">                       offset.endOffset() + <span class="string">":"</span> +            <span class="comment">// #E</span></span><br><span class="line">                       type.type() + <span class="string">"] "</span>);                  <span class="comment">// #E</span></span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #A Perform analysis</span></span><br><span class="line"><span class="comment">    #B Obtain attributes of interest</span></span><br><span class="line"><span class="comment">    #C Iterate through all tokens</span></span><br><span class="line"><span class="comment">    #D Compute position and print</span></span><br><span class="line"><span class="comment">    #E Print all token details</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assertAnalyzesTo</span><span class="params">(Analyzer analyzer, String input,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      String[] output)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    TokenStream stream = analyzer.tokenStream(<span class="string">"field"</span>, <span class="keyword">new</span> StringReader(input));</span><br><span class="line"></span><br><span class="line">    TermAttribute termAttr = stream.addAttribute(TermAttribute.class);</span><br><span class="line">    <span class="keyword">for</span> (String expected : output) &#123;</span><br><span class="line">      Assert.assertTrue(stream.incrementToken());</span><br><span class="line">      Assert.assertEquals(expected, termAttr.term());</span><br><span class="line">    &#125;</span><br><span class="line">    Assert.assertFalse(stream.incrementToken());</span><br><span class="line">    stream.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">displayPositionIncrements</span><span class="params">(Analyzer analyzer, String text)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    TokenStream stream = analyzer.tokenStream(<span class="string">"contents"</span>, <span class="keyword">new</span> StringReader(text));</span><br><span class="line">    PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);</span><br><span class="line">    <span class="keyword">while</span> (stream.incrementToken()) &#123;</span><br><span class="line">      System.out.println(<span class="string">"posIncr="</span> + posIncr.getPositionIncrement());</span><br><span class="line">    &#125;   </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"SimpleAnalyzer"</span>);</span><br><span class="line">    displayTokensWithFullDetails(<span class="keyword">new</span> SimpleAnalyzer(),</span><br><span class="line">        <span class="string">"The quick brown fox...."</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"\n----"</span>);</span><br><span class="line">    System.out.println(<span class="string">"StandardAnalyzer"</span>);</span><br><span class="line">    displayTokensWithFullDetails(<span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30),</span><br><span class="line">        <span class="string">"I'll email you at xyz@example.com"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#1 Invoke analysis process</span></span><br><span class="line"><span class="comment">#2 Output token text surrounded by brackets</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  AnalyzerUtils.displayTokensWithFullDetails(<span class="keyword">new</span> SimpleAnalyzer(),</span><br><span class="line">      <span class="string">"The quick brown fox...."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1: [the:0-&gt;3:word]</span><br><span class="line">2: [quick:4-&gt;9:word]</span><br><span class="line">3: [brown:10-&gt;15:word]</span><br><span class="line">4: [fox:16-&gt;19:word]</span><br></pre></td></tr></table></figure>
<p>可以看到，每个token都被置于与前一token邻接的位置上，这里所有的token都是单词类型的。</p>
<p><strong>属性</strong><br>
需要注意的TokenStream不会显式生成包含所有token属性的token对象，而是是必须与token对应的可重用的属性结构进行交互获得这些属性，这么做主要是考虑扩展性和效率。</p>
<p>TokenStream继承类AttributeSource。AttributeSouce是一种有效并通用的类，用于提供可扩展的属性并且不需要运行时类型转换。Lucene在分析期间可以使用预定义的属性，同样我们也可以加入预定义的属性，需要实现Attribute接口。</p>
<p>Lucene内置的token属性：</p>
<table>
<thead>
<tr>
<th>Token attribute interface</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>TermAttribute</td>
<td>Token’s text</td>
</tr>
<tr>
<td>PositionIncrementAttribute</td>
<td>Position increment (defaults to 1)</td>
</tr>
<tr>
<td>OffsetAttribute</td>
<td>Start and end character offset</td>
</tr>
<tr>
<td>TypeAttribute</td>
<td>Token’s type (defaults to word)</td>
</tr>
<tr>
<td>FlagsAttribute</td>
<td>Bits to encode custom flags</td>
</tr>
<tr>
<td>PayloadAttribute</td>
<td>Per-token byte[] payload (see section 6.5)</td>
</tr>
</tbody>
</table>
<p>通过这个可重用的API，我们可以首先通过调用addAttribute方法来获取所需要的属性，该方法会返回一个实现对应接口的具体类的实例。然后我们可以调用TokenStream的incrementToken()方法来顺序访问所有的token。如果该方法成功移动到下一个token则会返回true，这时之前获得的属性实例都会将内部状态修改为下一个token的属性，我们可以通过这些属性实例进行交互获得token的属性值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TokenStream stream = analyzer.tokenStream(<span class="string">"contents"</span>,</span><br><span class="line">                                          <span class="keyword">new</span> StringReader(text));</span><br><span class="line">                                          </span><br><span class="line">PositionIncrementAttribute posIncr =  stream.addAttribute(PositionIncrementAttribute.class);</span><br><span class="line"><span class="keyword">while</span> (stream.incrementToken()) &#123;</span><br><span class="line">  System.out.println(<span class="string">"posIncr="</span> + posIncr.getPositionIncrement());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意通过上面的属性实例是双向的，我们也可以为token设置属性，</p>
<p>另外，我们也可以控制PositionIncrement，也就是控制是否移到下一个词，也就是通过保持位置不变，我们可以在当前位置添加很多词，而不是原来当前位置的一个词，通过TokenPositionIncrementAttribute.setPositionIncrement(0)可以实现，同样也可以跳过一些词，一般token与token之间的增量是1.<br>
通过这种方法我们可以在同一位置添加同义词，从而实现同义词的去querying。</p>
<p>另外有时我们需要对当前处理的token进行一个完整的备份，用于之后回到当前这个状态。我们可以通过调用captureState来实现记录当前状态，然会一个State对象(保存了所有的状态，属性)。之后我们可以调用restoreStore进行恢复。注意这个方法的代价很高，一般应该尽量避免。</p>
<p>起始和结束位置偏移量可以用于TermVector类进行索引，通常可用于高亮现实搜索结果。</p>
<p>我们还可以设置token类型，如StandardAnalyzer对<code>I’ll email you at xyz@exam- ple.com</code>的处理结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1: [i&apos;ll:0-&gt;4:&lt;APOSTROPHE&gt;]</span><br><span class="line">2: [email:5-&gt;10:&lt;ALPHANUM&gt;]</span><br><span class="line">3: [you:11-&gt;14:&lt;ALPHANUM&gt;]</span><br><span class="line">5: [xyz@example.com:18-&gt;33:&lt;EMAIL&gt;]</span><br></pre></td></tr></table></figure>
<p>token类型还可以用于metaphone和同义词分析器。但是默认情况下。Lucene并不将token类型编入索引，而只是在分析时使用，因此如果有这个需求时，我们需要使用TypeAsPayload的token filter将类型作为有效负载记录下来。</p>
<h3 id="tokenfilter的顺序很重要"><a class="markdownIt-Anchor" href="#tokenfilter的顺序很重要"></a> TokenFilter的顺序很重要</h3>
<p>TokenFilter链在处理token时顺序很重要，如果过滤停用词时，我们需要首先使用LowerCaseFilter，然后再使用StopFilter。如果使用错误的顺序StopFilter，LowerCaseFilter，那么<code>The</code>有可能不会被过滤掉，因为StopFilter默认所有字符已经是小写所以只会匹配<code>the</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// correct version</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopAnalyzer2</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Set stopWords;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StopAnalyzer2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    stopWords = StopAnalyzer.ENGLISH_STOP_WORDS_SET;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StopAnalyzer2</span><span class="params">(String[] stopWords)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.stopWords = StopFilter.makeStopSet(stopWords);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StopFilter(<span class="keyword">true</span>, <span class="keyword">new</span> LowerCaseFilter(<span class="keyword">new</span> LetterTokenizer(reader)),</span><br><span class="line">        stopWords);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// wrong version</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopAnalyzerFlawed</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Set stopWords;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StopAnalyzerFlawed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    stopWords = StopAnalyzer.ENGLISH_STOP_WORDS_SET;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">StopAnalyzerFlawed</span><span class="params">(String[] stopWords)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.stopWords = StopFilter.makeStopSet(stopWords);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Ordering mistake here</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LowerCaseFilter(</span><br><span class="line">           <span class="keyword">new</span> StopFilter(<span class="keyword">true</span>, <span class="keyword">new</span> LetterTokenizer(reader),</span><br><span class="line">                          stopWords));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用内置分析器"><a class="markdownIt-Anchor" href="#使用内置分析器"></a> 使用内置分析器</h2>
<p>Lucene的一些常用分析器：</p>
<table>
<thead>
<tr>
<th>Analyzer</th>
<th>Steps taken</th>
</tr>
</thead>
<tbody>
<tr>
<td>WhitespaceAnalyzer</td>
<td>Splits tokens at whitespace.</td>
</tr>
<tr>
<td>SimpleAnalyzer</td>
<td>Divides text at nonletter characters and lowercases.</td>
</tr>
<tr>
<td>StopAnalyzer</td>
<td>Divides text at nonletter characters, lowercases, and removes stop words.</td>
</tr>
<tr>
<td>KeywordAnalyzer</td>
<td>Treats entire text as a single token.</td>
</tr>
<tr>
<td>StandardAnalyzer</td>
<td>Tokenizes based on a sophisticated grammar that recognizes email addresses, acronyms, Chinese-Japanese-Korean characters, alphanumer- ics, and more. It also lowercases and removes stop words.</td>
</tr>
</tbody>
</table>
<p><strong>StopAnalyzer</strong><br>
StopAnalyzer分析器除了完成基本的token拆分和小写化功能之外，还负责移除停用词(stop words)。StopAnalyzer类内置了如下一个常用常用英文停用词集合，该集合有<code>ENGLISH_STOP_WORDS_SET</code>定义，默认包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;a&quot;, &quot;an&quot;, &quot;and&quot;, &quot;are&quot;, &quot;as&quot;, &quot;at&quot;, &quot;be&quot;, &quot;but&quot;, &quot;by&quot;,</span><br><span class="line">        &quot;for&quot;, &quot;if&quot;, &quot;in&quot;, &quot;into&quot;, &quot;is&quot;, &quot;it&quot;,  &quot;no&quot;, &quot;not&quot;, &quot;of&quot;, &quot;on&quot;,</span><br><span class="line">        &quot;or&quot;, &quot;such&quot;,&quot;that&quot;, &quot;the&quot;, &quot;their&quot;, &quot;then&quot;, &quot;there&quot;, &quot;these&quot;,</span><br><span class="line">        &quot;they&quot;, &quot;this&quot;, &quot;to&quot;, &quot;was&quot;, &quot;will&quot;, &quot;with&quot;</span><br></pre></td></tr></table></figure>
<p>StopAnalyzer有一个可重载的构造方法，允许通过这个方法传入子集的停用词集合。</p>
<p><strong>StandardAnalyzer</strong><br>
StandardAnalyzer是最复杂强大也是最使用的Lucene内置分析器。</p>
<p><strong>分析器的选择</strong></p>
<p>大部分应用程序都不使用任意一种内置分析器，而是选择创建自己的分析器链，因为很多情况下都有特殊的需求，如自定义停用词列表，特殊的tokenlization操作等。</p>
<p>后面的部分将介绍如何创建自己的实用分析器，包括两种常用功能：近音词查询和同义词扩展。</p>
<h2 id="近音词查询sounds-like-querying"><a class="markdownIt-Anchor" href="#近音词查询sounds-like-querying"></a> 近音词查询(Sounds-like querying)</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaphoneAnalyzerTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testKoolKat</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    RAMDirectory directory = <span class="keyword">new</span> RAMDirectory();</span><br><span class="line">    Analyzer analyzer = <span class="keyword">new</span> MetaphoneReplacementAnalyzer();</span><br><span class="line"></span><br><span class="line">    IndexWriter writer = <span class="keyword">new</span> IndexWriter(directory, analyzer, <span class="keyword">true</span>,</span><br><span class="line">                                         IndexWriter.MaxFieldLength.UNLIMITED);</span><br><span class="line"></span><br><span class="line">    Document doc = <span class="keyword">new</span> Document();</span><br><span class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"contents"</span>, <span class="comment">//#A</span></span><br><span class="line">                      <span class="string">"cool cat"</span>,</span><br><span class="line">                      Field.Store.YES,</span><br><span class="line">                      Field.Index.ANALYZED));</span><br><span class="line">    writer.addDocument(doc);</span><br><span class="line">    writer.close();</span><br><span class="line"></span><br><span class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(directory);</span><br><span class="line"></span><br><span class="line">    Query query = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,  <span class="comment">//#B</span></span><br><span class="line">                                  <span class="string">"contents"</span>, analyzer)    <span class="comment">//#B</span></span><br><span class="line">                              .parse(<span class="string">"kool kat"</span>);          <span class="comment">//#B</span></span><br><span class="line"></span><br><span class="line">    TopDocs hits = searcher.search(query, <span class="number">1</span>);</span><br><span class="line">    assertEquals(<span class="number">1</span>, hits.totalHits);   <span class="comment">//#C</span></span><br><span class="line">    <span class="keyword">int</span> docID = hits.scoreDocs[<span class="number">0</span>].doc;</span><br><span class="line">    doc = searcher.doc(docID);</span><br><span class="line">    assertEquals(<span class="string">"cool cat"</span>, doc.get(<span class="string">"contents"</span>));   <span class="comment">//#D</span></span><br><span class="line"></span><br><span class="line">    searcher.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #A Index document</span></span><br><span class="line"><span class="comment">    #B Parse query text</span></span><br><span class="line"><span class="comment">    #C Verify match</span></span><br><span class="line"><span class="comment">    #D Retrieve original value</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    MetaphoneReplacementAnalyzer analyzer =</span><br><span class="line">                                 <span class="keyword">new</span> MetaphoneReplacementAnalyzer();</span><br><span class="line">    AnalyzerUtils.displayTokens(analyzer,</span><br><span class="line">                   <span class="string">"The quick brown fox jumped over the lazy dog"</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">""</span>);</span><br><span class="line">    AnalyzerUtils.displayTokens(analyzer,</span><br><span class="line">                   <span class="string">"Tha quik brown phox jumpd ovvar tha lazi dag"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键是MetaphoneReplacementAnalyzer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaphoneReplacementAnalyzer</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MetaphoneReplacementFilter(</span><br><span class="line">                   <span class="keyword">new</span> LetterTokenizer(reader));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaphoneReplacementFilter</span> <span class="keyword">extends</span> <span class="title">TokenFilter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String METAPHONE = <span class="string">"metaphone"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Metaphone metaphoner = <span class="keyword">new</span> Metaphone();</span><br><span class="line">  <span class="keyword">private</span> TermAttribute termAttr;</span><br><span class="line">  <span class="keyword">private</span> TypeAttribute typeAttr;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MetaphoneReplacementFilter</span><span class="params">(TokenStream input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(input);</span><br><span class="line">    termAttr = addAttribute(TermAttribute.class);</span><br><span class="line">    typeAttr = addAttribute(TypeAttribute.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">incrementToken</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!input.incrementToken())                    <span class="comment">//#A  </span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;                                 <span class="comment">//#A  </span></span><br><span class="line"></span><br><span class="line">    String encoded;</span><br><span class="line">    encoded = metaphoner.encode(termAttr.term());   <span class="comment">//#B</span></span><br><span class="line">    termAttr.setTermBuffer(encoded);                <span class="comment">//#C</span></span><br><span class="line">    typeAttr.setType(METAPHONE);                    <span class="comment">//#D</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的核心是将一个词转化为它的语音词根(phonetic root)，也就是Metaphne algorithm，这里使用了Apache Commons Codec project的实现。</p>
<p>具体实现是将每个incoming的token的text在同一位置替换为该token的phonetic root，并设置为类型为METAPHONE。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String encoded;</span><br><span class="line">encoded = metaphoner.encode(termAttr.term());</span><br><span class="line">termAttr.setTermBuffer(encoded);</span><br><span class="line">typeAttr.setType(METAPHONE);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  MetaphoneReplacementAnalyzer analyzer =</span><br><span class="line">                               <span class="keyword">new</span> MetaphoneReplacementAnalyzer();</span><br><span class="line">  AnalyzerUtils.displayTokens(analyzer,</span><br><span class="line">                 <span class="string">"The quick brown fox jumped over the lazy dog"</span>);</span><br><span class="line"></span><br><span class="line">  System.out.println(<span class="string">""</span>);</span><br><span class="line">  AnalyzerUtils.displayTokens(analyzer,</span><br><span class="line">                 <span class="string">"Tha quik brown phox jumpd ovvar tha lazi dag"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现samples经过metaphone encoder处理后是完全一样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[0] [KK] [BRN] [FKS] [JMPT] [OFR] [0] [LS] [TKS]</span><br><span class="line">[0] [KK] [BRN] [FKS] [JMPT] [OFR] [0] [LS] [TKS]</span><br></pre></td></tr></table></figure>
<p>在实际情况下，我们只在特殊情况下使用sound-like querying，因为sound-like querying通常也会匹配许多完全不相关的结果。Google的策略是只有在用户现有的query存在拼写错误或者几乎没有匹配结果的情况下，才会使用sounld-like querying为用户提供suggestion。</p>
<h2 id="同义词查询"><a class="markdownIt-Anchor" href="#同义词查询"></a> 同义词查询</h2>
<p>一种处理同义词的方法是使得analyzer将token的同义词插入到现在正在处理的token stream中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJumps</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  TokenStream stream =</span><br><span class="line">    synonymAnalyzer.tokenStream(<span class="string">"contents"</span>,                   <span class="comment">// #A</span></span><br><span class="line">                                <span class="keyword">new</span> StringReader(<span class="string">"jumps"</span>));   <span class="comment">// #A</span></span><br><span class="line">  TermAttribute term = stream.addAttribute(TermAttribute.class);</span><br><span class="line">  PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  String[] expected = <span class="keyword">new</span> String[]&#123;<span class="string">"jumps"</span>,              <span class="comment">// #B</span></span><br><span class="line">                                   <span class="string">"hops"</span>,               <span class="comment">// #B</span></span><br><span class="line">                                   <span class="string">"leaps"</span>&#125;;             <span class="comment">// #B</span></span><br><span class="line">  <span class="keyword">while</span>(stream.incrementToken()) &#123;</span><br><span class="line">    assertEquals(expected[i], term.term());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> expectedPos;      <span class="comment">// #C</span></span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;         <span class="comment">// #C</span></span><br><span class="line">      expectedPos = <span class="number">1</span>;    <span class="comment">// #C</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;              <span class="comment">// #C</span></span><br><span class="line">      expectedPos = <span class="number">0</span>;    <span class="comment">// #C</span></span><br><span class="line">    &#125;                     <span class="comment">// #C</span></span><br><span class="line">    assertEquals(expectedPos,                      <span class="comment">// #C</span></span><br><span class="line">                 posIncr.getPositionIncrement());  <span class="comment">// #C</span></span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  assertEquals(<span class="number">3</span>, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SynonymAnalyzer首先需要detect具有同义词的token的出现，然后将这个token的synonyms插入到相同位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.Analyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.LowerCaseFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.StopFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.StopAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardTokenizer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// From chapter 4</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynonymAnalyzer</span> <span class="keyword">extends</span> <span class="title">Analyzer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> SynonymEngine engine;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SynonymAnalyzer</span><span class="params">(SynonymEngine engine)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.engine = engine;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> TokenStream <span class="title">tokenStream</span><span class="params">(String fieldName, Reader reader)</span> </span>&#123;</span><br><span class="line">    TokenStream result = <span class="keyword">new</span> SynonymFilter(</span><br><span class="line">                          <span class="keyword">new</span> StopFilter(<span class="keyword">true</span>,</span><br><span class="line">                            <span class="keyword">new</span> LowerCaseFilter(</span><br><span class="line">                              <span class="keyword">new</span> StandardFilter(</span><br><span class="line">                                <span class="keyword">new</span> StandardTokenizer(</span><br><span class="line">                                 Version.LUCENE_30, reader))),</span><br><span class="line">                            StopAnalyzer.ENGLISH_STOP_WORDS_SET),</span><br><span class="line">                          engine</span><br><span class="line">                         );</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.TokenFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.TermAttribute;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.tokenattributes.PositionIncrementAttribute;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.AttributeSource;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Stack;</span><br><span class="line"><span class="keyword">import</span> lia.analysis.AnalyzerUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">// From chapter 4</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynonymFilter</span> <span class="keyword">extends</span> <span class="title">TokenFilter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOKEN_TYPE_SYNONYM = <span class="string">"SYNONYM"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Stack&lt;String&gt; synonymStack;</span><br><span class="line">  <span class="keyword">private</span> SynonymEngine engine;</span><br><span class="line">  <span class="keyword">private</span> AttributeSource.State current;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TermAttribute termAtt;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PositionIncrementAttribute posIncrAtt;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SynonymFilter</span><span class="params">(TokenStream in, SynonymEngine engine)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(in);</span><br><span class="line">    synonymStack = <span class="keyword">new</span> Stack&lt;String&gt;();                     <span class="comment">//#1 </span></span><br><span class="line">    <span class="keyword">this</span>.engine = engine;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.termAtt = addAttribute(TermAttribute.class);</span><br><span class="line">    <span class="keyword">this</span>.posIncrAtt = addAttribute(PositionIncrementAttribute.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">incrementToken</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (synonymStack.size() &gt; <span class="number">0</span>) &#123;                          <span class="comment">//#2</span></span><br><span class="line">      String syn = synonymStack.pop();                      <span class="comment">//#2</span></span><br><span class="line">      restoreState(current);                                <span class="comment">//#2</span></span><br><span class="line">      termAtt.setTermBuffer(syn);</span><br><span class="line">      posIncrAtt.setPositionIncrement(<span class="number">0</span>);                   <span class="comment">//#3</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!input.incrementToken())                            <span class="comment">//#4  </span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addAliasesToStack()) &#123;                              <span class="comment">//#5 </span></span><br><span class="line">      current = captureState();                             <span class="comment">//#6</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;                                            <span class="comment">//#7</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addAliasesToStack</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String[] synonyms = engine.getSynonyms(termAtt.term()); <span class="comment">//#8</span></span><br><span class="line">    <span class="keyword">if</span> (synonyms == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String synonym : synonyms) &#123;                       <span class="comment">//#9</span></span><br><span class="line">      synonymStack.push(synonym);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#1 Define synonym buffer</span></span><br><span class="line"><span class="comment">#2 Pop buffered synonyms</span></span><br><span class="line"><span class="comment">#3 Set position increment to 0</span></span><br><span class="line"><span class="comment">#4 Read next token</span></span><br><span class="line"><span class="comment">#5 Push synonyms onto stack</span></span><br><span class="line"><span class="comment">#6 Save current token</span></span><br><span class="line"><span class="comment">#7 Return current token</span></span><br><span class="line"><span class="comment">#8 Retrieve synonyms</span></span><br><span class="line"><span class="comment">#9 Push synonyms onto stack</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>考虑到SynonymEngine的可扩展性，因此SynoymEngine类被设计成只有一个方法的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SynonymEngine</span> </span>&#123;</span><br><span class="line">      String[] getSynonyms(String s) <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是一个简单的测试实现方法，实际上Lucene提供了一个基于WordNet的强大的SynonymEngine类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSynonymEngine</span> <span class="keyword">implements</span> <span class="title">SynonymEngine</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, String[]&gt; map = <span class="keyword">new</span> HashMap&lt;String, String[]&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    map.put(<span class="string">"quick"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"fast"</span>, <span class="string">"speedy"</span>&#125;);</span><br><span class="line">    map.put(<span class="string">"jumps"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"leaps"</span>, <span class="string">"hops"</span>&#125;);</span><br><span class="line">    map.put(<span class="string">"over"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"above"</span>&#125;);</span><br><span class="line">    map.put(<span class="string">"lazy"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"apathetic"</span>, <span class="string">"sluggish"</span>&#125;);</span><br><span class="line">    map.put(<span class="string">"dog"</span>, <span class="keyword">new</span> String[] &#123;<span class="string">"canine"</span>, <span class="string">"pooch"</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String[] getSynonyms(String s) &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynonymAnalyzerTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> IndexSearcher searcher;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> SynonymAnalyzer synonymAnalyzer =</span><br><span class="line">                      <span class="keyword">new</span> SynonymAnalyzer(<span class="keyword">new</span> TestSynonymEngine());</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    RAMDirectory directory = <span class="keyword">new</span> RAMDirectory();</span><br><span class="line"></span><br><span class="line">    IndexWriter writer = <span class="keyword">new</span> IndexWriter(directory,</span><br><span class="line">                                         synonymAnalyzer,  <span class="comment">//#1  </span></span><br><span class="line">                                         IndexWriter.MaxFieldLength.UNLIMITED);</span><br><span class="line">    Document doc = <span class="keyword">new</span> Document();</span><br><span class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"content"</span>,</span><br><span class="line">                      <span class="string">"The quick brown fox jumps over the lazy dog"</span>,</span><br><span class="line">                      Field.Store.YES,</span><br><span class="line">                      Field.Index.ANALYZED));  <span class="comment">//#2</span></span><br><span class="line">    writer.addDocument(doc);</span><br><span class="line">                                  </span><br><span class="line">    writer.close();</span><br><span class="line"></span><br><span class="line">    searcher = <span class="keyword">new</span> IndexSearcher(directory, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    searcher.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJumps</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    TokenStream stream =</span><br><span class="line">      synonymAnalyzer.tokenStream(<span class="string">"contents"</span>,                   <span class="comment">// #A</span></span><br><span class="line">                                  <span class="keyword">new</span> StringReader(<span class="string">"jumps"</span>));   <span class="comment">// #A</span></span><br><span class="line">    TermAttribute term = stream.addAttribute(TermAttribute.class);</span><br><span class="line">    PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    String[] expected = <span class="keyword">new</span> String[]&#123;<span class="string">"jumps"</span>,              <span class="comment">// #B</span></span><br><span class="line">                                     <span class="string">"hops"</span>,               <span class="comment">// #B</span></span><br><span class="line">                                     <span class="string">"leaps"</span>&#125;;             <span class="comment">// #B</span></span><br><span class="line">    <span class="keyword">while</span>(stream.incrementToken()) &#123;</span><br><span class="line">      assertEquals(expected[i], term.term());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> expectedPos;      <span class="comment">// #C</span></span><br><span class="line">      <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;         <span class="comment">// #C</span></span><br><span class="line">        expectedPos = <span class="number">1</span>;    <span class="comment">// #C</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;              <span class="comment">// #C</span></span><br><span class="line">        expectedPos = <span class="number">0</span>;    <span class="comment">// #C</span></span><br><span class="line">      &#125;                     <span class="comment">// #C</span></span><br><span class="line">      assertEquals(expectedPos,                      <span class="comment">// #C</span></span><br><span class="line">                   posIncr.getPositionIncrement());  <span class="comment">// #C</span></span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">    assertEquals(<span class="number">3</span>, i);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #A Analyze with SynonymAnalyzer</span></span><br><span class="line"><span class="comment">    #B Check for correct synonyms</span></span><br><span class="line"><span class="comment">    #C Verify synonyms positions</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchByAPI</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    TermQuery tq = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"content"</span>, <span class="string">"hops"</span>));  <span class="comment">//#1</span></span><br><span class="line">    assertEquals(<span class="number">1</span>, TestUtil.hitCount(searcher, tq));</span><br><span class="line"></span><br><span class="line">    PhraseQuery pq = <span class="keyword">new</span> PhraseQuery();    <span class="comment">//#2</span></span><br><span class="line">    pq.add(<span class="keyword">new</span> Term(<span class="string">"content"</span>, <span class="string">"fox"</span>));    <span class="comment">//#2</span></span><br><span class="line">    pq.add(<span class="keyword">new</span> Term(<span class="string">"content"</span>, <span class="string">"hops"</span>));   <span class="comment">//#2</span></span><br><span class="line">    assertEquals(<span class="number">1</span>, TestUtil.hitCount(searcher, pq));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #1 Search for "hops"</span></span><br><span class="line"><span class="comment">    #2 Search for "fox hops"</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWithQueryParser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Query query = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,                   <span class="comment">// 1</span></span><br><span class="line">                                  <span class="string">"content"</span>,                                <span class="comment">// 1</span></span><br><span class="line">                                  synonymAnalyzer).parse(<span class="string">"\"fox jumps\""</span>);  <span class="comment">// 1</span></span><br><span class="line">    assertEquals(<span class="number">1</span>, TestUtil.hitCount(searcher, query));                   <span class="comment">// 1</span></span><br><span class="line">    System.out.println(<span class="string">"With SynonymAnalyzer, \"fox jumps\" parses to "</span> +</span><br><span class="line">                                         query.toString(<span class="string">"content"</span>));</span><br><span class="line"></span><br><span class="line">    query = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,                         <span class="comment">// 2</span></span><br><span class="line">                            <span class="string">"content"</span>,                                      <span class="comment">// 2</span></span><br><span class="line">                            <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30)).parse(<span class="string">"\"fox jumps\""</span>); <span class="comment">// B</span></span><br><span class="line">    assertEquals(<span class="number">1</span>, TestUtil.hitCount(searcher, query));                   <span class="comment">// 2</span></span><br><span class="line">    System.out.println(<span class="string">"With StandardAnalyzer, \"fox jumps\" parses to "</span> +</span><br><span class="line">                                         query.toString(<span class="string">"content"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #1 SynonymAnalyzer finds the document</span></span><br><span class="line"><span class="comment">    #2 StandardAnalyzer also finds document</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="词干分析stemming-analysis"><a class="markdownIt-Anchor" href="#词干分析stemming-analysis"></a> 词干分析(Stemming analysis)</h2>
<h2 id="域分析field-variations"><a class="markdownIt-Anchor" href="#域分析field-variations"></a> 域分析(Field variations)</h2>
<h2 id="语言分析stemming-analysis"><a class="markdownIt-Anchor" href="#语言分析stemming-analysis"></a> 语言分析(Stemming analysis)</h2>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/09/21/Developing_Lucene(3)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Plusaber">
      <meta itemprop="description" content="Plusaber's Blog">
      <meta itemprop="image" content="/images/plusaber.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Plusaber's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/09/21/Developing_Lucene(3)/" class="post-title-link" itemprop="url">Lucene(3)_Search</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-09-21 00:00:00" itemprop="dateCreated datePublished" datetime="2014-09-21T00:00:00+09:00">2014-09-21</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Developing/" itemprop="url" rel="index"><span itemprop="name">Developing</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2014/09/21/Developing_Lucene(3)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/09/21/Developing_Lucene(3)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="实现简单的搜索功能"><a class="markdownIt-Anchor" href="#实现简单的搜索功能"></a> 实现简单的搜索功能</h2>
<p>使用Lucene进行搜索时，我们可以自己构建查询语句，也可以是使用Lucene的QueryParser类将用户输入的文本转换为Query对象。</p>
<h3 id="对于term的检索"><a class="markdownIt-Anchor" href="#对于term的检索"></a> 对于term的检索</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> junit.framework.TestCase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lia.common.TestUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.SimpleAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.Term;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryParser.QueryParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TopDocs;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.Query;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TermQuery;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</span><br><span class="line"></span><br><span class="line"><span class="comment">// From chapter 3</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicSearchingTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTerm</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Directory dir = TestUtil.getBookIndexDirectory(); <span class="comment">//A</span></span><br><span class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(dir);  <span class="comment">//B</span></span><br><span class="line"></span><br><span class="line">    Term t = <span class="keyword">new</span> Term(<span class="string">"subject"</span>, <span class="string">"ant"</span>);</span><br><span class="line">    Query query = <span class="keyword">new</span> TermQuery(t);</span><br><span class="line">    TopDocs docs = searcher.search(query, <span class="number">10</span>);</span><br><span class="line">    assertEquals(<span class="string">"Ant in Action"</span>,                <span class="comment">//C</span></span><br><span class="line">                 <span class="number">1</span>, docs.totalHits);                         <span class="comment">//C</span></span><br><span class="line"></span><br><span class="line">    t = <span class="keyword">new</span> Term(<span class="string">"subject"</span>, <span class="string">"junit"</span>);</span><br><span class="line">    docs = searcher.search(<span class="keyword">new</span> TermQuery(t), <span class="number">10</span>);</span><br><span class="line">    assertEquals(<span class="string">"Ant in Action, "</span> +                                 <span class="comment">//D</span></span><br><span class="line">                 <span class="string">"JUnit in Action, Second Edition"</span>,                  <span class="comment">//D</span></span><br><span class="line">                 <span class="number">2</span>, docs.totalHits);                                 <span class="comment">//D</span></span><br><span class="line"></span><br><span class="line">    searcher.close();</span><br><span class="line">    dir.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #A Obtain directory from TestUtil</span></span><br><span class="line"><span class="comment">    #B Create IndexSearcher</span></span><br><span class="line"><span class="comment">    #C Confirm one hit for "ant"</span></span><br><span class="line"><span class="comment">    #D Confirm two hits for "junit"</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>
<h3 id="解析用户输入的查询表达式queryparser"><a class="markdownIt-Anchor" href="#解析用户输入的查询表达式queryparser"></a> 解析用户输入的查询表达式:QueryParser</h3>
<p>Lucene的搜索方法需要一个Query对象作为参数。对查询表达式的解析就是将用户的query text，例如<code>mock OR junit</code>，转换为对应的Query对象。</p>
<p><img src="https://plusaberblog.s3-ap-northeast-1.amazonaws.com/image/Lucene_4.png" alt="Lucene_4"></p>
<p>QueryParser为查询解析提供了强大的支持，可以处理复杂的条件表达式，最后生成的Query 会非常庞大而复杂。</p>
<p>QueryParser类需要使用一个分析器将查询语句分割为多个项。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QueryParser parser = <span class="keyword">new</span> QueryParser(Version matchVersion,</span><br><span class="line">                                     String field,</span><br><span class="line">                                     Analyzer analyzer)</span><br></pre></td></tr></table></figure>
<p>Version matchVersion用于告诉Lucene使用哪个版本，以实现向后兼容。<br>
field用于指示默认搜索的field，除了query里明确指示了应该搜索哪个域，例如<code>title:lucene</code>。<br>
analyzer指定了用于分解query的分析器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryParser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Directory dir = TestUtil.getBookIndexDirectory();</span><br><span class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(dir);</span><br><span class="line"></span><br><span class="line">    QueryParser parser = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,      <span class="comment">//A</span></span><br><span class="line">                                         <span class="string">"contents"</span>,                  <span class="comment">//A</span></span><br><span class="line">                                         <span class="keyword">new</span> SimpleAnalyzer());       <span class="comment">//A</span></span><br><span class="line"></span><br><span class="line">    Query query = parser.parse(<span class="string">"+JUNIT +ANT -MOCK"</span>);                  <span class="comment">//B</span></span><br><span class="line">    TopDocs docs = searcher.search(query, <span class="number">10</span>);</span><br><span class="line">    assertEquals(<span class="number">1</span>, docs.totalHits);</span><br><span class="line">    Document d = searcher.doc(docs.scoreDocs[<span class="number">0</span>].doc);</span><br><span class="line">    assertEquals(<span class="string">"Ant in Action"</span>, d.get(<span class="string">"title"</span>));</span><br><span class="line"></span><br><span class="line">    query = parser.parse(<span class="string">"mock OR junit"</span>);                            <span class="comment">//B</span></span><br><span class="line">    docs = searcher.search(query, <span class="number">10</span>);</span><br><span class="line">    assertEquals(<span class="string">"Ant in Action, "</span> + </span><br><span class="line">                 <span class="string">"JUnit in Action, Second Edition"</span>,</span><br><span class="line">                 <span class="number">2</span>, docs.totalHits);</span><br><span class="line"></span><br><span class="line">    searcher.close();</span><br><span class="line">    dir.close();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">#A Create QueryParser</span></span><br><span class="line"><span class="comment">#B Parse user's text</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>
<p><strong>query expressions以及其QueryParser分解</strong></p>
<table>
<thead>
<tr>
<th>Query expression</th>
<th>Matches documents that</th>
</tr>
</thead>
<tbody>
<tr>
<td>java</td>
<td>Contain the term java in the default field</td>
</tr>
<tr>
<td>java junit</td>
<td>Contain the term java or junit, or both, in the default field</td>
</tr>
<tr>
<td>java OR junit</td>
<td>Contain the term java or junit, or both, in the default field</td>
</tr>
<tr>
<td>+java +junit</td>
<td>Contain both java and junit in the default field</td>
</tr>
<tr>
<td>java AND junit</td>
<td>Contain both java and junit in the default field</td>
</tr>
<tr>
<td>title:ant</td>
<td>Contain the term ant in the title field</td>
</tr>
<tr>
<td>title:extreme –subject:sports</td>
<td>Contain extreme in the title field and don’t have sports in the subject field</td>
</tr>
<tr>
<td>title:extreme AND NOT subject:sports</td>
<td>Contain extreme in the title field and don’t have sports in the subject field</td>
</tr>
<tr>
<td>(agile OR extreme) AND methodology</td>
<td>Contain methodology and must also contain agile and/or extreme, all in the default field</td>
</tr>
<tr>
<td>title:“junit in action”</td>
<td>Contain the exact phrase “junit in action” in the title field</td>
</tr>
<tr>
<td>title:“junit action”~5</td>
<td>Contain the terms junit and action within five positions of one another, in the title field</td>
</tr>
<tr>
<td>java*</td>
<td>Contain terms that begin with java, like javaspaces, javaserver, <a href="http://java.net" target="_blank" rel="noopener">java.net</a>, and the exact tem java itself.</td>
</tr>
<tr>
<td>java~</td>
<td>Contain terms that are close to the word java, such as lava</td>
</tr>
<tr>
<td>lastmodified: [1/1/09 TO 12/31/09]</td>
<td>Have lastmodified field values between the dates January 1, 2009 and December 31, 2009</td>
</tr>
</tbody>
</table>
<h2 id="使用indexsearcher"><a class="markdownIt-Anchor" href="#使用indexsearcher"></a> 使用IndexSearcher</h2>
<h3 id="创建indexsearcher"><a class="markdownIt-Anchor" href="#创建indexsearcher"></a> 创建IndexSearcher</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Directory dir = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"/path/to/index"</span>));</span><br><span class="line">IndexReader reader = IndexReader.open(dir);</span><br><span class="line">IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);</span><br></pre></td></tr></table></figure>
<p>IndexReaser完成了诸如打开索引系统文件和提供底层reader API等繁重的工作，而IndexSearcher则要简单很多。打开一个IndexReader需要较大的系统开销，所有在搜索期间最好重复使用同一个或有限的几个IndexReader实例，只在有必要的时候才创建新的IndexReader。</p>
<p>另外还可以从Directory直接创建IndexSearcher，这时会创建这个searcher自己的IndexReader，searcher关闭时这个reader也会关闭，消耗比较大。</p>
<p>IndexReader的读操作总是基于它创建时的快照，如果index发生了改变而且我们需要IndexReader同步这些修改，我们需要重新创建一个IndexReader。如果已经有建立的reader，这时可以调用IndexReaser.reopen，会conver所有的change，同时资源消耗会远小于直接创建一个新的reader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IndexReader newReader = reader.reopen();</span><br><span class="line"><span class="keyword">if</span> (reader != newReader) &#123;</span><br><span class="line">  reader.close();</span><br><span class="line">  reader = newReader;</span><br><span class="line">  searcher = <span class="keyword">new</span> IndexSearcher(reader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果索引有所变更，reopen方法返回一个新的reader，这是程序必须关闭reader并创建新的searcher。在实际的应用程序中，可能还有多个线程在使用旧的reader，我们要注意保证线程安全。</p>
<h3 id="实现搜索功能"><a class="markdownIt-Anchor" href="#实现搜索功能"></a> 实现搜索功能</h3>
<p>在建立IndexSearcher实例后，使用<code>search(Query, int)</code>方法进行检索。另外更好高级的操作还有过滤和排序。</p>
<table>
<thead>
<tr>
<th>search method</th>
<th>when to use</th>
</tr>
</thead>
<tbody>
<tr>
<td>TopDocs search(Query query, int n)</td>
<td>Straightforward searches. The int n parameter specifies how many top-scoring documents to return.</td>
</tr>
<tr>
<td>TopDocs search(Query query, Filter filter, int n)</td>
<td>Searches constrained to a subset of available documents, based on filter criteria.</td>
</tr>
<tr>
<td>TopFieldDocs search(Query query, Filter filter, int n, Sort sort)</td>
<td>Searches constrained to a subset of available documents based on filter criteria, and sorted by a custom Sort object</td>
</tr>
<tr>
<td>void search(Query query, Collector results)</td>
<td>Used when you have custom logic to implement for each document visited, or you’d like to collect a different subset of documents than the top N by the sort criteria.</td>
</tr>
<tr>
<td>void search(Query query, Filter filter, Collector results)</td>
<td>Same as previous, except documents are only accepted if they pass the filter criteria.</td>
</tr>
</tbody>
</table>
<h3 id="working-with-topdocs"><a class="markdownIt-Anchor" href="#working-with-topdocs"></a> Working with TopDocs</h3>
<table>
<thead>
<tr>
<th>TopDocs method or attribute</th>
<th>Return value</th>
</tr>
</thead>
<tbody>
<tr>
<td>totalHits</td>
<td>Number of documents that matched the search</td>
</tr>
<tr>
<td>scoreDocs</td>
<td>Array of ScoreDoc instances that contains the results</td>
</tr>
<tr>
<td>getMaxScore()</td>
<td>Returns best score of all matches, if scoring was done while searching (when sorting by field, you separately control whether scores are computed)</td>
</tr>
</tbody>
</table>
<h3 id="搜索结果分页"><a class="markdownIt-Anchor" href="#搜索结果分页"></a> 搜索结果分页</h3>
<p>大部分情况下用户只在首页结果进行查找，但是分页仍是需要的，主要有下面两种解决方案：</p>
<ul>
<li>返回多页的结果并保存在ScoreDocs和IndexSearcher中。</li>
<li>重新发送查询请求(requerying)。</li>
</ul>
<p>Requerying一般是更好的解决方案，可以减少保存用户state，在很多用户的情况下，保存很多用户的state代价是非常大的。Lucene通常查询速度非常快，而且操作系统通常会cache最近查询的数据，使得很多情况下需要的数据还在RAM中。</p>
<h3 id="near-real-time-search"><a class="markdownIt-Anchor" href="#near-real-time-search"></a> Near-real-time search</h3>
<p>Lucene 2.9开始引入近实时检索，使得我们可以快速检索最近index新添加的内容，即是IndexWriter还没有把内容写入到磁盘。许多应用程序在提供搜索功能的同时，也在不断索引新添加的内容，需要维持一个不能段时间关闭的writter，而且需要在搜索时反映出这些新添加的内容。如果writer和reader处于同一个JVM中，我们就可以使用近实时检索(Near-real-time search)。</p>
<p>近实时检索可以是我们能够检索新创建但还未完成提交的段进行检索。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> junit.framework.TestCase;</span><br><span class="line"></span><br><span class="line"><span class="comment">// From chapter 3</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NearRealTimeTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNearRealTime</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Directory dir = <span class="keyword">new</span> RAMDirectory();</span><br><span class="line">    IndexWriter writer = <span class="keyword">new</span> IndexWriter(dir, <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30), IndexWriter.MaxFieldLength.UNLIMITED);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">      Document doc = <span class="keyword">new</span> Document();</span><br><span class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>, <span class="string">""</span>+i, Field.Store.NO, Field.Index.NOT_ANALYZED_NO_NORMS));</span><br><span class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"text"</span>, <span class="string">"aaa"</span>, Field.Store.NO, Field.Index.ANALYZED));</span><br><span class="line">      writer.addDocument(doc);</span><br><span class="line">    &#125;</span><br><span class="line">    IndexReader reader = writer.getReader();                 <span class="comment">// #1</span></span><br><span class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);      <span class="comment">// #A</span></span><br><span class="line"></span><br><span class="line">    Query query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"text"</span>, <span class="string">"aaa"</span>));</span><br><span class="line">    TopDocs docs = searcher.search(query, <span class="number">1</span>);</span><br><span class="line">    assertEquals(<span class="number">10</span>, docs.totalHits);                        <span class="comment">// #B</span></span><br><span class="line"></span><br><span class="line">    writer.deleteDocuments(<span class="keyword">new</span> Term(<span class="string">"id"</span>, <span class="string">"7"</span>));             <span class="comment">// #2</span></span><br><span class="line"></span><br><span class="line">    Document doc = <span class="keyword">new</span> Document();                           <span class="comment">// #3</span></span><br><span class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>,                                  <span class="comment">// #3</span></span><br><span class="line">                      <span class="string">"11"</span>,                                  <span class="comment">// #3</span></span><br><span class="line">                      Field.Store.NO,                        <span class="comment">// #3</span></span><br><span class="line">                      Field.Index.NOT_ANALYZED_NO_NORMS));   <span class="comment">// #3</span></span><br><span class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"text"</span>,                                <span class="comment">// #3</span></span><br><span class="line">                      <span class="string">"bbb"</span>,                                 <span class="comment">// #3</span></span><br><span class="line">                      Field.Store.NO,                        <span class="comment">// #3</span></span><br><span class="line">                      Field.Index.ANALYZED));                <span class="comment">// #3</span></span><br><span class="line">    writer.addDocument(doc);                                 <span class="comment">// #3</span></span><br><span class="line">    </span><br><span class="line">    IndexReader newReader = reader.reopen();                 <span class="comment">// #4</span></span><br><span class="line">    assertFalse(reader == newReader);                        <span class="comment">// #5</span></span><br><span class="line">    reader.close();                                          <span class="comment">// #6</span></span><br><span class="line">    searcher = <span class="keyword">new</span> IndexSearcher(newReader);              </span><br><span class="line"></span><br><span class="line">    TopDocs hits = searcher.search(query, <span class="number">10</span>);               <span class="comment">// #7</span></span><br><span class="line">    assertEquals(<span class="number">9</span>, hits.totalHits);                         <span class="comment">// #7</span></span><br><span class="line"></span><br><span class="line">    query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"text"</span>, <span class="string">"bbb"</span>));          <span class="comment">// #8</span></span><br><span class="line">    hits = searcher.search(query, <span class="number">1</span>);                        <span class="comment">// #8</span></span><br><span class="line">    assertEquals(<span class="number">1</span>, hits.totalHits);                         <span class="comment">// #8</span></span><br><span class="line"></span><br><span class="line">    newReader.close();</span><br><span class="line">    writer.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  #1 Create near-real-time reader</span></span><br><span class="line"><span class="comment">  #A Wrap reader in IndexSearcher</span></span><br><span class="line"><span class="comment">  #B Search returns 10 hits</span></span><br><span class="line"><span class="comment">  #2 Delete 1 document</span></span><br><span class="line"><span class="comment">  #3 Add 1 document</span></span><br><span class="line"><span class="comment">  #4 Reopen reader</span></span><br><span class="line"><span class="comment">  #5 Confirm reader is new</span></span><br><span class="line"><span class="comment">  #6 Close old reader</span></span><br><span class="line"><span class="comment">  #7 Verify 9 hits now</span></span><br><span class="line"><span class="comment">  #8 Confirm new document matched</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#1 IndexWriter returns a reader that's able to search all previously committed changes to the index, plus any uncommitted changes.  The returned reader is always readOnly.</span></span><br><span class="line"><span class="comment">#2,#3 We make changes to the index, but do not commit them.</span></span><br><span class="line"><span class="comment">#4,#5,#6 Ask the reader to reopen.  Note that this simply re-calls writer.getReader again under the hood.  Because we made changes, the newReader will be different from the old one so we must close the old one.</span></span><br><span class="line"><span class="comment">#7, #8 The changes made with the writer are reflected in new searches.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="lucene的评分机制scoring"><a class="markdownIt-Anchor" href="#lucene的评分机制scoring"></a> Lucene的评分机制(scoring)</h2>
<h3 id="how-lucene-scores"><a class="markdownIt-Anchor" href="#how-lucene-scores"></a> How Lucene scores</h3>
<p>Lucene similarity scoring formula:</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><munder><mo>∑</mo><mrow><mi>t</mi><mo>∈</mo><mi>d</mi></mrow></munder><mo stretchy="false">(</mo><mi>t</mi><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo>∈</mo><mi>d</mi><mo stretchy="false">)</mo><mo>×</mo><mi>i</mi><mi>d</mi><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>×</mo><mi>b</mi><mi>o</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>t</mi><mi mathvariant="normal">.</mi><mi>f</mi><mi>i</mi><mi>e</mi><mi>l</mi><mi>d</mi><mo>∈</mo><mi>d</mi><mo stretchy="false">)</mo><mo>×</mo><mi>c</mi><mi>o</mi><mi>o</mi><mi>r</mi><mi>d</mi><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo><mo>×</mo><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi><mi>N</mi><mi>o</mi><mi>r</mi><mi>m</mi><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{t\in d}(tf(t\in d)\times idf(t)^2\times boost(t.field\in d)\times coord(q, d)\times queryNorm(q)) 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3794880000000003em;vertical-align:-1.329483em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight">d</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.329483em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault">o</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">d</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mord mathdefault">u</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">m</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<p>其中d指document，t指term，q指query。<br>
通过这个方程我们可以计算文档对于query的评分，通常还需要将评分进行归一化处理，也就是除以最大评分。评分越大说明文档和query的匹配程度越高。Lucene根据匹配文档的得分进行排序，然后将结果返回。</p>
<p>This score is the raw score, which is a floating-point number &gt;= 0.0. Typically, if an application presents the score to the end user, it’s best to first normalize the scores by dividing all scores by the maximum score for the query. The larger the similarity score, the better the match of the document to the query. By default Lucene returns documents reverse-sorted by this score, meaning the top documents are the best matching ones. Table 3.5 describes each of the factors in the scoring formula.<br>
Boost factors are built into the equation to let you affect a query or field’s influence on score. Field boosts come in explicitly in the equation as the boost(t.field in d) factor, set at indexing time. The default value of field boosts, logically, is 1.0. During indexing, a document can be assigned a boost, too. A document boost factor implicitly sets the starting field boost of all fields to the specified value. Field-specific boosts are multiplied by the starting value, giving the final value of the field boost factor. It’s pos- sible to add the same named field to a document multiple times, and in such situations the field boost is computed as all the boosts specified for that field and document mul- tiplied together. Section 2.5 discusses index-time boosting in more detail.<br>
In addition to the explicit factors in this equation, other factors can be computed on a per-query basis as part of the queryNorm factor. Queries themselves can have an impact on the document score. Boosting a Query instance is sensible only in a multi- ple-clause query; if only a single term is used for searching, changing its boost would impact all matched documents equally. In a multiple-clause Boolean query, some doc- uments may match one clause but not another, enabling the boost factor to discrimi- nate between matching documents. Queries also default to a 1.0 boost factor.<br>
Most of these scoring formula factors are controlled and implemented as a sub- class of the abstract Similarity class. DefaultSimilarity is the implementation used unless otherwise specified. More computations are performed under the covers of DefaultSimilarity; for example, the term frequency factor is the square root of the actual frequency. Because this is an “in action” book, it’s beyond the book’s scope to delve into the inner workings of these calculations. In practice, it’s extremely rare to need a change in these factors. Should you need to change them, please refer to Similarity’s Javadocs, and be prepared with a solid understanding of these factors and the effect your changes will have.<br>
It’s important to note that a change in index-time boosts or the Similarity meth- ods used during indexing, such as lengthNorm, require that the index be rebuilt for all factors to be in sync.<br>
Let’s say you’re baffled as to why a certain document got a good score to your Query. Lucene offers a nice feature to help provide the answer.</p>
<table>
<thead>
<tr>
<th>Factor</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tf(t in d)</code></td>
<td>Term frequency factor for the term (t) in the document (d)—how many times the term t occurs in the document.</td>
</tr>
<tr>
<td><code>idf(t)</code></td>
<td>Inverse document frequency of the term: a measure of how “unique” the term is. Very common terms have a low idf; very rare terms have a high idf.</td>
</tr>
<tr>
<td><code>boost(t.field in d)</code></td>
<td>Field and document boost, as set during indexing (see section 2.5). You may use this to statically boost certain fields and certain docu- ments over others.</td>
</tr>
<tr>
<td><code>lengthNorm(t.field in d)</code></td>
<td>Normalization value of a field, given the number of terms within the field. This value is computed during indexing and stored in the index norms. Shorter fields (fewer tokens) get a bigger boost from this factor.</td>
</tr>
<tr>
<td><code>coord(q, d)</code></td>
<td>Coordination factor, based on the number of query terms the document contains. The coordination factor gives an AND-like boost to documents that contain more of the search terms than other documents.</td>
</tr>
<tr>
<td><code>queryNorm(q)</code></td>
<td>Normalization value for a query, given the sum of the squared weights of each of the query terms.</td>
</tr>
</tbody>
</table>
<h2 id="多样化查询lucenes-diverse-queries"><a class="markdownIt-Anchor" href="#多样化查询lucenes-diverse-queries"></a> 多样化查询(Lucene’s diverse queries)</h2>
<h2 id="queryparser"><a class="markdownIt-Anchor" href="#queryparser"></a> QueryParser</h2>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/plusaber.jpg" alt="Plusaber">
            
              <p class="site-author-name" itemprop="name">Plusaber</p>
              <div class="site-description motion-element" itemprop="description">Plusaber's Blog</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">82</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jp.linkedin.com/in/zebangchen" title="https://jp.linkedin.com/in/zebangchen" rel="noopener" target="_blank">LinkedIn</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://indeed.com" title="https://indeed.com" rel="noopener" target="_blank">Indeed</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://baito.indeed.com" title="https://baito.indeed.com" rel="noopener" target="_blank">Baito</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.kaggle.com" title="https://www.kaggle.com" rel="noopener" target="_blank">Kaggle</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Plusaber</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.1"></script>




  

  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://plusaber.disqus.com/count.js" async></script>







  




  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').not('.gist .highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('Copy');
      }, 300);
    }).append(e);
  })
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  

  

</body>
</html>
