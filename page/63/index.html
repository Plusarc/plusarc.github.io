<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="google88d81a02a91db82f" />










  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Plusaber&apos;s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Plusaber's Blog">
<meta property="og:url" content="http://yoursite.com/page/63/index.html">
<meta property="og:site_name" content="Plusaber's Blog">
<meta property="og:description" content="Plusaber&apos;s Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Plusaber's Blog">
<meta name="twitter:description" content="Plusaber&apos;s Blog">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/63/"/>


  <title> Plusaber's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-hk">

  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-79158075-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Plusaber's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            標籤
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/09/21/Developing_Lucene(3)/" itemprop="url">
                  Lucene(3)_Search
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-09-21T00:00:00+09:00" content="2014-09-21">
              2014-09-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Developing/" itemprop="url" rel="index">
                    <span itemprop="name">Developing</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/09/21/Developing_Lucene(3)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/09/21/Developing_Lucene(3)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="实现简单的搜索功能"><a href="#实现简单的搜索功能" class="headerlink" title="实现简单的搜索功能"></a>实现简单的搜索功能</h2><p>使用Lucene进行搜索时，我们可以自己构建查询语句，也可以是使用Lucene的QueryParser类将用户输入的文本转换为Query对象。</p>
<h3 id="对于term的检索"><a href="#对于term的检索" class="headerlink" title="对于term的检索"></a>对于term的检索</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> junit.framework.TestCase;</div><div class="line"></div><div class="line"><span class="keyword">import</span> lia.common.TestUtil;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.SimpleAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.index.Term;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.queryParser.QueryParser;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.TopDocs;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.Query;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.TermQuery;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 3</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicSearchingTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTerm</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Directory dir = TestUtil.getBookIndexDirectory(); <span class="comment">//A</span></div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(dir);  <span class="comment">//B</span></div><div class="line"></div><div class="line">    Term t = <span class="keyword">new</span> Term(<span class="string">"subject"</span>, <span class="string">"ant"</span>);</div><div class="line">    Query query = <span class="keyword">new</span> TermQuery(t);</div><div class="line">    TopDocs docs = searcher.search(query, <span class="number">10</span>);</div><div class="line">    assertEquals(<span class="string">"Ant in Action"</span>,                <span class="comment">//C</span></div><div class="line">                 <span class="number">1</span>, docs.totalHits);                         <span class="comment">//C</span></div><div class="line"></div><div class="line">    t = <span class="keyword">new</span> Term(<span class="string">"subject"</span>, <span class="string">"junit"</span>);</div><div class="line">    docs = searcher.search(<span class="keyword">new</span> TermQuery(t), <span class="number">10</span>);</div><div class="line">    assertEquals(<span class="string">"Ant in Action, "</span> +                                 <span class="comment">//D</span></div><div class="line">                 <span class="string">"JUnit in Action, Second Edition"</span>,                  <span class="comment">//D</span></div><div class="line">                 <span class="number">2</span>, docs.totalHits);                                 <span class="comment">//D</span></div><div class="line"></div><div class="line">    searcher.close();</div><div class="line">    dir.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">    #A Obtain directory from TestUtil</div><div class="line">    #B Create IndexSearcher</div><div class="line">    #C Confirm one hit for "ant"</div><div class="line">    #D Confirm two hits for "junit"</div><div class="line">  */</div></pre></td></tr></table></figure>
<h3 id="解析用户输入的查询表达式-QueryParser"><a href="#解析用户输入的查询表达式-QueryParser" class="headerlink" title="解析用户输入的查询表达式:QueryParser"></a>解析用户输入的查询表达式:QueryParser</h3><p>Lucene的搜索方法需要一个Query对象作为参数。对查询表达式的解析就是将用户的query text，例如<code>mock OR junit</code>，转换为对应的Query对象。</p>
<p><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_4.png" alt="Lucene_4"></p>
<p>QueryParser为查询解析提供了强大的支持，可以处理复杂的条件表达式，最后生成的Query 会非常庞大而复杂。</p>
<p>QueryParser类需要使用一个分析器将查询语句分割为多个项。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">QueryParser parser = <span class="keyword">new</span> QueryParser(Version matchVersion,</div><div class="line">                                     String field,</div><div class="line">                                     Analyzer analyzer)</div></pre></td></tr></table></figure>
<p>Version matchVersion用于告诉Lucene使用哪个版本，以实现向后兼容。<br>field用于指示默认搜索的field，除了query里明确指示了应该搜索哪个域，例如<code>title:lucene</code>。<br>analyzer指定了用于分解query的分析器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryParser</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Directory dir = TestUtil.getBookIndexDirectory();</div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(dir);</div><div class="line"></div><div class="line">    QueryParser parser = <span class="keyword">new</span> QueryParser(Version.LUCENE_30,      <span class="comment">//A</span></div><div class="line">                                         <span class="string">"contents"</span>,                  <span class="comment">//A</span></div><div class="line">                                         <span class="keyword">new</span> SimpleAnalyzer());       <span class="comment">//A</span></div><div class="line"></div><div class="line">    Query query = parser.parse(<span class="string">"+JUNIT +ANT -MOCK"</span>);                  <span class="comment">//B</span></div><div class="line">    TopDocs docs = searcher.search(query, <span class="number">10</span>);</div><div class="line">    assertEquals(<span class="number">1</span>, docs.totalHits);</div><div class="line">    Document d = searcher.doc(docs.scoreDocs[<span class="number">0</span>].doc);</div><div class="line">    assertEquals(<span class="string">"Ant in Action"</span>, d.get(<span class="string">"title"</span>));</div><div class="line"></div><div class="line">    query = parser.parse(<span class="string">"mock OR junit"</span>);                            <span class="comment">//B</span></div><div class="line">    docs = searcher.search(query, <span class="number">10</span>);</div><div class="line">    assertEquals(<span class="string">"Ant in Action, "</span> + </div><div class="line">                 <span class="string">"JUnit in Action, Second Edition"</span>,</div><div class="line">                 <span class="number">2</span>, docs.totalHits);</div><div class="line"></div><div class="line">    searcher.close();</div><div class="line">    dir.close();</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/*</span></div><div class="line">#A Create QueryParser</div><div class="line">#B Parse user's text</div><div class="line">  */</div></pre></td></tr></table></figure>
<p><strong>query expressions以及其QueryParser分解</strong></p>
<table>
<thead>
<tr>
<th>Query expression</th>
<th>Matches documents that</th>
</tr>
</thead>
<tbody>
<tr>
<td>java</td>
<td>Contain the term java in the default field</td>
</tr>
<tr>
<td>java junit</td>
<td>Contain the term java or junit, or both, in the default field</td>
</tr>
<tr>
<td>java OR junit</td>
<td>Contain the term java or junit, or both, in the default field</td>
</tr>
<tr>
<td>+java +junit</td>
<td>Contain both java and junit in the default field</td>
</tr>
<tr>
<td>java AND junit</td>
<td>Contain both java and junit in the default field</td>
</tr>
<tr>
<td>title:ant</td>
<td>Contain the term ant in the title field</td>
</tr>
<tr>
<td>title:extreme –subject:sports</td>
<td>Contain extreme in the title field and don’t have sports in the subject field</td>
</tr>
<tr>
<td>title:extreme AND NOT subject:sports</td>
<td>Contain extreme in the title field and don’t have sports in the subject field</td>
</tr>
<tr>
<td>(agile OR extreme) AND methodology</td>
<td>Contain methodology and must also contain agile and/or extreme, all in the default field</td>
</tr>
<tr>
<td>title:”junit in action”</td>
<td>Contain the exact phrase “junit in action” in the title field</td>
</tr>
<tr>
<td>title:”junit action”~5</td>
<td>Contain the terms junit and action within five positions of one another, in the title field</td>
</tr>
<tr>
<td>java*</td>
<td>Contain terms that begin with java, like javaspaces, javaserver, java.net, and the exact tem java itself.</td>
</tr>
<tr>
<td>java~</td>
<td>Contain terms that are close to the word java, such as lava</td>
</tr>
<tr>
<td>lastmodified: [1/1/09 TO 12/31/09]</td>
<td>Have lastmodified field values between the dates January 1, 2009 and December 31, 2009</td>
</tr>
</tbody>
</table>
<h2 id="使用IndexSearcher"><a href="#使用IndexSearcher" class="headerlink" title="使用IndexSearcher"></a>使用IndexSearcher</h2><h3 id="创建IndexSearcher"><a href="#创建IndexSearcher" class="headerlink" title="创建IndexSearcher"></a>创建IndexSearcher</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Directory dir = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"/path/to/index"</span>));</div><div class="line">IndexReader reader = IndexReader.open(dir);</div><div class="line">IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);</div></pre></td></tr></table></figure>
<p>IndexReaser完成了诸如打开索引系统文件和提供底层reader API等繁重的工作，而IndexSearcher则要简单很多。打开一个IndexReader需要较大的系统开销，所有在搜索期间最好重复使用同一个或有限的几个IndexReader实例，只在有必要的时候才创建新的IndexReader。</p>
<p>另外还可以从Directory直接创建IndexSearcher，这时会创建这个searcher自己的IndexReader，searcher关闭时这个reader也会关闭，消耗比较大。</p>
<p>IndexReader的读操作总是基于它创建时的快照，如果index发生了改变而且我们需要IndexReader同步这些修改，我们需要重新创建一个IndexReader。如果已经有建立的reader，这时可以调用IndexReaser.reopen，会conver所有的change，同时资源消耗会远小于直接创建一个新的reader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">IndexReader newReader = reader.reopen();</div><div class="line"><span class="keyword">if</span> (reader != newReader) &#123;</div><div class="line">  reader.close();</div><div class="line">  reader = newReader;</div><div class="line">  searcher = <span class="keyword">new</span> IndexSearcher(reader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果索引有所变更，reopen方法返回一个新的reader，这是程序必须关闭reader并创建新的searcher。在实际的应用程序中，可能还有多个线程在使用旧的reader，我们要注意保证线程安全。</p>
<h3 id="实现搜索功能"><a href="#实现搜索功能" class="headerlink" title="实现搜索功能"></a>实现搜索功能</h3><p>在建立IndexSearcher实例后，使用<code>search(Query, int)</code>方法进行检索。另外更好高级的操作还有过滤和排序。</p>
<table>
<thead>
<tr>
<th>search method</th>
<th>when to use</th>
</tr>
</thead>
<tbody>
<tr>
<td>TopDocs search(Query query, int n)</td>
<td>Straightforward searches. The int n parameter specifies how many top-scoring documents to return.</td>
</tr>
<tr>
<td>TopDocs search(Query query, Filter filter, int n)</td>
<td>Searches constrained to a subset of available documents, based on filter criteria.</td>
</tr>
<tr>
<td>TopFieldDocs search(Query query, Filter filter, int n, Sort sort)</td>
<td>Searches constrained to a subset of available documents based on filter criteria, and sorted by a custom Sort object</td>
</tr>
<tr>
<td>void search(Query query, Collector results)</td>
<td>Used when you have custom logic to implement for each document visited, or you’d like to collect a different subset of documents than the top N by the sort criteria.</td>
</tr>
<tr>
<td>void search(Query query, Filter filter, Collector results)</td>
<td>Same as previous, except documents are only accepted if they pass the filter criteria.</td>
</tr>
</tbody>
</table>
<h3 id="Working-with-TopDocs"><a href="#Working-with-TopDocs" class="headerlink" title="Working with TopDocs"></a>Working with TopDocs</h3><table>
<thead>
<tr>
<th>TopDocs method or attribute</th>
<th>Return value</th>
</tr>
</thead>
<tbody>
<tr>
<td>totalHits</td>
<td>Number of documents that matched the search</td>
</tr>
<tr>
<td>scoreDocs</td>
<td>Array of ScoreDoc instances that contains the results</td>
</tr>
<tr>
<td>getMaxScore()</td>
<td>Returns best score of all matches, if scoring was done while searching (when sorting by field, you separately control whether scores are computed)</td>
</tr>
</tbody>
</table>
<h3 id="搜索结果分页"><a href="#搜索结果分页" class="headerlink" title="搜索结果分页"></a>搜索结果分页</h3><p>大部分情况下用户只在首页结果进行查找，但是分页仍是需要的，主要有下面两种解决方案：</p>
<ul>
<li>返回多页的结果并保存在ScoreDocs和IndexSearcher中。</li>
<li>重新发送查询请求(requerying)。</li>
</ul>
<p>Requerying一般是更好的解决方案，可以减少保存用户state，在很多用户的情况下，保存很多用户的state代价是非常大的。Lucene通常查询速度非常快，而且操作系统通常会cache最近查询的数据，使得很多情况下需要的数据还在RAM中。</p>
<h3 id="Near-real-time-search"><a href="#Near-real-time-search" class="headerlink" title="Near-real-time search"></a>Near-real-time search</h3><p>Lucene 2.9开始引入近实时检索，使得我们可以快速检索最近index新添加的内容，即是IndexWriter还没有把内容写入到磁盘。许多应用程序在提供搜索功能的同时，也在不断索引新添加的内容，需要维持一个不能段时间关闭的writter，而且需要在搜索时反映出这些新添加的内容。如果writer和reader处于同一个JVM中，我们就可以使用近实时检索(Near-real-time search)。</p>
<p>近实时检索可以是我们能够检索新创建但还未完成提交的段进行检索。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.*;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.index.*;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.*;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.*;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> junit.framework.TestCase;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 3</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NearRealTimeTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNearRealTime</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Directory dir = <span class="keyword">new</span> RAMDirectory();</div><div class="line">    IndexWriter writer = <span class="keyword">new</span> IndexWriter(dir, <span class="keyword">new</span> StandardAnalyzer(Version.LUCENE_30), IndexWriter.MaxFieldLength.UNLIMITED);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</div><div class="line">      Document doc = <span class="keyword">new</span> Document();</div><div class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>, <span class="string">""</span>+i, Field.Store.NO, Field.Index.NOT_ANALYZED_NO_NORMS));</div><div class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"text"</span>, <span class="string">"aaa"</span>, Field.Store.NO, Field.Index.ANALYZED));</div><div class="line">      writer.addDocument(doc);</div><div class="line">    &#125;</div><div class="line">    IndexReader reader = writer.getReader();                 <span class="comment">// #1</span></div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);      <span class="comment">// #A</span></div><div class="line"></div><div class="line">    Query query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"text"</span>, <span class="string">"aaa"</span>));</div><div class="line">    TopDocs docs = searcher.search(query, <span class="number">1</span>);</div><div class="line">    assertEquals(<span class="number">10</span>, docs.totalHits);                        <span class="comment">// #B</span></div><div class="line"></div><div class="line">    writer.deleteDocuments(<span class="keyword">new</span> Term(<span class="string">"id"</span>, <span class="string">"7"</span>));             <span class="comment">// #2</span></div><div class="line"></div><div class="line">    Document doc = <span class="keyword">new</span> Document();                           <span class="comment">// #3</span></div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>,                                  <span class="comment">// #3</span></div><div class="line">                      <span class="string">"11"</span>,                                  <span class="comment">// #3</span></div><div class="line">                      Field.Store.NO,                        <span class="comment">// #3</span></div><div class="line">                      Field.Index.NOT_ANALYZED_NO_NORMS));   <span class="comment">// #3</span></div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"text"</span>,                                <span class="comment">// #3</span></div><div class="line">                      <span class="string">"bbb"</span>,                                 <span class="comment">// #3</span></div><div class="line">                      Field.Store.NO,                        <span class="comment">// #3</span></div><div class="line">                      Field.Index.ANALYZED));                <span class="comment">// #3</span></div><div class="line">    writer.addDocument(doc);                                 <span class="comment">// #3</span></div><div class="line">    </div><div class="line">    IndexReader newReader = reader.reopen();                 <span class="comment">// #4</span></div><div class="line">    assertFalse(reader == newReader);                        <span class="comment">// #5</span></div><div class="line">    reader.close();                                          <span class="comment">// #6</span></div><div class="line">    searcher = <span class="keyword">new</span> IndexSearcher(newReader);              </div><div class="line"></div><div class="line">    TopDocs hits = searcher.search(query, <span class="number">10</span>);               <span class="comment">// #7</span></div><div class="line">    assertEquals(<span class="number">9</span>, hits.totalHits);                         <span class="comment">// #7</span></div><div class="line"></div><div class="line">    query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"text"</span>, <span class="string">"bbb"</span>));          <span class="comment">// #8</span></div><div class="line">    hits = searcher.search(query, <span class="number">1</span>);                        <span class="comment">// #8</span></div><div class="line">    assertEquals(<span class="number">1</span>, hits.totalHits);                         <span class="comment">// #8</span></div><div class="line"></div><div class="line">    newReader.close();</div><div class="line">    writer.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">  #1 Create near-real-time reader</div><div class="line">  #A Wrap reader in IndexSearcher</div><div class="line">  #B Search returns 10 hits</div><div class="line">  #2 Delete 1 document</div><div class="line">  #3 Add 1 document</div><div class="line">  #4 Reopen reader</div><div class="line">  #5 Confirm reader is new</div><div class="line">  #6 Close old reader</div><div class="line">  #7 Verify 9 hits now</div><div class="line">  #8 Confirm new document matched</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">#1 IndexWriter returns a reader that's able to search all previously committed changes to the index, plus any uncommitted changes.  The returned reader is always readOnly.</div><div class="line">#2,#3 We make changes to the index, but do not commit them.</div><div class="line">#4,#5,#6 Ask the reader to reopen.  Note that this simply re-calls writer.getReader again under the hood.  Because we made changes, the newReader will be different from the old one so we must close the old one.</div><div class="line">#7, #8 The changes made with the writer are reflected in new searches.</div><div class="line">*/</div></pre></td></tr></table></figure>
<h2 id="Lucene的评分机制-scoring"><a href="#Lucene的评分机制-scoring" class="headerlink" title="Lucene的评分机制(scoring)"></a>Lucene的评分机制(scoring)</h2><h3 id="How-Lucene-scores"><a href="#How-Lucene-scores" class="headerlink" title="How Lucene scores"></a>How Lucene scores</h3><p>Lucene similarity scoring formula:</p>
<p>$$ \sum_{t\in d}(tf(t\in d)\times idf(t)^2\times boost(t.field\in d)\times coord(q, d)\times queryNorm(q)) $$</p>
<p>其中d指document，t指term，q指query。<br>通过这个方程我们可以计算文档对于query的评分，通常还需要将评分进行归一化处理，也就是除以最大评分。评分越大说明文档和query的匹配程度越高。Lucene根据匹配文档的得分进行排序，然后将结果返回。</p>
<p>This score is the raw score, which is a floating-point number &gt;= 0.0. Typically, if an application presents the score to the end user, it’s best to first normalize the scores by dividing all scores by the maximum score for the query. The larger the similarity score, the better the match of the document to the query. By default Lucene returns documents reverse-sorted by this score, meaning the top documents are the best matching ones. Table 3.5 describes each of the factors in the scoring formula.<br>Boost factors are built into the equation to let you affect a query or field’s influence on score. Field boosts come in explicitly in the equation as the boost(t.field in d) factor, set at indexing time. The default value of field boosts, logically, is 1.0. During indexing, a document can be assigned a boost, too. A document boost factor implicitly sets the starting field boost of all fields to the specified value. Field-specific boosts are multiplied by the starting value, giving the final value of the field boost factor. It’s pos- sible to add the same named field to a document multiple times, and in such situations the field boost is computed as all the boosts specified for that field and document mul- tiplied together. Section 2.5 discusses index-time boosting in more detail.<br>In addition to the explicit factors in this equation, other factors can be computed on a per-query basis as part of the queryNorm factor. Queries themselves can have an impact on the document score. Boosting a Query instance is sensible only in a multi- ple-clause query; if only a single term is used for searching, changing its boost would impact all matched documents equally. In a multiple-clause Boolean query, some doc- uments may match one clause but not another, enabling the boost factor to discrimi- nate between matching documents. Queries also default to a 1.0 boost factor.<br>Most of these scoring formula factors are controlled and implemented as a sub- class of the abstract Similarity class. DefaultSimilarity is the implementation used unless otherwise specified. More computations are performed under the covers of DefaultSimilarity; for example, the term frequency factor is the square root of the actual frequency. Because this is an “in action” book, it’s beyond the book’s scope to delve into the inner workings of these calculations. In practice, it’s extremely rare to need a change in these factors. Should you need to change them, please refer to Similarity’s Javadocs, and be prepared with a solid understanding of these factors and the effect your changes will have.<br>It’s important to note that a change in index-time boosts or the Similarity meth- ods used during indexing, such as lengthNorm, require that the index be rebuilt for all factors to be in sync.<br>Let’s say you’re baffled as to why a certain document got a good score to your Query. Lucene offers a nice feature to help provide the answer.</p>
<table>
<thead>
<tr>
<th>Factor</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tf(t in d)</code></td>
<td>Term frequency factor for the term (t) in the document (d)—how many times the term t occurs in the document.</td>
</tr>
<tr>
<td><code>idf(t)</code></td>
<td>Inverse document frequency of the term: a measure of how “unique” the term is. Very common terms have a low idf; very rare terms have a high idf.</td>
</tr>
<tr>
<td><code>boost(t.field in d)</code></td>
<td>Field and document boost, as set during indexing (see section 2.5). You may use this to statically boost certain fields and certain docu- ments over others.</td>
</tr>
<tr>
<td><code>lengthNorm(t.field in d)</code></td>
<td>Normalization value of a field, given the number of terms within the field. This value is computed during indexing and stored in the index norms. Shorter fields (fewer tokens) get a bigger boost from this factor.</td>
</tr>
<tr>
<td><code>coord(q, d)</code></td>
<td>Coordination factor, based on the number of query terms the document contains. The coordination factor gives an AND-like boost to documents that contain more of the search terms than other documents.</td>
</tr>
<tr>
<td><code>queryNorm(q)</code></td>
<td>Normalization value for a query, given the sum of the squared weights of each of the query terms.</td>
</tr>
</tbody>
</table>
<h2 id="多样化查询-Lucene’s-diverse-queries"><a href="#多样化查询-Lucene’s-diverse-queries" class="headerlink" title="多样化查询(Lucene’s diverse queries)"></a>多样化查询(Lucene’s diverse queries)</h2><h2 id="QueryParser"><a href="#QueryParser" class="headerlink" title="QueryParser"></a>QueryParser</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/09/16/Design Pattern_Singleton pattern/" itemprop="url">
                  Singleton pattern
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-09-16T00:00:00+09:00" content="2014-09-16">
              2014-09-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index">
                    <span itemprop="name">Design Pattern</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/09/16/Design Pattern_Singleton pattern/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/09/16/Design Pattern_Singleton pattern/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Singleton-pattern"><a href="#Singleton-pattern" class="headerlink" title="Singleton pattern"></a>Singleton pattern</h1><p>看到一篇很好的总结关于Java实现线程安全模式的博文，这里直接refer一下，方便后面查看，原文请参考这里:<a href="http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/" target="_blank" rel="external">如何正确地写出单例模式</a>.</p>
<h2 id="懒汉式，线程不安全"><a href="#懒汉式，线程不安全" class="headerlink" title="懒汉式，线程不安全"></a>懒汉式，线程不安全</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">         instance = <span class="keyword">new</span> Singleton();</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码简单明了，而且使用了懒加载模式，但是却存在致命的问题。当有多个线程并行调用 getInstance() 的时候，就会创建多个实例。也就是说在多线程下不能正常工作。</p>
<h2 id="懒汉式，线程安全"><a href="#懒汉式，线程安全" class="headerlink" title="懒汉式，线程安全"></a>懒汉式，线程安全</h2><p>为了解决上面的问题，最简单的方法是将整个 getInstance() 方法设为同步（synchronized）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">        instance = <span class="keyword">new</span> Singleton();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> instance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然做到了线程安全，并且解决了多实例的问题，但是它并不高效。因为在任何时候只能有一个线程调用 getInstance() 方法。但是同步操作只需要在第一次调用时才被需要，即第一次创建单例实例对象时。这就引出了双重检验锁。</p>
<h2 id="双重检验锁"><a href="#双重检验锁" class="headerlink" title="双重检验锁"></a>双重检验锁</h2><p>双重检验锁模式（double checked locking pattern），是一种使用同步块加锁的方法。程序员称其为双重检查锁，因为会有两次检查 instance == null，一次是在同步块外，一次是在同步块内。为什么在同步块内还要再检验一次？因为可能会有多个线程一起进入同步块外的 if，如果在同步块内不进行二次检验的话就会生成多个实例了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getSingleton</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;                         <span class="comment">//Single Checked</span></div><div class="line">        <span class="keyword">synchronized</span> (Singleton.class) &#123;</div><div class="line">            <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;                 <span class="comment">//Double Checked</span></div><div class="line">                instance = <span class="keyword">new</span> Singleton();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> instance ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码看起来很完美，很可惜，它是有问题。主要在于instance = new Singleton()这句，这并非是一个原子操作，事实上在 JVM 中这句话大概做了下面 3 件事情。</p>
<ol>
<li>给instance 分配内存</li>
<li>调用Singleton的构造函数来初始化成员变量</li>
<li>将instance对象指向分配的内存空间（执行完这步 instance 就为非 null 了）</li>
</ol>
<p>但是在 JVM 的即时编译器中存在指令重排序的优化。也就是说上面的第二步和第三步的顺序是不能保证的，最终的执行顺序可能是 1-2-3 也可能是 1-3-2。如果是后者，则在 3 执行完毕、2 未执行之前，被线程二抢占了，这时 instance 已经是非 null 了（但却没有初始化），所以线程二会直接返回 instance，然后使用，然后顺理成章地报错。</p>
<p>我们只需要将 instance 变量声明成 volatile 就可以了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton instance; <span class="comment">//声明成 volatile</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getSingleton</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;                         </div><div class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</div><div class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;       </div><div class="line">                    instance = <span class="keyword">new</span> Singleton();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有些人认为使用 volatile 的原因是可见性，也就是可以保证线程在本地不会存有 instance 的副本，每次都是去主内存中读取。但其实是不对的。使用 volatile 的主要原因是其另一个特性：禁止指令重排序优化。也就是说，在 volatile 变量的赋值操作后面会有一个内存屏障（生成的汇编代码上），读操作不会被重排序到内存屏障之前。比如上面的例子，取操作必须在执行完 1-2-3 之后或者 1-3-2 之后，不存在执行到 1-3 然后取到值的情况。从「先行发生原则」的角度理解的话，就是对于一个 volatile 变量的写操作都先行发生于后面对这个变量的读操作（这里的“后面”是时间上的先后顺序）。</p>
<p>但是特别注意在 Java 5 以前的版本使用了 volatile 的双检锁还是有问题的。其原因是 Java 5 以前的 JMM （Java 内存模型）是存在缺陷的，即时将变量声明成 volatile 也不能完全避免重排序，主要是 volatile 变量前后的代码仍然存在重排序问题。这个 volatile 屏蔽重排序的问题在 Java 5 中才得以修复，所以在这之后才可以放心使用 volatile。</p>
<p>相信你不会喜欢这种复杂又隐含问题的方式，当然我们有更好的实现线程安全的单例模式的办法。</p>
<h2 id="饿汉式-static-final-field"><a href="#饿汉式-static-final-field" class="headerlink" title="饿汉式 static final field"></a>饿汉式 static final field</h2><p>这种方法非常简单，因为单例的实例被声明成 static 和 final 变量了，在第一次加载类到内存中时就会初始化，所以创建实例本身是线程安全的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span>&#123;</div><div class="line">    <span class="comment">//类加载时就初始化</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton instance = <span class="keyword">new</span> Singleton();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种写法如果完美的话，就没必要在啰嗦那么多双检锁的问题了。缺点是它不是一种懒加载模式（lazy initialization），单例会在加载类后一开始就被初始化，即使客户端没有调用 getInstance()方法。饿汉式的创建方式在一些场景中将无法使用：譬如 Singleton 实例的创建是依赖参数或者配置文件的，在 getInstance() 之前必须调用某个方法设置参数给它，那样这种单例写法就无法使用了。</p>
<h2 id="静态内部类-static-nested-class"><a href="#静态内部类-static-nested-class" class="headerlink" title="静态内部类 static nested class"></a>静态内部类 static nested class</h2><p>我比较倾向于使用静态内部类的方法，这种方法也是《Effective Java》上所推荐的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;  </div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton INSTANCE = <span class="keyword">new</span> Singleton();  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span> <span class="params">()</span></span>&#123;&#125;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> SingletonHolder.INSTANCE; </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种写法仍然使用JVM本身机制保证了线程安全问题；由于 SingletonHolder 是私有的，除了 getInstance() 之外没有办法访问它，因此它是懒汉式的；同时读取实例的时候不会进行同步，没有性能缺陷；也不依赖 JDK 版本。</p>
<h2 id="枚举-Enum"><a href="#枚举-Enum" class="headerlink" title="枚举 Enum"></a>枚举 Enum</h2><p>用枚举写单例实在太简单了！这也是它最大的优点。下面这段代码就是声明枚举实例的通常做法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EasySingleton&#123;</div><div class="line">    INSTANCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以通过EasySingleton.INSTANCE来访问实例，这比调用getInstance()方法简单多了。创建枚举默认就是线程安全的，所以不需要担心double checked locking，而且还能防止反序列化导致重新创建新的对象。但是还是很少看到有人这样写，可能是因为不太熟悉吧。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一般来说，单例模式有五种写法：懒汉、饿汉、双重检验锁、静态内部类、枚举。上述所说都是线程安全的实现，文章开头给出的第一种方法不算正确的写法。</p>
<p>一般情况下直接使用饿汉式就好了，如果明确要求要懒加载（lazy initialization）会倾向于使用静态内部类，如果涉及到反序列化创建对象时会试着使用枚举的方式来实现单例。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/08/26/Developing_Lucene(2)/" itemprop="url">
                  Lucene(2)_Index
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-08-26T00:00:00+09:00" content="2014-08-26">
              2014-08-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Developing/" itemprop="url" rel="index">
                    <span itemprop="name">Developing</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/08/26/Developing_Lucene(2)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/08/26/Developing_Lucene(2)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Lucene的文档建模"><a href="#Lucene的文档建模" class="headerlink" title="Lucene的文档建模"></a>Lucene的文档建模</h2><p>文档是Lucene索引和检索的基本单位。文档为一个包含一个或多个field(域)的容器，如title, keywords, author, summary, content等，而field的内容才是真正被索引和检索的内容（经过分解为tokens之后）。如下面的文档(已经建模和区分为各个field)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">title : hello, world</div><div class="line">key world: blog, hello</div><div class="line">author: zebangchen</div><div class="line">content: I have always believed that the man who has</div><div class="line">begun to live more seriously within begins to live</div><div class="line">more simply without. In an age of extravagance and</div><div class="line">waste, I wish I could show to the world how few the</div><div class="line">real wants of humanity are.</div></pre></td></tr></table></figure>
<p>在对原始文档进行索引时，首先需要将数据转换为Lucene所能识别的文档和field。在随后的搜索过程中，被搜索对象为field的内容，如搜索<code>title : lucene</code>时，搜索结果为title域包含单词<code>lucene</code>的所有文档。</p>
<p>进一步每个域(field)可以进行下面的操作：</p>
<ul>
<li>field的内容(域值)可以不被检索。</li>
<li>field被索引后，可以选择性存储项向量(term vector)，也就是只是针对这个field的内容的索引。</li>
<li>域值可以被单独存储。</li>
</ul>
<h2 id="Index过程"><a href="#Index过程" class="headerlink" title="Index过程"></a>Index过程</h2><p><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_2.png" alt="Lucene_2"></p>
<h3 id="提取plain-text和创建document"><a href="#提取plain-text和创建document" class="headerlink" title="提取plain text和创建document"></a>提取plain text和创建document</h3><p>索引的第一步就是从源文件获取文档然后创建文档，因为很多源文件并不是plain text，例如pdf，xml，html带有大量标签的文档，microsoft文档等。Lucene提供的Tika框架提供了从各个格式文件提取plain text的工具。</p>
<h3 id="分析文档"><a href="#分析文档" class="headerlink" title="分析文档"></a>分析文档</h3><p>下一步是建立lucene文档及其field，然后将document通过IndexWriter对象的addDocument传递给Lucene进行索引操作。首先是分析各个field的内容分割为tokens，这一步可以有很多可选操作，如toLowerCase，去stopword等，同样还需要处理tokens，例如stem操作等。最后得到的各个field的tokens会被用于建立index。</p>
<h3 id="向索引添加文档"><a href="#向索引添加文档" class="headerlink" title="向索引添加文档"></a>向索引添加文档</h3><p>分析得到的token，文档会被用于建立倒排索引(inverted index)。<br><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_3.png" alt=""></p>
<p>Lucene的索引数据结构非常丰富和强大，这里只做一个简要的介绍。Lucene索引包含一个或多个segment(段)。每个段都是一个独立的索引，索引了一部分文档，也就是每个段索引的文档都是不同的，是整个文档集合的一个子集。当索引了一部分文档后，由于内存限制或其他原因，我们需要刷新缓存区的内容将其写入到磁盘中，一个新的段就会被建立，其中包含这部分文档的索引。</p>
<p>在搜索索引时，会访问每个段，然后合并在这些索引段的结果并返回。</p>
<p>一般每个段(索引)都包含多个文件，格式为<code>_x.扩展名</code>，X表示段名称，扩展名用来表示索引的各个不同类型文件（项向量(term vector), 存储的域(stored field), 倒排索引(inverted index))。也可以设置使用混合文件格式，则会将这些不同类型的文件都压缩为一个单一的文件:<code>_X.cfs</code>，这中哦该方式能在搜索期间减少打开文件的数量。</p>
<p>另外还有一个特殊文件，为段文件(segments file)，表示为<code>_&lt;N&gt;</code>。该文件指向其他所有正在使用的段。Lucene在检索时，首先会打开该文件，然后依次打开其所指向的文件。N是一个整数，称为<code>the generation</code>，Lucene每次向index提交更新时N都会被加一。</p>
<p>随着时间推移，索引会有越来越多的段，特别是程序打开和关闭writter频繁时。根据设置IndexWriter类会周期性的合并一些段，合并段的选取策略由MergePolicy类决定。</p>
<h2 id="基本索引操作"><a href="#基本索引操作" class="headerlink" title="基本索引操作"></a>基本索引操作</h2><h3 id="向索引添加文档-1"><a href="#向索引添加文档-1" class="headerlink" title="向索引添加文档"></a>向索引添加文档</h3><ul>
<li><code>addDocument(Document)</code> – 使用默认分析器添加文档，该分析器在创建IndexWriter对象时指定，用于指定将plain text拆分为tokens(tokenization)的策略。</li>
<li><code>addDocument(Document, Analyzer)</code> – 使用指定的分析器进行tokenization。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> junit.framework.TestCase;</div><div class="line"></div><div class="line"><span class="keyword">import</span> lia.common.TestUtil;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.RAMDirectory;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriter;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexReader;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.WhitespaceAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.Query;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.TermQuery;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.index.Term;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 2</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexingTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> String[] ids = &#123;<span class="string">"1"</span>, <span class="string">"2"</span>&#125;;</div><div class="line">  <span class="keyword">protected</span> String[] unindexed = &#123;<span class="string">"Netherlands"</span>, <span class="string">"Italy"</span>&#125;;</div><div class="line">  <span class="keyword">protected</span> String[] unstored = &#123;<span class="string">"Amsterdam has lots of bridges"</span>,</div><div class="line">                                 <span class="string">"Venice has lots of canals"</span>&#125;;</div><div class="line">  <span class="keyword">protected</span> String[] text = &#123;<span class="string">"Amsterdam"</span>, <span class="string">"Venice"</span>&#125;;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Directory directory;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;     <span class="comment">//1</span></div><div class="line">    directory = <span class="keyword">new</span> RAMDirectory();</div><div class="line"></div><div class="line">    IndexWriter writer = getWriter();           <span class="comment">//2</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ids.length; i++) &#123;      <span class="comment">//3</span></div><div class="line">      Document doc = <span class="keyword">new</span> Document();</div><div class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>, ids[i],</div><div class="line">                        Field.Store.YES,</div><div class="line">                        Field.Index.NOT_ANALYZED));</div><div class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"country"</span>, unindexed[i],</div><div class="line">                        Field.Store.YES,</div><div class="line">                        Field.Index.NO));</div><div class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"contents"</span>, unstored[i],</div><div class="line">                        Field.Store.NO,</div><div class="line">                        Field.Index.ANALYZED));</div><div class="line">      doc.add(<span class="keyword">new</span> Field(<span class="string">"city"</span>, text[i],</div><div class="line">                        Field.Store.YES,</div><div class="line">                        Field.Index.ANALYZED));</div><div class="line">      writer.addDocument(doc);</div><div class="line">    &#125;</div><div class="line">    writer.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> IndexWriter <span class="title">getWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;            <span class="comment">// 2</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IndexWriter(directory, <span class="keyword">new</span> WhitespaceAnalyzer(),   <span class="comment">// 2</span></div><div class="line">                           IndexWriter.MaxFieldLength.UNLIMITED); <span class="comment">// 2</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getHitCount</span><span class="params">(String fieldName, String searchString)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">    IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(directory); <span class="comment">//4</span></div><div class="line">    Term t = <span class="keyword">new</span> Term(fieldName, searchString);</div><div class="line">    Query query = <span class="keyword">new</span> TermQuery(t);                        <span class="comment">//5</span></div><div class="line">    <span class="keyword">int</span> hitCount = TestUtil.hitCount(searcher, query);     <span class="comment">//6</span></div><div class="line">    searcher.close();</div><div class="line">    <span class="keyword">return</span> hitCount;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIndexWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    IndexWriter writer = getWriter();</div><div class="line">    assertEquals(ids.length, writer.numDocs());            <span class="comment">//7</span></div><div class="line">    writer.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIndexReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    IndexReader reader = IndexReader.open(directory);</div><div class="line">    assertEquals(ids.length, reader.maxDoc());             <span class="comment">//8</span></div><div class="line">    assertEquals(ids.length, reader.numDocs());            <span class="comment">//8</span></div><div class="line">    reader.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">    #1 Run before every test</div><div class="line">    #2 Create IndexWriter</div><div class="line">    #3 Add documents</div><div class="line">    #4 Create new searcher</div><div class="line">    #5 Build simple single-term query</div><div class="line">    #6 Get number of hits</div><div class="line">    #7 Verify writer document count</div><div class="line">    #8 Verify reader document count</div><div class="line">  */</div></pre></td></tr></table></figure>
<p>我们需要传入三个变量来创建IndexWiter类：</p>
<ul>
<li>Directory类，索引存储位置。</li>
<li>分析器(analyzer)，用于tokenized fields为tokens，进一步用于indexing。</li>
<li>MaxFieldLength.UNLIMITED，用于告诉IndexWriter对文档中所有的token建立索引。</li>
</ul>
<p>IndexWriter类如果检查到之前没有索引在Dicrectory中，则会创建新的索引，否则会将内容加入到存在的索引中。</p>
<p>一旦索引已经被建立或者已经存在，我们就可以循环处理每篇document加入索引。对于每篇plain text文档，我们建立一个Document对象，然后加入其所有的域以及对应的域选项(field options)。 </p>
<h3 id="删除索引中的文档"><a href="#删除索引中的文档" class="headerlink" title="删除索引中的文档"></a>删除索引中的文档</h3><ul>
<li><code>deleteDocuments(Term)</code>，删除包含term的所有文档（在索引中删除））</li>
<li><code>deleteDocuments(Term[])</code>，删除包含任意一个term的文档</li>
<li><code>deleteDocuments(Query)</code>，删除匹配给定query的文档</li>
<li><code>deleteDocuments(Query[])</code>，删除匹配任意一个query的问阿哥</li>
<li><code>deleteAll()</code>，删除index中的所有文档。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteBeforeOptimize</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    IndexWriter writer = getWriter();</div><div class="line">    assertEquals(<span class="number">2</span>, writer.numDocs()); <span class="comment">//A</span></div><div class="line">    writer.deleteDocuments(<span class="keyword">new</span> Term(<span class="string">"id"</span>, <span class="string">"1"</span>));  <span class="comment">//B</span></div><div class="line">    writer.commit();</div><div class="line">    assertTrue(writer.hasDeletions());    <span class="comment">//1</span></div><div class="line">    assertEquals(<span class="number">2</span>, writer.maxDoc());    <span class="comment">//2</span></div><div class="line">    assertEquals(<span class="number">1</span>, writer.numDocs());   <span class="comment">//2   </span></div><div class="line">    writer.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteAfterOptimize</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    IndexWriter writer = getWriter();</div><div class="line">    assertEquals(<span class="number">2</span>, writer.numDocs());</div><div class="line">    writer.deleteDocuments(<span class="keyword">new</span> Term(<span class="string">"id"</span>, <span class="string">"1"</span>));</div><div class="line">    writer.optimize();                <span class="comment">//3</span></div><div class="line">    writer.commit();</div><div class="line">    assertFalse(writer.hasDeletions());</div><div class="line">    assertEquals(<span class="number">1</span>, writer.maxDoc());  <span class="comment">//C</span></div><div class="line">    assertEquals(<span class="number">1</span>, writer.numDocs()); <span class="comment">//C    </span></div><div class="line">    writer.close();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">    #A 2 docs in the index</div><div class="line">    #B Delete first document</div><div class="line">    #C 1 indexed document, 0 deleted documents</div><div class="line">    #1 Index contains deletions</div><div class="line">    #2 1 indexed document, 1 deleted document</div><div class="line">    #3 Optimize compacts deletes</div><div class="line">  */</div></pre></td></tr></table></figure>
<p>在执行delete后，真正的删除操作并不会马山执行，而是放入内存缓冲区。同样我们要调用writter的<code>commit()</code>或<code>close()</code>来执行实际的删除操作。</p>
<h3 id="更新索引中的文档"><a href="#更新索引中的文档" class="headerlink" title="更新索引中的文档"></a>更新索引中的文档</h3><p>Lucene无法只更新文档的某个域，而是删除旧文档，然后向索引中添加新问昂。</p>
<ul>
<li><code>updateDocument(Term, Document)</code>，首先删除包含term的所有文档，然后使用writter的默认分析器添加新文档</li>
<li><code>updateDocument(Term, Document, Analyzer)</code>，与上面功能一致，区别是指定分析器。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">  assertEquals(<span class="number">1</span>, getHitCount(<span class="string">"city"</span>, <span class="string">"Amsterdam"</span>));</div><div class="line"></div><div class="line">  IndexWriter writer = getWriter();</div><div class="line"></div><div class="line">  Document doc = <span class="keyword">new</span> Document();                   <span class="comment">//A            </span></div><div class="line">  doc.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>, <span class="string">"1"</span>,</div><div class="line">                    Field.Store.YES,</div><div class="line">                    Field.Index.NOT_ANALYZED));    <span class="comment">//A</span></div><div class="line">  doc.add(<span class="keyword">new</span> Field(<span class="string">"country"</span>, <span class="string">"Netherlands"</span>,</div><div class="line">                    Field.Store.YES,</div><div class="line">                    Field.Index.NO));              <span class="comment">//A  </span></div><div class="line">  doc.add(<span class="keyword">new</span> Field(<span class="string">"contents"</span>,                    </div><div class="line">                    <span class="string">"Den Haag has a lot of museums"</span>,</div><div class="line">                    Field.Store.NO,</div><div class="line">                    Field.Index.ANALYZED));       <span class="comment">//A</span></div><div class="line">  doc.add(<span class="keyword">new</span> Field(<span class="string">"city"</span>, <span class="string">"Den Haag"</span>,</div><div class="line">                    Field.Store.YES,</div><div class="line">                    Field.Index.ANALYZED));       <span class="comment">//A</span></div><div class="line"></div><div class="line">  writer.updateDocument(<span class="keyword">new</span> Term(<span class="string">"id"</span>, <span class="string">"1"</span>),       <span class="comment">//B</span></div><div class="line">                        doc);                      <span class="comment">//B</span></div><div class="line">  writer.close();</div><div class="line"></div><div class="line">  assertEquals(<span class="number">0</span>, getHitCount(<span class="string">"city"</span>, <span class="string">"Amsterdam"</span>));<span class="comment">//C   </span></div><div class="line">  assertEquals(<span class="number">1</span>, getHitCount(<span class="string">"city"</span>, <span class="string">"Haag"</span>));     <span class="comment">//D  </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">  #A Create new document with "Haag" in city field</div><div class="line">  #B Replace original document with new version</div><div class="line">  #C Verify old document is gone</div><div class="line">  #D Verify new document is indexed</div><div class="line">*/</div></pre></td></tr></table></figure>
<h2 id="域选项-field-options"><a href="#域选项-field-options" class="headerlink" title="域选项(field options)"></a>域选项(field options)</h2><h2 id="索引数字、日期和时间"><a href="#索引数字、日期和时间" class="headerlink" title="索引数字、日期和时间"></a>索引数字、日期和时间</h2><h2 id="优化索引"><a href="#优化索引" class="headerlink" title="优化索引"></a>优化索引</h2><h2 id="其他Directory子类"><a href="#其他Directory子类" class="headerlink" title="其他Directory子类"></a>其他Directory子类</h2><h2 id="并发、线程安全及锁机制"><a href="#并发、线程安全及锁机制" class="headerlink" title="并发、线程安全及锁机制"></a>并发、线程安全及锁机制</h2><h2 id="高级索引概念"><a href="#高级索引概念" class="headerlink" title="高级索引概念"></a>高级索引概念</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/08/09/Developing_Lucene(1)/" itemprop="url">
                  Lucene(1)_Introduction
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-08-09T00:00:00+09:00" content="2014-08-09">
              2014-08-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Developing/" itemprop="url" rel="index">
                    <span itemprop="name">Developing</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/08/09/Developing_Lucene(1)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/08/09/Developing_Lucene(1)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>Lucene是一个强大的开源信息检索工具库，通过Lucene我们可以轻易将搜索功能加到我们的应用程序中。</p>
<p>通常一个搜索程序需要包含的组件如下：<br><img src="http://7xs07u.com1.z0.glb.clouddn.com/Lucene_1.png" alt=""></p>
<p>其中Lucene为深色部分的组件提供了强大的可扩展的工具库。</p>
<p>在获取内容后，为了对这些内容进行高效检索，所需要的做的就是为这些文档建立索引，而在建立索引之前，我们需要分析文档，以把文档分解为token的集合，然后对这些token建立索引。而分解文档为token就是Lucene的第一个任务，有许多问题需要在这一步解决，比如如何处理词组的问题，如何处理拼写错误，如何处理同义词关系等。对于中文等语言，甚至词与词之间都没有边界，这时还需要进行中文分词。</p>
<p>Lucene提供了许多分析器可以让我们轻松定制所需要的文档分析器。</p>
<p>在文档分析后， 我们就可以对文档建立索引，用于高效检索。Lucene也提供了强大的支持。</p>
<p>对于搜索功能，通常是客户提交一个搜索请求，然后系统根据请求返回文档。Lunece提供了一个称为查询解析器的（QueryParser）的开发包用于处理用户的请求。查询请求可以包含布尔运算、短语查询或通配符查询。下一步是根据解析后的查询，结合前面建立的索引得到匹配查询的文档。这一系列非常复杂，Lucene同样提供了强大的支持，可以让我们轻松实现结果检索、过滤、排序等功能。</p>
<p>常见的搜索模型有如下3种：</p>
<ul>
<li>纯布尔模型（pure boolean model） – 只检查查询与文档是否匹配，没有评分，没有排序。</li>
<li>向量空间模型（vector space model） – query和document都作为基于token空间的向量模型，通过计算向量距离作为匹配概率，并用于排序。</li>
<li>概率模型（probabilistic model） – 采用全概率方法来计算文档和查询语句的匹配概率。</li>
</ul>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>下面是一个对指定文件夹以<code>.txt</code>结尾的文件进行index的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> lia.meetlucene;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriter;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.FileFilter;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.FileReader;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 1</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This code was originally written for</div><div class="line"> * Erik's Lucene intro java.net article</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Indexer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (args.length != <span class="number">2</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Usage: java "</span> + Indexer.class.getName()</div><div class="line">        + <span class="string">" &lt;index dir&gt; &lt;data dir&gt;"</span>);</div><div class="line">    &#125;</div><div class="line">    String indexDir = args[<span class="number">0</span>];         <span class="comment">//1</span></div><div class="line">    String dataDir = args[<span class="number">1</span>];          <span class="comment">//2</span></div><div class="line"></div><div class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">    Indexer indexer = <span class="keyword">new</span> Indexer(indexDir);</div><div class="line">    <span class="keyword">int</span> numIndexed;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      numIndexed = indexer.index(dataDir, <span class="keyword">new</span> TextFilesFilter());</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      indexer.close();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">long</span> end = System.currentTimeMillis();</div><div class="line"></div><div class="line">    System.out.println(<span class="string">"Indexing "</span> + numIndexed + <span class="string">" files took "</span></div><div class="line">      + (end - start) + <span class="string">" milliseconds"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> IndexWriter writer;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Indexer</span><span class="params">(String indexDir)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Directory dir = FSDirectory.open(<span class="keyword">new</span> File(indexDir));</div><div class="line">    writer = <span class="keyword">new</span> IndexWriter(dir,            <span class="comment">//3</span></div><div class="line">                 <span class="keyword">new</span> StandardAnalyzer(       <span class="comment">//3</span></div><div class="line">                     Version.LUCENE_30),<span class="comment">//3</span></div><div class="line">                 <span class="keyword">true</span>,                       <span class="comment">//3</span></div><div class="line">                             IndexWriter.MaxFieldLength.UNLIMITED); <span class="comment">//3</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    writer.close();                             <span class="comment">//4</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">index</span><span class="params">(String dataDir, FileFilter filter)</span></span></div><div class="line">    <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">    File[] files = <span class="keyword">new</span> File(dataDir).listFiles();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (File f: files) &#123;</div><div class="line">      <span class="keyword">if</span> (!f.isDirectory() &amp;&amp;</div><div class="line">          !f.isHidden() &amp;&amp;</div><div class="line">          f.exists() &amp;&amp;</div><div class="line">          f.canRead() &amp;&amp;</div><div class="line">          (filter == <span class="keyword">null</span> || filter.accept(f))) &#123;</div><div class="line">        indexFile(f);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> writer.numDocs();                     <span class="comment">//5</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TextFilesFilter</span> <span class="keyword">implements</span> <span class="title">FileFilter</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File path)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> path.getName().toLowerCase()        <span class="comment">//6</span></div><div class="line">             .endsWith(<span class="string">".txt"</span>);                  <span class="comment">//6</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> Document <span class="title">getDocument</span><span class="params">(File f)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Document doc = <span class="keyword">new</span> Document();</div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"contents"</span>, <span class="keyword">new</span> FileReader(f)));      <span class="comment">//7</span></div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"filename"</span>, f.getName(),              <span class="comment">//8</span></div><div class="line">                Field.Store.YES, Field.Index.NOT_ANALYZED));<span class="comment">//8</span></div><div class="line">    doc.add(<span class="keyword">new</span> Field(<span class="string">"fullpath"</span>, f.getCanonicalPath(),     <span class="comment">//9</span></div><div class="line">                Field.Store.YES, Field.Index.NOT_ANALYZED));<span class="comment">//9</span></div><div class="line">    <span class="keyword">return</span> doc;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">indexFile</span><span class="params">(File f)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    System.out.println(<span class="string">"Indexing "</span> + f.getCanonicalPath());</div><div class="line">    Document doc = getDocument(f);</div><div class="line">    writer.addDocument(doc);                              <span class="comment">//10</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">#1 Create index in this directory</div><div class="line">#2 Index *.txt files from this directory</div><div class="line">#3 Create Lucene IndexWriter</div><div class="line">#4 Close IndexWriter</div><div class="line">#5 Return number of documents indexed</div><div class="line">#6 Index .txt files only, using FileFilter</div><div class="line">#7 Index file content</div><div class="line">#8 Index file name</div><div class="line">#9 Index file full path</div><div class="line">#10 Add document to Lucene index</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>简单的搜索程序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> lia.meetlucene;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.Query;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.ScoreDoc;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.search.TopDocs;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.store.Directory;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.queryParser.QueryParser;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.queryParser.ParseException;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</div><div class="line"><span class="keyword">import</span> org.apache.lucene.util.Version;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="comment">// From chapter 1</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This code was originally written for</div><div class="line"> * Erik's Lucene intro java.net article</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Searcher</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IllegalArgumentException,</span></div><div class="line">        IOException, ParseException &#123;</div><div class="line">    <span class="keyword">if</span> (args.length != <span class="number">2</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Usage: java "</span> + Searcher.class.getName()</div><div class="line">        + <span class="string">" &lt;index dir&gt; &lt;query&gt;"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String indexDir = args[<span class="number">0</span>];               <span class="comment">//1 </span></div><div class="line">    String q = args[<span class="number">1</span>];                      <span class="comment">//2   </span></div><div class="line"></div><div class="line">    search(indexDir, q);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">search</span><span class="params">(String indexDir, String q)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException, ParseException &#123;</div><div class="line"></div><div class="line">    Directory dir = FSDirectory.open(<span class="keyword">new</span> File(indexDir)); <span class="comment">//3</span></div><div class="line">    IndexSearcher is = <span class="keyword">new</span> IndexSearcher(dir);   <span class="comment">//3   </span></div><div class="line"></div><div class="line">    QueryParser parser = <span class="keyword">new</span> QueryParser(Version.LUCENE_30, <span class="comment">// 4</span></div><div class="line">                                         <span class="string">"contents"</span>,  <span class="comment">//4</span></div><div class="line">                     <span class="keyword">new</span> StandardAnalyzer(          <span class="comment">//4</span></div><div class="line">                       Version.LUCENE_30));  <span class="comment">//4</span></div><div class="line">    Query query = parser.parse(q);              <span class="comment">//4   </span></div><div class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">    TopDocs hits = is.search(query, <span class="number">10</span>); <span class="comment">//5</span></div><div class="line">    <span class="keyword">long</span> end = System.currentTimeMillis();</div><div class="line"></div><div class="line">    System.err.println(<span class="string">"Found "</span> + hits.totalHits +   <span class="comment">//6  </span></div><div class="line">      <span class="string">" document(s) (in "</span> + (end - start) +        <span class="comment">// 6</span></div><div class="line">      <span class="string">" milliseconds) that matched query '"</span> +     <span class="comment">// 6</span></div><div class="line">      q + <span class="string">"':"</span>);                                   <span class="comment">// 6</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span>(ScoreDoc scoreDoc : hits.scoreDocs) &#123;</div><div class="line">      Document doc = is.doc(scoreDoc.doc);               <span class="comment">//7      </span></div><div class="line">      System.out.println(doc.get(<span class="string">"fullpath"</span>));  <span class="comment">//8  </span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    is.close();                                <span class="comment">//9</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">#1 Parse provided index directory</div><div class="line">#2 Parse provided query string</div><div class="line">#3 Open index</div><div class="line">#4 Parse query</div><div class="line">#5 Search index</div><div class="line">#6 Write search stats</div><div class="line">#7 Retrieve matching document</div><div class="line">#8 Display filename</div><div class="line">#9 Close IndexSearcher</div><div class="line">*/</div></pre></td></tr></table></figure>
<h3 id="索引过程的核心类"><a href="#索引过程的核心类" class="headerlink" title="索引过程的核心类"></a>索引过程的核心类</h3><ul>
<li><p><strong>IndexWriter</strong><br>这个类负责创建新索引或者打开已有索引，以及向索引中添加、删除或更新被索引文档的信息。可以将IndexWritter看做为索引写入操作提供支持的类。IndexWritter需要开辟空间来存储索引，该功能有Directory完成。</p>
</li>
<li><p><strong>Directory</strong><br>Directory类描述了索引的存放位置，这是一个抽象类，它子类负责具体指向索引的存储路径，如前面例子中的FSDirectory.open方法来获取真实路径。</p>
</li>
<li><p><strong>Analyzer</strong><br>文本文件在被索引之前需要经过Analyzer处理。Analyzer在IndexWriter构造器中被指定，负责将文档拆分为tokens，用于index。Analyzer同样是一个抽象类，有很多子类负责不同具体的实现。</p>
</li>
<li><p><strong>Document</strong><br>Document代表一篇文档，但不是原始的text文档，而是抽象文档–fields的集合，fields表示文档的的一些元数据，例如标题，作者，创立日期，summary，filename，first paragraph等。不同的的元数据都作为文档不同的field单独存储并被索引。在不同field的相同token具有不同意义和重要性，比如title的更加重要。在搜索时我们也可以指定token一定要出现在某个field。– Document即是一个包含多个Field对象的容器，Field是一个包含能被索引的文本内容的类。</p>
</li>
<li><p><strong>Field</strong><br>索引中的每个文档都包含一个或多个不同的field（域），每个field都有一个名字（域名）和对应的内容(text)，以及一组选项说明lucene如何index这个field的内容。文档可以拥有多个同名的field，但是在建立索引时，这些field内容按照顺序被处理，就像被连接在一起作为一个text处理。</p>
</li>
</ul>
<h3 id="搜索过程的核心类"><a href="#搜索过程的核心类" class="headerlink" title="搜索过程的核心类"></a>搜索过程的核心类</h3><p><strong>IndexSearcher</strong><br>IndexSearcher用于搜索索引。最基本的使用是传入一个query对象和top N参数，返回一个TopDocs对象包含若干结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Directory dir = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"/tmp/index"</span>));</div><div class="line">        IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(dir);</div><div class="line">        Query q = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"contents"</span>, <span class="string">"lucene"</span>));</div><div class="line">        TopDocs hits = searcher.search(q, <span class="number">10</span>);</div><div class="line">searcher.close();</div></pre></td></tr></table></figure>
<ul>
<li><strong>Term</strong><br>Term对象是搜索功能的基本单元，与Field对象十分类似，只不过一个是query的组成单元，一个是Document的组成单元。Term同样包含一对字符串元素：名字和内容（text）。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Query q = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"contents"</span>, <span class="string">"lucene"</span>));</div><div class="line">        TopDocs hits = searcher.search(q, <span class="number">10</span>);</div></pre></td></tr></table></figure>
<p>上面代码表示寻找contexts域（field）包含单词lucene的前10个document。</p>
<ul>
<li><p><strong>Query</strong><br>Query类对象是查询的参数，也是一个抽象类，具体实现有TermQuery, BooleanQuery, PhraseQuery…</p>
</li>
<li><p><strong>TermQuery</strong><br>TermQuery是最基本最简单的查询类型，用来匹配指定域(field)中包含特定内容的文档。</p>
</li>
<li><p><strong>TopDocs</strong><br>TopDocs类是一个简单的指针容器，指向前N个排名的搜索结果。TopDocs记录前N个结果的int docID和浮点型分数。</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/08/05/Java_Template/" itemprop="url">
                  Java泛型
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">發表於</span>
            <time itemprop="dateCreated" datetime="2014-08-05T00:00:00+09:00" content="2014-08-05">
              2014-08-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/08/05/Java_Template/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2014/08/05/Java_Template/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Java泛型"><a href="#Java泛型" class="headerlink" title="Java泛型"></a>Java泛型</h1><p>感觉java泛型设计得挺复杂，特别是泛型，泛型通配符，泛型上限下限等搅在一起时，实在不太好区分，容易出错。不管怎样，泛型对于设计可复用和扩展的代码支持还是很强大的，这里总结一下自己的理解。《疯狂java讲义》讲解的非常好，想深入理解可以参考该书，另外后面的代码也是参考该书。</p>
<p>泛型就是指在定义类，借口，方法使用类型形参，这个类型形参将在声明变量，创建对象，调用方法动态地指定，可以极强的增强代码的通用性。</p>
<h2 id="理解泛型"><a href="#理解泛型" class="headerlink" title="理解泛型"></a>理解泛型</h2><h3 id="定义泛型接口，类"><a href="#定义泛型接口，类" class="headerlink" title="定义泛型接口，类"></a>定义泛型接口，类</h3><p>Example</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(E x)</span></span>;</div><div class="line">	<span class="function">Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	<span class="function">E <span class="title">next</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Map</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	<span class="function">Set&lt;K&gt; <span class="title">keySet</span><span class="params">()</span></span>;</div><div class="line">	<span class="function">V <span class="title">put</span><span class="params">(K key, V value)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span>&lt;<span class="title">T</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 使用T类型形参定义实例变量</span></div><div class="line">	<span class="keyword">private</span> T info;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Apple</span><span class="params">()</span></span>&#123;&#125;</div><div class="line">	<span class="comment">// 下面方法中使用T类型形参来定义构造器</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Apple</span><span class="params">(T info)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">this</span>.info = info;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInfo</span><span class="params">(T info)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">this</span>.info = info;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">getInfo</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.info;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">// 因为传给T形参的是String实际类型，</span></div><div class="line">		<span class="comment">// 所以构造器的参数只能是String</span></div><div class="line">		Apple&lt;String&gt; a1 = <span class="keyword">new</span> Apple&lt;&gt;(<span class="string">"苹果"</span>);</div><div class="line">		System.out.println(a1.getInfo());</div><div class="line">		<span class="comment">// 因为传给T形参的是Double实际类型，</span></div><div class="line">		<span class="comment">// 所以构造器的参数只能是Double或者double</span></div><div class="line">		Apple&lt;Double&gt; a2 = <span class="keyword">new</span> Apple&lt;&gt;(<span class="number">5.67</span>);</div><div class="line">		System.out.println(a2.getInfo());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="从泛型类派生子类"><a href="#从泛型类派生子类" class="headerlink" title="从泛型类派生子类"></a>从泛型类派生子类</h3><p>为Apple派生子类时，不能在包含形参，下面代码是错误的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">Apple</span>&lt;<span class="title">T</span>&gt;</span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>必须要改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">Apple</span>&lt;<span class="title">String</span>&gt;</span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">Apple</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>需要注意的是，这时系统会把<code>Apple&lt;T&gt;</code>类里的T当做Object类型来处理。</p>
<h3 id="并不存在泛型类"><a href="#并不存在泛型类" class="headerlink" title="并不存在泛型类"></a>并不存在泛型类</h3><p><code>ArrayList&lt;String&gt;</code>只是类似于一种逻辑类，并不是真正产生了一个新的class文件或新的类。</p>
<p>不管为泛型的类型形参传入哪一种类型实参，对于Java来说它们依然被当做同一个类处理，在内存也只占用一块内存空间，因此在静态方法，静态初始化快或者静态变量的声明和初始化中不允许使用类型形参。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">R</span>&lt;<span class="title">T</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 下面代码错误，不能在静态Field声明中使用类型形参</span></div><div class="line"><span class="comment">//	static T info;</span></div><div class="line">	T age;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(T msg)</span></span>&#123;&#125;</div><div class="line">	<span class="comment">// 下面代码错误，不能在静态方法声明中使用类型形参</span></div><div class="line"><span class="comment">//	public static void bar(T msg)&#123;&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外由于系统中并不会真正生成泛型类，所以instanceof运算符后不能使用泛型类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Collection&lt;String&gt; cs = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="keyword">if</span>(cs <span class="keyword">instanceof</span> ArrayList&lt;String&gt;)&#123;...&#125;  <span class="comment">//引发编译错误</span></div></pre></td></tr></table></figure>
<h2 id="类型通配符"><a href="#类型通配符" class="headerlink" title="类型通配符"></a>类型通配符</h2><p><code>List&lt;Integer&gt;</code> 并不是<code>List&lt;Object&gt;</code>的子类型！<br>也就是: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(List&lt;Object&gt; c)</span> </span>&#123;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;c.size(), i++) &#123;</div><div class="line">		System.out.println(c.get(i));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>并不能输入<code>List&lt;Integer&gt; c</code>作为参数。</p>
<h3 id="使用类型通配-–（？）"><a href="#使用类型通配-–（？）" class="headerlink" title="使用类型通配 –（？）"></a>使用类型通配 –（？）</h3><p>为了表示各种泛型List的父类(并不是真正的父类，只是一种类似的逻辑关系)，可以使用类型通配符，类型通配符是一个问号(?)，将一个问号作为类型实参传给List集合，写作<code>List&lt;?&gt;</code>，意思是元素类型未知的List。这个？被称为通配符，它的元素类型可以匹配任何类型。</p>
<p>也就是，在 <code>public void test(List&lt;?&gt; c)</code>的函数，可以输入<code>List&lt;Integer&gt; c</code>，<code>List&lt;String&gt; c</code>,<code>List&lt;Character&gt; c</code>作为参数。</p>
<p>可以通过这种带通配符的List遍历元素，但是，不能这种带通配符的List将元素加入到其中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</div><div class="line">List&lt;?&gt; c = list;</div><div class="line"><span class="comment">//或者 List&lt;?&gt; c = new ArrayList&lt;String&gt;();</span></div><div class="line"></div><div class="line">c.add(<span class="keyword">new</span> Object());   <span class="comment">// 应发编译错误</span></div><div class="line">c.add(<span class="number">12</span>);   <span class="comment">// 引发编译错误</span></div></pre></td></tr></table></figure>
<p>原因是系统无法确定c集合中元素的类型，所以不能向其中添加对象。根绝前面<code>List&lt;E&gt;</code>接口的定义代码可以发现，add()方法需要有类型参数E作为集合元素的类型，传给add的参数必须是E类的对象或者其子类的对象，但在这中情况下，因为并不知道E是什么类型(?)，所以程序无法判断尝试放入的对象是否合法，所以无法放入元素。唯一的例外是null。</p>
<p>另一方面程序可以调用get()方法来返回<code>List&lt;?&gt;</code>集合指定索引处的元素，其返回值一个未知类的元素，但可以肯定的是，它总是一个Object对象，所以一定可以用Object接受，如果知道其类型，也可以使用类型转换转到所需要的对象类型。</p>
<h3 id="设定类型通配符的上限"><a href="#设定类型通配符的上限" class="headerlink" title="设定类型通配符的上限"></a>设定类型通配符的上限</h3><p>当直接使用<code>List&lt;?&gt;</code>这种形式时，即表明这个List集合可以是任何泛型List的父类。但在某些情况，我们不希望这个List是任何List的父类，而是代表某一类泛型List的父类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义一个抽象类Shape</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Shape</span></span></div><div class="line">&#123; </div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas c)</span></span>; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 定义Shape的子类Rectangle</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 实现画图方法，以打印字符串来模拟画图方法实现</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas c)</span> </span></div><div class="line">	&#123; </div><div class="line">		System.out.println(<span class="string">"把一个矩形画在画布"</span> + c + <span class="string">"上"</span>);</div><div class="line">	&#125; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 定义Shape的子类Circle</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">extends</span> <span class="title">Shape</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 实现画图方法，以打印字符串来模拟画图方法实现</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas c)</span></span></div><div class="line">	&#123;</div><div class="line">		System.out.println(<span class="string">"在画布"</span> + c + <span class="string">"上画一个圆"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Canvas</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 同时在画布上绘制多个形状</span></div><div class="line"><span class="comment">//	public void drawAll(List&lt;Shape&gt; shapes)</span></div><div class="line"><span class="comment">//	&#123;</span></div><div class="line"><span class="comment">//		for (Shape s : shapes)</span></div><div class="line"><span class="comment">//		&#123;</span></div><div class="line"><span class="comment">//			s.draw(this);</span></div><div class="line"><span class="comment">//		&#125;</span></div><div class="line"><span class="comment">//	&#125;</span></div><div class="line"><span class="comment">//	public void drawAll(List&lt;?&gt; shapes)</span></div><div class="line"><span class="comment">//	&#123;</span></div><div class="line"><span class="comment">//		for (Object obj : shapes)</span></div><div class="line"><span class="comment">//		&#123;</span></div><div class="line"><span class="comment">//			Shape s = (Shape)obj;</span></div><div class="line"><span class="comment">//			s.draw(this);</span></div><div class="line"><span class="comment">//		&#125;</span></div><div class="line"><span class="comment">//	&#125;</span></div><div class="line">	<span class="comment">// 同时在画布上绘制多个形状，使用被限制的泛型通配符</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawAll</span><span class="params">(List&lt;? extends Shape&gt; shapes)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span> (Shape s : shapes)</div><div class="line">		&#123;</div><div class="line">			s.draw(<span class="keyword">this</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">	&#123;</div><div class="line">		List&lt;Circle&gt; circleList = <span class="keyword">new</span> ArrayList&lt;Circle&gt;();</div><div class="line">		Canvas c = <span class="keyword">new</span> Canvas();</div><div class="line">		<span class="comment">// 由于List&lt;Circle&gt;并不是List&lt;Shape&gt;的子类型,</span></div><div class="line">		<span class="comment">// 所以下面代码引发编译错误</span></div><div class="line">		c.drawAll(circleList);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>List&lt;? extends Shape&gt;</code>是受限制通配符的例子，此处？同样代表一个未知的类型，但是此处的未知类型一定是Shape的子类型(也可以是Shape本身)，因此可以把Shape称为这个通配符的上限(upper bound).</p>
<p>这时<code>drawAll(List&lt;? extends Shape&gt; shapes)</code>的参数就限定了泛型参数必须为Shape或者其子类，而不能是其他，例如List<integer> c就不能作为drawAll的参数，否则会引发编译错误。</integer></p>
<p>类似的，由于系统无法确定这个受限制的通配符的具体类型，所以不能不能通过shapes把对象添加到这个泛型中，即使是Shape的对象或子类对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRectangle</span><span class="params">(List&lt;? extends Shape&gt; shapes)</span></span></div><div class="line">&#123;</div><div class="line">	shapes.add(<span class="keyword">new</span> Rectangle());  <span class="comment">//编译错误</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="设定类型形参的上限"><a href="#设定类型形参的上限" class="headerlink" title="设定类型形参的上限"></a>设定类型形参的上限</h3><p>Java泛型不仅允许在使用通配符形参时设定上限，而且可以在定义类型形参时设定上限，用于表示传给该类型形参的实际类型要么是该上限类型，要么是该上限类型的子类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Number</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	T col;</div><div class="line">	....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="泛型方法"><a href="#泛型方法" class="headerlink" title="泛型方法"></a>泛型方法</h2><p>在定义类，接口时没有使用类型形参，但定义方法时想自己定义类型形参，这时可以使用泛型方法。</p>
<h3 id="定义泛型方法"><a href="#定义泛型方法" class="headerlink" title="定义泛型方法"></a>定义泛型方法</h3><p>考虑实现这样一个方法，该方法将一个Object数组的所有元素添加到一个Collection集合中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">fromArrayToCollection(Object[] a, Collection&lt;Object&gt; c) &#123;</div><div class="line">	<span class="keyword">for</span>(Object o : a ) &#123;</div><div class="line">		c.add(o);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>问题，并不能使用Collection<string>, 同样不能使用:</string></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">fromArrayToCollection(Object[] a, Collection&lt;?&gt; c) &#123;</div><div class="line">	<span class="keyword">for</span>(Object o : a ) &#123;</div><div class="line">		c.add(o);  <span class="comment">// 编译错误</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用泛型方法解决问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">修饰符 &lt;T, S&gt; 返回值类型 方法明&lt;形参列表&gt; &#123;&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericMethodTest</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 声明一个泛型方法，该泛型方法中带一个T类型形参，</span></div><div class="line">	<span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">fromArrayToCollection</span><span class="params">(T[] a, Collection&lt;T&gt; c)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span> (T o : a)</div><div class="line">		&#123;</div><div class="line">			c.add(o);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></div><div class="line">	&#123;</div><div class="line">		Object[] oa = <span class="keyword">new</span> Object[<span class="number">100</span>];</div><div class="line">		Collection&lt;Object&gt; co = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		<span class="comment">// 下面代码中T代表Object类型</span></div><div class="line">		&lt;Object&gt; fromArrayToCollection(oa, co);</div><div class="line">		String[] sa = <span class="keyword">new</span> String[<span class="number">100</span>];</div><div class="line">		Collection&lt;String&gt; cs = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		<span class="comment">// 下面代码中T代表String类型</span></div><div class="line">		fromArrayToCollection(sa, cs);</div><div class="line">		<span class="comment">// 下面代码中T代表Object类型</span></div><div class="line">		fromArrayToCollection(sa, co);</div><div class="line">		Integer[] ia = <span class="keyword">new</span> Integer[<span class="number">100</span>];</div><div class="line">		Float[] fa = <span class="keyword">new</span> Float[<span class="number">100</span>];</div><div class="line">		Number[] na = <span class="keyword">new</span> Number[<span class="number">100</span>];</div><div class="line">		Collection&lt;Number&gt; cn = <span class="keyword">new</span> ArrayList&lt;&gt;(); </div><div class="line">		<span class="comment">// 下面代码中T代表Number类型</span></div><div class="line">		fromArrayToCollection(ia, cn);</div><div class="line">		<span class="comment">// 下面代码中T代表Number类型</span></div><div class="line">		fromArrayToCollection(fa, cn); </div><div class="line">		<span class="comment">// 下面代码中T代表Number类型</span></div><div class="line">		fromArrayToCollection(na, cn);</div><div class="line">		<span class="comment">// 下面代码中T代表Object类型</span></div><div class="line">		fromArrayToCollection(na, co);</div><div class="line">		<span class="comment">// 下面代码中T代表String类型，但na是一个Number数组，</span></div><div class="line">		<span class="comment">// 因为Number既不是String类型，</span></div><div class="line">		<span class="comment">// 也不是它的子类，所以出现编译错误</span></div><div class="line">		<span class="comment">//fromArrayToCollection(na, cs);</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与类，接口使用泛型参数不同的是，方法中的泛型参数，方法中的泛型参数无需显式传入实际类型参数，如上面所示，调用方法时，无需在调用方法前传入String，Object等类型，系统完成推断，但是如果传入的参数的类型不同，系统则无法准确判断该使用哪个类型，出现错误。</p>
<p>如果传入的参数有不同的形参，但是属于同一类型，可以借助带上限的通配符解决。否则需要声明多个泛型参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RightTest</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 声明一个泛型方法，该泛型方法中带一个T形参</span></div><div class="line">	<span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(Collection&lt;? extends T&gt; from , Collection&lt;T&gt; to)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span> (T ele : from)</div><div class="line">		&#123;</div><div class="line">			to.add(ele);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></div><div class="line">	&#123;</div><div class="line">		List&lt;Object&gt; ao = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		List&lt;String&gt; as = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		<span class="comment">// 下面代码完全正常</span></div><div class="line">		test(as , ao);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="泛型方法和类型通配符的区别"><a href="#泛型方法和类型通配符的区别" class="headerlink" title="泛型方法和类型通配符的区别"></a>泛型方法和类型通配符的区别</h3><p>大多数时候都可以使用泛型方法来代替类型通配符，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Collection</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">containsAll</span><span class="params">(Collection&lt;?&gt; c)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Collection</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	&lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">containAll</span><span class="params">(Collection&lt;T&gt; c)</span></span>;</div><div class="line">	&lt;T extends E&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;T&gt; c)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面两个方法类型形参T只使用了依次，产生的唯一效果是可以在不同的调用点传入不同的实际类型，对于这种情况，应该使用通配符：通配符就是被设计用来支持灵活的子类化的。</p>
<p>泛型方法允许类型形参被用来表示方法的一个或者多个参数之间的类型依赖关系，或者方法返回值与参数之间的类型依赖关系，另外还支持添加元素。如果没有这样的类型依赖关系，就不应该使用泛型方法。</p>
<p>如果有需要，也可以同时使用泛型方法和通配符，如Java的<code>Collections.copy()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Collections</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">copy</span><span class="params">(List&lt;T&gt; dest, List&lt;? extends T&gt; src)</span></span>&#123;...&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Java-7的”菱形”语法与泛型构造器"><a href="#Java-7的”菱形”语法与泛型构造器" class="headerlink" title="Java 7的”菱形”语法与泛型构造器"></a>Java 7的”菱形”语法与泛型构造器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; Foo(T t)</div><div class="line">	&#123;</div><div class="line">		System.out.println(t);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericConstructor</span></span></div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">// 泛型构造器中的T参数为String。</span></div><div class="line">		<span class="keyword">new</span> Foo(<span class="string">"疯狂Java讲义"</span>);</div><div class="line">		<span class="comment">// 泛型构造器中的T参数为Integer。</span></div><div class="line">		<span class="keyword">new</span> Foo(<span class="number">200</span>);</div><div class="line">		<span class="comment">// 显式指定泛型构造器中的T参数为String，</span></div><div class="line">		<span class="comment">// 传给Foo构造器的实参也是String对象，完全正确。</span></div><div class="line">		<span class="keyword">new</span> &lt;String&gt; Foo(<span class="string">"疯狂Android讲义"</span>);</div><div class="line">		<span class="comment">// 显式指定泛型构造器中的T参数为String，</span></div><div class="line">		<span class="comment">// 传给Foo构造器的实参也是Double对象，下面代码出错</span></div><div class="line">		<span class="keyword">new</span> &lt;String&gt; Foo(<span class="number">12.3</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; MyClass(T t) </div><div class="line">	&#123;</div><div class="line">		System.out.println(<span class="string">"t参数的值为："</span> + t);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericDiamondTest</span></span></div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">// MyClass类声明中的E形参是String类型。</span></div><div class="line">		<span class="comment">// 泛型构造器中声明的T形参是Integer类型</span></div><div class="line">		MyClass&lt;String&gt; mc1 = <span class="keyword">new</span> MyClass&lt;&gt;(<span class="number">5</span>);</div><div class="line">		<span class="comment">// 显式指定泛型构造器中声明的T形参是Integer类型，</span></div><div class="line">		MyClass&lt;String&gt; mc2 = <span class="keyword">new</span> &lt;Integer&gt; MyClass&lt;String&gt;(<span class="number">5</span>);</div><div class="line">		<span class="comment">// MyClass类声明中的E形参是String类型。</span></div><div class="line">		<span class="comment">// 如果显式指定泛型构造器中声明的T形参是Integer类型</span></div><div class="line">		<span class="comment">// 此时就不能使用"菱形"语法，下面代码是错的。</span></div><div class="line">		<span class="comment">//MyClass&lt;String&gt; mc3 = new &lt;Integer&gt; MyClass&lt;&gt;(5);</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="设定通配符下限"><a href="#设定通配符下限" class="headerlink" title="设定通配符下限"></a>设定通配符下限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUtils</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 下面dest集合元素类型必须与src集合元素类型相同，或是其父类</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">copy</span><span class="params">(Collection&lt;? <span class="keyword">super</span> T&gt; dest </span></span></div><div class="line">		, Collection&lt;T&gt; src)</div><div class="line">	&#123;</div><div class="line">		T last = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">for</span> (T ele  : src)</div><div class="line">		&#123;</div><div class="line">			last = ele;</div><div class="line">			dest.add(ele);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> last;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></div><div class="line">	&#123;</div><div class="line">		List&lt;Number&gt; ln = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		List&lt;Integer&gt; li = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		li.add(<span class="number">5</span>);</div><div class="line">		<span class="comment">// 此处可准确的知道最后一个被复制的元素是Integer类型</span></div><div class="line">		<span class="comment">// 与src集合元素的类型相同</span></div><div class="line">		Integer last = copy(ln , li);    <span class="comment">// ①</span></div><div class="line">		System.out.println(ln);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="搽除和转换"><a href="#搽除和转换" class="headerlink" title="搽除和转换"></a>搽除和转换</h2><p>在严格的泛型代码里，带泛型声明的类总应该带着类型参数。但为了与老的Java代码保持一致，也允许在使用泛型声明的类时不指定实际的类型参数。如果没有为这个泛型类指定实际的类型参数，则该类型参数被称作raw type，默认是声明该类型参数时制定的第一个个上限类型。</p>
<p>当把一个具有泛型信息的对象赋给另一个没有泛型信息的变量是，所有在尖括号之间的类型信息都将被扔掉。比如一个<code>List&lt;String&gt;</code>类型被转换为List，则该List对集合元素的类型检查变成了类型参数的上限(即Object)。<code>List&lt;Integer&gt;</code>则变成Number，下面程序示范了这种搽除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Number</span>&gt;</span></div><div class="line">&#123;</div><div class="line">	T size;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Apple</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Apple</span><span class="params">(T size)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">this</span>.size = size;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSize</span><span class="params">(T size)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">this</span>.size = size;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">getSize</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.size;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErasureTest</span></span></div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">	&#123;</div><div class="line">		Apple&lt;Integer&gt; a = <span class="keyword">new</span> Apple&lt;&gt;(<span class="number">6</span>);    <span class="comment">//①</span></div><div class="line">		<span class="comment">// a的getSize方法返回Integer对象</span></div><div class="line">		Integer as = a.getSize();</div><div class="line">		<span class="comment">// 把a对象赋给Apple变量，丢失尖括号里的类型信息</span></div><div class="line">		Apple b = a;      <span class="comment">//②</span></div><div class="line">		<span class="comment">// b只知道size的类型是Number</span></div><div class="line">		Number size1 = b.getSize();</div><div class="line">		<span class="comment">// 下面代码引起编译错误</span></div><div class="line">		Integer size2 = b.getSize();  <span class="comment">//③</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErasureTest2</span></span></div><div class="line">&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></div><div class="line">	&#123;</div><div class="line">		List&lt;Integer&gt; li = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">		li.add(<span class="number">6</span>);</div><div class="line">		li.add(<span class="number">9</span>);</div><div class="line">		List list = li;</div><div class="line">		<span class="comment">// 下面代码引起“未经检查的转换”的警告，编译、运行时完全正常</span></div><div class="line">		List&lt;String&gt; ls = list;     <span class="comment">// ①</span></div><div class="line">		<span class="comment">// 但只要访问ls里的元素，如下面代码将引起运行时异常。</span></div><div class="line">		System.out.println(ls.get(<span class="number">0</span>));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="泛型与数组"><a href="#泛型与数组" class="headerlink" title="泛型与数组"></a>泛型与数组</h2><p>Java不支持创建泛型数组，数组元素的类型不能包含类型变量或类型形参，除非是无上限的类型通配符。但可以声明元素包含类型变量或者类型形参的数组(相当晕。。)。也就是说，可以声明<code>List&lt;String&gt;[]</code>形式的数组，但不能创建<code>ArrayList&lt;String&gt;[10]</code>这样的数组对象。另外特殊的是可以建立无上限的通配符泛型数组，例如<code>new ArrayList&lt;?&gt;[10]</code>。在这种情况下，程序不得不进行强制类型转换。</p>
<p>创建元素类型是类型变量的数组对象也将导致编译错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;T&gt; T[] makeArray(Collection&lt;T&gt; coll)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> T[coll.size()];</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/62/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/62/">62</a><span class="page-number current">63</span><a class="page-number" href="/page/64/">64</a><span class="space">&hellip;</span><a class="page-number" href="/page/66/">66</a><a class="extend next" rel="next" href="/page/64/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/plusaber.jpg"
               alt="Plusaber" />
          <p class="site-author-name" itemprop="name">Plusaber</p>
          <p class="site-description motion-element" itemprop="description">Plusaber's Blog</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">328</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.kaggle.com" title="Kaggle" target="_blank">Kaggle</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.algolia.com" title="Algolia" target="_blank">Algolia</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://jp.linkedin.com/in/zebangchen" title="LinkedIn" target="_blank">LinkedIn</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://portal.qiniu.com" title="Qiniu" target="_blank">Qiniu</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Plusaber</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'plusaber';
      var disqus_identifier = 'page/63/index.html';
      var disqus_title = "";
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  

  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  

  

  


</body>
</html>
