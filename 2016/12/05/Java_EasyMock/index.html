<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










  <meta name="google-site-verification" content="google88d81a02a91db82f">















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=7.1.1">


  <link rel="mask-icon" href="/favicon.ico?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: 'LP2H1MWXO2',
      apiKey: '69bf93a909694ef7f679098292b442ca',
      indexName: 'Plusaber',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="入职之后开发和之前自己的project或者在startup的一个明显不同是，colleague的code review和开发的整个生命周期的维护（设计，实现，测试，qa，部署，AB test，logging）。 在单元测试时，由于很多类的功能都是依赖于其他类的功能，如果在测试一个类是全部引入其依赖的类的对象，会导致高度耦合和复杂度，首先一个问题是，单元测试失败时我们无法定位是哪里的问题，是当前正在">
<meta name="keywords" content="java">
<meta property="og:type" content="article">
<meta property="og:title" content="Let&#39;s EasyMock">
<meta property="og:url" content="http://yoursite.com/2016/12/05/Java_EasyMock/index.html">
<meta property="og:site_name" content="Plusaber&#39;s Blog">
<meta property="og:description" content="入职之后开发和之前自己的project或者在startup的一个明显不同是，colleague的code review和开发的整个生命周期的维护（设计，实现，测试，qa，部署，AB test，logging）。 在单元测试时，由于很多类的功能都是依赖于其他类的功能，如果在测试一个类是全部引入其依赖的类的对象，会导致高度耦合和复杂度，首先一个问题是，单元测试失败时我们无法定位是哪里的问题，是当前正在">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2016-12-04T15:41:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Let&#39;s EasyMock">
<meta name="twitter:description" content="入职之后开发和之前自己的project或者在startup的一个明显不同是，colleague的code review和开发的整个生命周期的维护（设计，实现，测试，qa，部署，AB test，logging）。 在单元测试时，由于很多类的功能都是依赖于其他类的功能，如果在测试一个类是全部引入其依赖的类的对象，会导致高度耦合和复杂度，首先一个问题是，单元测试失败时我们无法定位是哪里的问题，是当前正在">





  
  
  <link rel="canonical" href="http://yoursite.com/2016/12/05/Java_EasyMock/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Let's EasyMock | Plusaber's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Plusaber's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/05/Java_EasyMock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Plusaber">
      <meta itemprop="description" content="Plusaber's Blog">
      <meta itemprop="image" content="/images/plusaber.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Plusaber's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Let's EasyMock

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-12-05 00:00:00" itemprop="dateCreated datePublished" datetime="2016-12-05T00:00:00+09:00">2016-12-05</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2016/12/05/Java_EasyMock/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/12/05/Java_EasyMock/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>入职之后开发和之前自己的project或者在startup的一个明显不同是，colleague的code review和开发的整个生命周期的维护（设计，实现，测试，qa，部署，AB test，logging）。</p>
<p>在单元测试时，由于很多类的功能都是依赖于其他类的功能，如果在测试一个类是全部引入其依赖的类的对象，会导致高度耦合和复杂度，首先一个问题是，单元测试失败时我们无法定位是哪里的问题，是当前正在测试的类的问题还是其依赖的类的问题。</p>
<p>单元测试的目的是检测单个function的逻辑是否能工作正常，而不是各个类耦合在一起能否一起完成整体功能（有intergration测试）。所以我们需要模拟依赖的各个类，使得其确定能工作正常（设定其行为）。</p>
<p>EasyMock就是一个经常使用的Mock工具，我们可以借助其快速生成我们想要的mock object。</p>
<h2 id="installation"><a class="markdownIt-Anchor" href="#installation"></a> Installation</h2>
<p>Maven</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.easymock&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;easymock&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;3.4&lt;/version&gt;</span><br><span class="line">  &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h2 id="mocking"><a class="markdownIt-Anchor" href="#mocking"></a> Mocking</h2>
<h3 id="the-first-mock-object"><a class="markdownIt-Anchor" href="#the-first-mock-object"></a> The first Mock Object</h3>
<p>假设我们现在有下面的test class：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ClassUnderTest classUnderTest;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Collaborator mock;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Before</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    classUnderTest = <span class="keyword">new</span> ClassUnderTest();</span><br><span class="line">    classUnderTest.setListener(mock);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRemoveNonExistingDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This call should not lead to any notification</span></span><br><span class="line">    <span class="comment">// of the Mock Object:</span></span><br><span class="line">    classUnderTest.removeDocument(<span class="string">"Does not exist"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于大部分的mock，我们只需要静态import EasyMock的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.easymock.EasyMock.*;</span><br><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> ClassUnderTest classUnderTest;</span><br><span class="line">  <span class="keyword">private</span> Collaborator mock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于创建我们所需要的Mock object，我们只需要：</p>
<ol>
<li>创建mock object</li>
<li>设定我们希望的mock的行为(function及其返回结果)</li>
<li>切换对象到replay状态</li>
</ol>
<p>创建mock object我们可以使用mock方法或者annotations：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  mock = mock(Collaborator.class); <span class="comment">// 1</span></span><br><span class="line">  classUnderTest = <span class="keyword">new</span> ClassUnderTest();</span><br><span class="line">  classUnderTest.setListener(mock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRemoveNonExistingDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 2 (we do not expect anything)</span></span><br><span class="line">  replay(mock); <span class="comment">// 3</span></span><br><span class="line">  classUnderTest.removeDocument(<span class="string">"Does not exist"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的测试中，我们没有指定任何mock的行为，然后replay it。也就是我们expect no calls，所以在第三步时我们call any of the interface methods时，会得到AssertionError。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError:</span><br><span class="line">  <span class="function">Unexpected method call <span class="title">documentRemoved</span><span class="params">(<span class="string">"Does not exist"</span>)</span>:</span></span><br><span class="line"><span class="function">    at org.easymock.internal.MockInvocationHandler.<span class="title">invoke</span><span class="params">(MockInvocationHandler.java:<span class="number">29</span>)</span></span></span><br><span class="line"><span class="function">    at org.easymock.internal.ObjectMethodsFilter.<span class="title">invoke</span><span class="params">(ObjectMethodsFilter.java:<span class="number">44</span>)</span></span></span><br><span class="line"><span class="function">    at $Proxy0.<span class="title">documentRemoved</span><span class="params">(Unknown Source)</span></span></span><br><span class="line"><span class="function">    at org.easymock.samples.ClassUnderTest.<span class="title">notifyListenersDocumentRemoved</span><span class="params">(ClassUnderTest.java:<span class="number">74</span>)</span></span></span><br><span class="line"><span class="function">    at org.easymock.samples.ClassUnderTest.<span class="title">removeDocument</span><span class="params">(ClassUnderTest.java:<span class="number">33</span>)</span></span></span><br><span class="line"><span class="function">    at org.easymock.samples.ExampleTest.<span class="title">testRemoveNonExistingDocument</span><span class="params">(ExampleTest.java:<span class="number">24</span>)</span></span></span><br><span class="line"><span class="function">      ...</span></span><br></pre></td></tr></table></figure>
<h3 id="using-annotations"><a class="markdownIt-Anchor" href="#using-annotations"></a> Using annotations</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.easymock.EasyMock.*;</span><br><span class="line"><span class="keyword">import</span> org.easymock.EasyMockRunner;</span><br><span class="line"><span class="keyword">import</span> org.easymock.TestSubject;</span><br><span class="line"><span class="keyword">import</span> org.easymock.Mock;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(EasyMockRunner.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TestSubject</span></span><br><span class="line">  <span class="keyword">private</span> ClassUnderTest classUnderTest = <span class="keyword">new</span> ClassUnderTest(); <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mock</span></span><br><span class="line">  <span class="keyword">private</span> Collaborator mock; <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRemoveNonExistingDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    replay(mock);</span><br><span class="line">    classUnderTest.removeDocument(<span class="string">"Does not exist"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mock会由runner初始化，可以不用添加setUp方法来初始化mock。</p>
<p>然后有时我们需要其他的runner，这时我们可以JUnit rule来代替runner。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.easymock.EasyMock.*;</span><br><span class="line"><span class="keyword">import</span> org.easymock.EasyMockRule;</span><br><span class="line"><span class="keyword">import</span> org.easymock.TestSubject;</span><br><span class="line"><span class="keyword">import</span> org.easymock.Mock;</span><br><span class="line"><span class="keyword">import</span> org.junit.Rule;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Rule</span></span><br><span class="line">  <span class="keyword">public</span> EasyMockRule mocks = <span class="keyword">new</span> EasyMockRule(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TestSubject</span></span><br><span class="line">  <span class="keyword">private</span> ClassUnderTest classUnderTest = <span class="keyword">new</span> ClassUnderTest();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mock</span></span><br><span class="line">  <span class="keyword">private</span> Collaborator mock;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRemoveNonExistingDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    replay(mock);</span><br><span class="line">    classUnderTest.removeDocument(<span class="string">"Does not exist"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外annotation可以下面的optional的element：</p>
<ul>
<li><code>type</code>，用于指定mock的类型(nice, strict)。</li>
<li><code>name</code>，用于指定mock名字。</li>
<li><code>fieldName</code>，用于specifying the target field name where the mock should be injected.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mock</span>(type = MockType.NICE, name = <span class="string">"mock"</span>, fieldName = <span class="string">"someField"</span>)</span><br><span class="line"><span class="keyword">private</span> Collaborator mock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mock</span>(type = MockType.STRICT, name = <span class="string">"anotherMock"</span>, fieldName = <span class="string">"someOtherField"</span>)</span><br><span class="line"><span class="keyword">private</span> Collaborator anotherMock;</span><br></pre></td></tr></table></figure>
 <a id="more"></a>
<h3 id="easymocksupport"><a class="markdownIt-Anchor" href="#easymocksupport"></a> EasyMockSupport</h3>
<p>EasyMockSupport可以帮助我们跟踪创建的所有mock，自动的注册，replay以及verfiy这些mocks，可以省去显示进行这些步骤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SupportTest</span> <span class="keyword">extends</span> <span class="title">EasyMockSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Collaborator firstCollaborator;</span><br><span class="line">  <span class="keyword">private</span> Collaborator secondCollaborator;</span><br><span class="line">  <span class="keyword">private</span> ClassTested classUnderTest;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Before</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    classUnderTest = <span class="keyword">new</span> ClassTested();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// creation phase</span></span><br><span class="line">    firstCollaborator = mock(Collaborator.class);</span><br><span class="line">    secondCollaborator = mock(Collaborator.class);</span><br><span class="line">    classUnderTest.addListener(firstCollaborator);</span><br><span class="line">    classUnderTest.addListener(secondCollaborator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// recording phase</span></span><br><span class="line">    firstCollaborator.documentAdded(<span class="string">"New Document"</span>);</span><br><span class="line">    secondCollaborator.documentAdded(<span class="string">"New Document"</span>);</span><br><span class="line">    replayAll(); <span class="comment">// replay all mocks at once</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// test</span></span><br><span class="line">    classUnderTest.addDocument(<span class="string">"New Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">    verifyAll(); <span class="comment">// verify all mocks at once</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="strict-mocks"><a class="markdownIt-Anchor" href="#strict-mocks"></a> Strict Mocks</h3>
<p>在使用mock()创建的mock对象时(默认TYPE)，方法调用以及方法调用的次数会被check，但是方法调用的顺序并不会被check，如果如果需要，可以使用<code>EasyMock.strictMock()</code>创建mock对象。</p>
<p>如果调用了mock对象所没有的方法或者不是调用当前顺序位置的方法，strict mock对象会抛出异常并show the method calls expected at this point followed by the first conflicting one。<code>verify(mock)</code>会列出所有缺失的method calls。</p>
<h3 id="nice-mocks"><a class="markdownIt-Anchor" href="#nice-mocks"></a> Nice mocks</h3>
<p>默认的mock()创建的mock对象在遇到unexpected method calls会抛出AssertionError。如果需要创建一个遇到unexpected method时返回合适的空值(0, null, false)，可以使用<code>niceMock()</code>。</p>
<h3 id="partial-mocking"><a class="markdownIt-Anchor" href="#partial-mocking"></a> Partial mocking</h3>
<p>有时我们需要只mock类的部分方法，而keep the normal behavior of other methods，特别是我们需要测试一个方法which调用其他在同一个类的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ToMock mock = partialMockBuilder(ToMock.class)</span><br><span class="line">  .addMockedMethod(<span class="string">"mockedMethod"</span>).createMock();</span><br></pre></td></tr></table></figure>
<h3 id="selt-testing"><a class="markdownIt-Anchor" href="#selt-testing"></a> Selt testing</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ToMock mock = partialMockBuilder(ToMock.class)</span><br><span class="line">  .withConstructor(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>); <span class="comment">// 1, 2, 3 are the constructor parameters</span></span><br></pre></td></tr></table></figure>
<h3 id="using-stub-behavior-for-methods"><a class="markdownIt-Anchor" href="#using-stub-behavior-for-methods"></a> Using Stub Behavior for Methods</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(mock.voteForRemoval(<span class="string">"Document"</span>)).andReturn(<span class="number">42</span>);</span><br><span class="line">expect(mock.voteForRemoval(not(eq(<span class="string">"Document"</span>)))).andStubReturn(-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h3 id="resuing-mock-object"><a class="markdownIt-Anchor" href="#resuing-mock-object"></a> Resuing mock object</h3>
<p>可以使用<code>reset(mock)</code>来reset mock.<br>
另外还有<code>resetwToNice(mock)</code>, <code>resetToDefault(mock)</code>, <code>resetToStrict(mock)</code>来reset到其他模式。</p>
<h2 id="behavior"><a class="markdownIt-Anchor" href="#behavior"></a> Behavior</h2>
<h3 id="a-second-test"><a class="markdownIt-Anchor" href="#a-second-test"></a> A second test</h3>
<p>假设我们有如下的test：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  mock.documentAdded(<span class="string">"New Document"</span>); <span class="comment">// 2</span></span><br><span class="line">  replay(mock); <span class="comment">// 3</span></span><br><span class="line">  classUnderTest.addDocument(<span class="string">"New Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]); <span class="comment">// will call mock.documentAdded()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Through the second, we expect a call to the mock.documentAdded() on the mock Object with the title of the document as argument.</p>
<p>在record state(记录状态下，也就是在调用replay之前)，mock并不会真正表现像其mock的object，而只是记录所有这个mock对象的method calls。在调用了<code>replay</code>之后，mock对象才真正具有mock object的行为，也就是会check是否方法正确被调用了。</p>
<p>这时如果调用mock object不存在的方法或者with wrong argument，或者调用次数不正确，mock object会抛出一个AssertionError:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError:</span><br><span class="line">  <span class="function">Unexpected method call <span class="title">documentAdded</span><span class="params">(<span class="string">"Wrong title"</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">documentAdded</span><span class="params">(<span class="string">"New Document"</span>)</span>: expected: 1, actual: 0</span></span><br><span class="line"><span class="function">      at org.easymock.internal.MockInvocationHandler.<span class="title">invoke</span><span class="params">(MockInvocationHandler.java:<span class="number">29</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.internal.ObjectMethodsFilter.<span class="title">invoke</span><span class="params">(ObjectMethodsFilter.java:<span class="number">44</span>)</span></span></span><br><span class="line"><span class="function">      at $Proxy0.<span class="title">documentAdded</span><span class="params">(Unknown Source)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ClassUnderTest.<span class="title">notifyListenersDocumentAdded</span><span class="params">(ClassUnderTest.java:<span class="number">61</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ClassUnderTest.<span class="title">addDocument</span><span class="params">(ClassUnderTest.java:<span class="number">28</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ExampleTest.<span class="title">testAddDocument</span><span class="params">(ExampleTest.java:<span class="number">30</span>)</span></span></span><br><span class="line"><span class="function">      ...</span></span><br></pre></td></tr></table></figure>
<p>如果方法被调用多次，mock object同样会抛出exception(默认是调用一次)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError:</span><br><span class="line">  <span class="function">Unexpected method call <span class="title">documentAdded</span><span class="params">(<span class="string">"New Document"</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">documentAdded</span><span class="params">(<span class="string">"New Document"</span>)</span>: expected: 1, actual: 2</span></span><br><span class="line"><span class="function">      at org.easymock.internal.MockInvocationHandler.<span class="title">invoke</span><span class="params">(MockInvocationHandler.java:<span class="number">29</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.internal.ObjectMethodsFilter.<span class="title">invoke</span><span class="params">(ObjectMethodsFilter.java:<span class="number">44</span>)</span></span></span><br><span class="line"><span class="function">      at $Proxy0.<span class="title">documentAdded</span><span class="params">(Unknown Source)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ClassUnderTest.<span class="title">notifyListenersDocumentAdded</span><span class="params">(ClassUnderTest.java:<span class="number">62</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ClassUnderTest.<span class="title">addDocument</span><span class="params">(ClassUnderTest.java:<span class="number">29</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ExampleTest.<span class="title">testAddDocument</span><span class="params">(ExampleTest.java:<span class="number">30</span>)</span></span></span><br><span class="line"><span class="function">      ...</span></span><br></pre></td></tr></table></figure>
<h3 id="changing-behavior-for-the-same-method-call"><a class="markdownIt-Anchor" href="#changing-behavior-for-the-same-method-call"></a> ** Changing Behavior for the Same Method Call</h3>
<p>It is also possible to specify a changing behavior for a method. The method <code>times,</code> <code>andReturn</code>, <code>andThrow</code> may be chained. As an example, we define <code>voteForRemoval(&quot;Document&quot;)</code> to</p>
<ul>
<li>return 42 for the first three calls,</li>
<li>throw a <code>RuntimeException</code> for the next four calls,</li>
<li>return -42 once.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expect(mock.voteForRemoval(<span class="string">"Document"</span>))</span><br><span class="line">  .andReturn((<span class="keyword">byte</span>) <span class="number">42</span>).times(<span class="number">3</span>)</span><br><span class="line">  .andThrow(<span class="keyword">new</span> RuntimeException(), <span class="number">4</span>)</span><br><span class="line">  .andReturn((<span class="keyword">byte</span>) -<span class="number">42</span>);</span><br></pre></td></tr></table></figure>
<h3 id="altering-easymock-default-behavior"><a class="markdownIt-Anchor" href="#altering-easymock-default-behavior"></a> Altering EasyMock default behavior</h3>
<p>EasyMock provides a property mechanisim allowing to alter its behavior. It mainly aims at allowing to use a legacy behavior on a new version. Currently supported properties are:</p>
<p><code>easymock.notThreadSafeByDefault</code><br>
If true, a mock won’t be thread-safe by default. Possible values are “true” or “false”. Default is false</p>
<p><code>easymock.enableThreadSafetyCheckByDefault</code><br>
If true, thread-safety check feature will be on by default. Possible values are “true” or “false”. Default is false</p>
<p><code>easymock.disableClassMocking</code><br>
Do not allow class mocking (only allow interface mocking). Possible values are “true” or “false”. Default is false.<br>
Properties can be set in two ways.</p>
<p>In an <code>easymock.properties</code> file set in the classpath default package<br>
By calling <code>EasyMock.setEasyMockProperty</code>. Constants are available in the <code>EasyMock</code> class. Setting properties in the code obviously override any property set in <code>easymock.properties</code></p>
<h3 id="using-stub-behavior-for-methods-2"><a class="markdownIt-Anchor" href="#using-stub-behavior-for-methods-2"></a> ** Using Stub Behavior for Methods</h3>
<p>Sometimes, we would like our Mock Object to respond to some method calls, but we do not want to check how often they are called, when they are called, or even if they are called at all. This stub behavoir may be defined by using the methods <code>andStubReturn(Object value)</code>, <code>andStubThrow(Throwable throwable)</code>, <code>andStubAnswer(IAnswer&lt;T&gt; answer)</code> and <code>asStub()</code>. The following code configures the MockObject to answer 42 to <code>voteForRemoval(&quot;Document&quot;)</code> once and -1 for all other arguments:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expect(mock.voteForRemoval(<span class="string">"Document"</span>)).andReturn(<span class="number">42</span>);</span><br><span class="line">expect(mock.voteForRemoval(not(eq(<span class="string">"Document"</span>)))).andStubReturn(-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h3 id="reusing-a-mock-object"><a class="markdownIt-Anchor" href="#reusing-a-mock-object"></a> ** Reusing a Mock Object</h3>
<p>Mock Objects may be reset by <code>reset(mock)</code>.</p>
<p>If needed, a mock can also be converted from one type to another by calling <code>resetToNice(mock)</code>, <code>resetToDefault(mock)</code> or <code>resetToStrict(mock)</code>.</p>
<h2 id="verification"><a class="markdownIt-Anchor" href="#verification"></a> Verification</h2>
<h3 id="a-first-verification"><a class="markdownIt-Anchor" href="#a-first-verification"></a> A first verification</h3>
<p>到目前为止，我们知道如何设定mock的behavior，但是我们还不知道这些指定的behavior有没有被执行，如果没有被执行，test只是会简单的被pass。如果要verify这些specified behavior是否被执行了，以及是否被执行了对应的次数，我们可以调用<code>verify(mock)</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  mock.documentAdded(<span class="string">"New Document"</span>); <span class="comment">// 2</span></span><br><span class="line">  replay(mock); <span class="comment">// 3</span></span><br><span class="line">  classUnderTest.addDocument(<span class="string">"New Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  verify(mock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果指定的方法没有被执行，我们会得到下面的exception：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError:</span><br><span class="line">  Expectation failure on verify:</span><br><span class="line">    documentAdded(<span class="string">"New Document"</span>): expected: <span class="number">1</span>, actual: <span class="number">0</span></span><br><span class="line">      at org.easymock.internal.MocksControl.verify(MocksControl.java:<span class="number">70</span>)</span><br><span class="line">      at org.easymock.EasyMock.verify(EasyMock.java:<span class="number">536</span>)</span><br><span class="line">      at org.easymock.samples.ExampleTest.testAddDocument(ExampleTest.java:<span class="number">31</span>)</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>
<p>message会列出所有missing的expected calls。</p>
<h3 id="expecting-an-explict-number-of-calls"><a class="markdownIt-Anchor" href="#expecting-an-explict-number-of-calls"></a> Expecting an Explict Number of Calls</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddAndChangeDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  mock.documentAdded(<span class="string">"Document"</span>);</span><br><span class="line">  mock.documentChanged(<span class="string">"Document"</span>);</span><br><span class="line">  mock.documentChanged(<span class="string">"Document"</span>);</span><br><span class="line">  mock.documentChanged(<span class="string">"Document"</span>);</span><br><span class="line">  replay(mock);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  verify(mock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以使用<code>time(N)</code>来代替声明多次方法调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddAndChangeDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  mock.documentAdded(<span class="string">"Document"</span>);</span><br><span class="line">  mock.documentChanged(<span class="string">"Document"</span>);</span><br><span class="line">  expectLastCall().times(<span class="number">3</span>);</span><br><span class="line">  replay(mock);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  verify(mock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果method调用太多次，则会得到exception：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError:</span><br><span class="line">  <span class="function">Unexpected method call <span class="title">documentChanged</span><span class="params">(<span class="string">"Document"</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">documentChanged</span><span class="params">(<span class="string">"Document"</span>)</span>: expected: 3, actual: 4</span></span><br><span class="line"><span class="function">      at org.easymock.internal.MockInvocationHandler.<span class="title">invoke</span><span class="params">(MockInvocationHandler.java:<span class="number">29</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.internal.ObjectMethodsFilter.<span class="title">invoke</span><span class="params">(ObjectMethodsFilter.java:<span class="number">44</span>)</span></span></span><br><span class="line"><span class="function">      at $Proxy0.<span class="title">documentChanged</span><span class="params">(Unknown Source)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ClassUnderTest.<span class="title">notifyListenersDocumentChanged</span><span class="params">(ClassUnderTest.java:<span class="number">67</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ClassUnderTest.<span class="title">addDocument</span><span class="params">(ClassUnderTest.java:<span class="number">26</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ExampleTest.<span class="title">testAddAndChangeDocument</span><span class="params">(ExampleTest.java:<span class="number">43</span>)</span></span></span><br><span class="line"><span class="function">      ...</span></span><br></pre></td></tr></table></figure>
<p>如果调用次数太少，同样得到exception</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError:</span><br><span class="line">  Expectation failure on verify:</span><br><span class="line">    documentChanged(<span class="string">"Document"</span>): expected: <span class="number">3</span>, actual: <span class="number">2</span></span><br><span class="line">      at org.easymock.internal.MocksControl.verify(MocksControl.java:<span class="number">70</span>)</span><br><span class="line">      at org.easymock.EasyMock.verify(EasyMock.java:<span class="number">536</span>)</span><br><span class="line">      at org.easymock.samples.ExampleTest.testAddAndChangeDocument(ExampleTest.java:<span class="number">43</span>)</span><br></pre></td></tr></table></figure>
<h3 id="specifying-return-values"><a class="markdownIt-Anchor" href="#specifying-return-values"></a> Specifying Return Values</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVoteForRemoval</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  mock.documentAdded(<span class="string">"Document"</span>);</span><br><span class="line">  <span class="comment">// expect document addition</span></span><br><span class="line">  <span class="comment">// expect to be asked to vote for document removal, and vote for it</span></span><br><span class="line">  expect(mock.voteForRemoval(<span class="string">"Document"</span>)).andReturn((<span class="keyword">byte</span>) <span class="number">42</span>);</span><br><span class="line">  mock.documentRemoved(<span class="string">"Document"</span>);</span><br><span class="line">  <span class="comment">// expect document removal</span></span><br><span class="line">  replay(mock);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  assertTrue(classUnderTest.removeDocument(<span class="string">"Document"</span>));</span><br><span class="line">  verify(mock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVoteAgainstRemoval</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  mock.documentAdded(<span class="string">"Document"</span>);</span><br><span class="line">  <span class="comment">// expect document addition</span></span><br><span class="line">  <span class="comment">// expect to be asked to vote for document removal, and vote against it</span></span><br><span class="line">  expect(mock.voteForRemoval(<span class="string">"Document"</span>)).andReturn((<span class="keyword">byte</span>) -<span class="number">42</span>);</span><br><span class="line">  replay(mock);</span><br><span class="line">  classUnderTest.addDocument(<span class="string">"Document"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">  assertFalse(classUnderTest.removeDocument(<span class="string">"Document"</span>));</span><br><span class="line">  verify(mock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回类型在编译的时候会被检查。<br>
两种指定<code>andReturn</code>的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expect(mock.voteForRemoval(<span class="string">"Document"</span>)).andReturn((<span class="keyword">byte</span>) <span class="number">42</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mock.voteForRemoval(<span class="string">"Document"</span>);</span><br><span class="line">expectLastCall().andReturn((<span class="keyword">byte</span>) <span class="number">42</span>);</span><br></pre></td></tr></table></figure>
<h3 id="working-with-exceptions"><a class="markdownIt-Anchor" href="#working-with-exceptions"></a> Working with Exceptions</h3>
<p>For specifying exceptions (more exactly: Throwables) to be thrown, the object returned by <code>expectLastCall()</code> and <code>expect(T value)</code> provides the method <code>andThrow(Throwable throwable)</code>. The method has to be called in record state after the call to the Mock Object for which it specifies the <code>Throwable</code> to be thrown.</p>
<p>Unchecked exceptions (that is, <code>RuntimeException</code>, <code>Error</code> and all their subclasses) can be thrown from every method. Checked exceptions can only be thrown from the methods that do actually throw them.</p>
<h3 id="creating-return-values-or-exceptions"><a class="markdownIt-Anchor" href="#creating-return-values-or-exceptions"></a> Creating Return Values or Exceptions</h3>
<p>前面的expected result都是在设计测试就已经确定。如果需要某个方法测试的返回结果根据传入参数或者其他因素变化时，我们需要使用<code>andAnswer(IAnswer answer)</code>。借助实现<code>IAnswer</code>接口我们可以设定如何得到returned value。<code>EasyMock.getCurrentArguments()</code>可以得到测试方法的输入参数。</p>
<p>An alternative to <code>IAnswer</code> are the <code>andDelegateTo</code> and <code>andStubDelegateTo</code> methods. They allow to delegate the call to a concrete implementation of the mocked interface that will then provide the answer. The pros are that the arguments found in <code>EasyMock.getCurrentArguments()</code> for <code>IAnswer</code> are now passed to the method of the concrete implementation.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; l = mock(List.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// andAnswer style</span></span><br><span class="line">expect(l.remove(<span class="number">10</span>)).andAnswer(<span class="keyword">new</span> IAnswer&lt;String&gt;() &#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">answer</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getCurrentArguments()[<span class="number">0</span>].toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// andDelegateTo style</span></span><br><span class="line">expect(l.remove(<span class="number">10</span>)).andDelegateTo(<span class="keyword">new</span> ArrayList&lt;String&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.toString(index);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="checking-method-call-order-between-mocks"><a class="markdownIt-Anchor" href="#checking-method-call-order-between-mocks"></a> Checking Method Call Order Between Mocks</h3>
<p>在只有一个mock object，如果需要check方法调用的顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IMyInterface mock = strictMock(IMyInterface.class);</span><br><span class="line">replay(mock);</span><br><span class="line">verify(mock);</span><br><span class="line">reset(mock);</span><br></pre></td></tr></table></figure>
<p>我们还可以这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IMocksControl ctrl = createStrictControl();</span><br><span class="line">IMyInterface mock = ctrl.createMock(IMyInterface.class);</span><br><span class="line">ctrl.replay();</span><br><span class="line">ctrl.verify();</span><br><span class="line">ctrl.reset();</span><br></pre></td></tr></table></figure>
<p>第二种方法的优势，当有多个mock object时，需要check多个mock object的方法调用顺序可以使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">IMocksControl ctrl = createStrictControl();</span><br><span class="line">IMyInterface mock1 = ctrl.createMock(IMyInterface.class);</span><br><span class="line">IMyInterface mock2 = ctrl.createMock(IMyInterface.class);</span><br><span class="line">mock1.a();</span><br><span class="line">mock2.a();</span><br><span class="line">ctrl.checkOrder(<span class="keyword">false</span>);</span><br><span class="line">mock1.c();</span><br><span class="line">expectLastCall().anyTimes();</span><br><span class="line">mock2.c();</span><br><span class="line">expectLastCall().anyTimes();</span><br><span class="line">ctrl.checkOrder(<span class="keyword">true</span>);</span><br><span class="line">mock2.b();</span><br><span class="line">mock1.b();</span><br><span class="line">ctrl.replay();</span><br></pre></td></tr></table></figure>
<h3 id="relaxing-call-counts"><a class="markdownIt-Anchor" href="#relaxing-call-counts"></a> Relaxing Call Counts</h3>
<p>To relax the expected call counts, there are additional methods that may be used instead of <code>times(int count)</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">times(<span class="keyword">int</span> min, <span class="keyword">int</span> max)</span><br></pre></td></tr></table></figure>
<p>to expect between min and max calls,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atLeastOnce()</span><br></pre></td></tr></table></figure>
<p>to expect at least one call, and</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">anyTimes()</span><br></pre></td></tr></table></figure>
<p>to expected an unrestricted number of calls.</p>
<p>If no call count is specified, one call is expected. If we would like to state this explicitely, <code>once()</code> or <code>times(1)</code> may be used.</p>
<h3 id="switching-order-checking-on-and-off"><a class="markdownIt-Anchor" href="#switching-order-checking-on-and-off"></a> Switching Order Checking On and Off</h3>
<p>Sometimes, it is necessary to have a Mock Object that checks the order of only some calls. In record phase, you may switch order checking on by calling <code>checkOrder(mock, true)</code> and switch it off by calling <code>checkOrder(mock, false)</code>.</p>
<p>There are two differences between a strict Mock Object and a normal Mock Object:</p>
<p>A strict Mock Object has order checking enabled after creation.<br>
A strict Mock Object has order checking enabled after reset (see Reusing a Mock Object).</p>
<h3 id="flexible-expectations-with-argument-matchers"><a class="markdownIt-Anchor" href="#flexible-expectations-with-argument-matchers"></a> ** Flexible Expectations with Argument Matchers</h3>
<p>在指定expected行为时，我们可能希望其行为根据输入参数改变而改变。<br>
默认的expeced的参数是使用<code>equals()</code>匹配的，也就是只有当实际调用时的参数<code>equals</code>expect时设置的参数才会得到expected的行为，否则则不是expeced的调用，会得到AssertionError。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] documents = <span class="keyword">new</span> String[] &#123; <span class="string">"Document 1"</span>, <span class="string">"Document 2"</span> &#125;;</span><br><span class="line">expect(mock.voteForRemovals(documents)).andReturn(<span class="number">42</span>);</span><br></pre></td></tr></table></figure>
<p>如果有下面调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] documentsArgs = <span class="keyword">new</span> String[] &#123;<span class="string">"doc1"</span>, <span class="string">"doc2"</span>&#125;;</span><br><span class="line">mock.voteForRemovals(documentsArgs);</span><br></pre></td></tr></table></figure>
<p>会得到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError:</span><br><span class="line">  <span class="function">Unexpected method call <span class="title">voteForRemovals</span><span class="params">([Ljava.lang.String;@<span class="number">9</span>a029e)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">voteForRemovals</span><span class="params">([Ljava.lang.String;@<span class="number">2</span>db19d)</span>: expected: 1, actual: 0</span></span><br><span class="line"><span class="function">    <span class="title">documentRemoved</span><span class="params">(<span class="string">"Document 1"</span>)</span>: expected: 1, actual: 0</span></span><br><span class="line"><span class="function">    <span class="title">documentRemoved</span><span class="params">(<span class="string">"Document 2"</span>)</span>: expected: 1, actual: 0</span></span><br><span class="line"><span class="function">      at org.easymock.internal.MockInvocationHandler.<span class="title">invoke</span><span class="params">(MockInvocationHandler.java:<span class="number">29</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.internal.ObjectMethodsFilter.<span class="title">invoke</span><span class="params">(ObjectMethodsFilter.java:<span class="number">44</span>)</span></span></span><br><span class="line"><span class="function">      at $Proxy0.<span class="title">voteForRemovals</span><span class="params">(Unknown Source)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ClassUnderTest.<span class="title">listenersAllowRemovals</span><span class="params">(ClassUnderTest.java:<span class="number">88</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ClassUnderTest.<span class="title">removeDocuments</span><span class="params">(ClassUnderTest.java:<span class="number">48</span>)</span></span></span><br><span class="line"><span class="function">      at org.easymock.samples.ExampleTest.<span class="title">testVoteForRemovals</span><span class="params">(ExampleTest.java:<span class="number">83</span>)</span></span></span><br><span class="line"><span class="function">      ...</span></span><br></pre></td></tr></table></figure>
<p>除了默认的<code>equals</code>的参数匹配器之外，EasyMock还提供了其他许多参数匹配器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eq(X value)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is equals the expected value. Available for all primitive types and for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">anyBoolean(), anyByte(), anyChar(), anyDouble(), anyFloat(), anyInt(), anyLong(), anyObject(), anyObject(Class clazz), anyShort(), anyString()</span><br></pre></td></tr></table></figure>
<p>Matches any value. Available for all primitive types and for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eq(X value, X delta)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is equal to the given value allowing the given delta. Available for <code>float</code>and <code>double</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aryEq(X value)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is equal to the given value according to <code>Arrays.equals()</code>. Available for primitive and object arrays.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isNull(), isNull(Class clazz)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is null. Available for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notNull(), notNull(Class clazz)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is not null. Available for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">same(X value)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is the same as the given value. Available for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isA(Class clazz)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is an instance of the given class, or if it is in instance of a class that extends or implements the given class. Null always return false. Available for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lt(X value), leq(X value), geq(X value), gt(X value)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is less/less or equal/greater or equal/greater than the given value. Available for all numeric primitive types and Comparable.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startsWith(String prefix), contains(String substring), endsWith(String suffix)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value starts with/contains/ends with the given value. Available for <code>String</code>s.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">matches(String regex), find(String regex)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value/a substring of the actual value matches the given regular expression. Available for <code>String</code>s.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and(X first, X second)</span><br></pre></td></tr></table></figure>
<p>Matches if the matchers used in <code>first</code> and <code>second</code> both match. Available for all primitive types and for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">or(X first, X second)</span><br></pre></td></tr></table></figure>
<p>Matches if one of the matchers used in <code>first</code> and <code>second</code> match. Available for all primitive types and for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">not(X value)</span><br></pre></td></tr></table></figure>
<p>Matches if the matcher used in <code>value</code> does not match.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmpEq(X value)</span><br></pre></td></tr></table></figure>
<p>Matches if the actual value is equals according to <code>Comparable.compareTo(X o)</code>. Available for all numeric primitive types and <code>Comparable</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmp(X value, Comparator&lt;X&gt; comparator, LogicalOperator operator)</span><br></pre></td></tr></table></figure>
<p>Matches if <code>comparator.compare(actual, value) operator 0</code> where the operator is &lt;,&lt;=,&gt;,&gt;= or ==. Available for objects.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">capture(Capture&lt;T&gt; capture), captureXXX(Capture&lt;T&gt; capture)</span><br></pre></td></tr></table></figure>
<p>Matches any value but captures it in the Capture parameter for later access. You can do <code>and(someMatcher(...), capture(c))</code> to capture a parameter from a specific call to the method. You can also specify a <code>CaptureType</code> telling that a given <code>Capture</code> should keep the first, the last, all or no captured values.</p>
<p>另外需要注意的是，传入参数为基本类型时而允许任何值时，需要使用<code>EasyMock.anyLong()</code>，而不能用<code>EasyMock.isA(Long.class)</code></p>
<p>传入参数可能为null时，需要使用<code>or(isA(String.class), isNull())</code>这样的形式，而不能只是<code>isA(String.class)</code>。</p>
<h3 id="defining-your-own-argument-matchers"><a class="markdownIt-Anchor" href="#defining-your-own-argument-matchers"></a> Defining your own Argument Matchers</h3>
<p>除了上面的参数matcher，我们还可以定义自己的参数matcher。</p>
<p>Sometimes it is desirable to define own argument matchers. Let’s say that an argument matcher is needed that matches an exception if the given exception has the same type and an equal message. It should be used this way:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IllegalStateException e = <span class="keyword">new</span> IllegalStateException(<span class="string">"Operation not allowed."</span>)</span><br><span class="line">expect(mock.logThrowable(eqException(e))).andReturn(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>Two steps are necessary to achieve this:</p>
<ol>
<li>The new argument matcher has to be defined,</li>
<li>and the static method <code>eqException</code> has to be declared.</li>
</ol>
<p>To define the new argument matcher, we implement the interface <code>org.easymock.IArgumentMatcher</code>. This interface contains two methods: <code>matches(Object actual)</code> checks whether the actual argument matches the given argument, and <code>appendTo(StringBuffer buffer)</code> appends a string representation of the argument matcher to the given string buffer. The implementation is straightforward:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.easymock.IArgumentMatcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThrowableEquals</span> <span class="keyword">implements</span> <span class="title">IArgumentMatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Throwable expected;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ThrowableEquals</span><span class="params">(Throwable expected)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.expected = expected;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Object actual)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(actual <span class="keyword">instanceof</span> Throwable)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String actualMessage = ((Throwable) actual).getMessage();</span><br><span class="line">    <span class="keyword">return</span> expected.getClass().equals(actual.getClass()) &amp;amp;&amp;amp; expected.getMessage().equals(actualMessage);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendTo</span><span class="params">(StringBuffer buffer)</span> </span>&#123;</span><br><span class="line">    buffer.append(<span class="string">"eqException("</span>);</span><br><span class="line">    buffer.append(expected.getClass().getName());</span><br><span class="line">    buffer.append(<span class="string">" with message \""</span>);</span><br><span class="line">    buffer.append(expected.getMessage());</span><br><span class="line">    buffer.append(<span class="string">"\""</span>)<span class="string">");</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>The method <code>eqException</code> must create the argument matcher with the given Throwable, report it to EasyMock via the static method <code>reportMatcher(IArgumentMatcher matcher)</code>, and return a value so that it may be used inside the call (typically <code>0</code>, <code>null</code> or <code>false</code>). A first attempt may look like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">eqException</span><span class="params">(Throwable in)</span> </span>&#123;</span><br><span class="line">  EasyMock.reportMatcher(<span class="keyword">new</span> ThrowableEquals(in));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>However, this only works if the method <code>logThrowable</code> in the example usage accepts <code>Throwable</code>s, and does not require something more specific like a <code>RuntimeException</code>. In the latter case, our code sample would not compile:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IllegalStateException e = new IllegalStateException(&quot;Operation not allowed.&quot;)</span><br><span class="line">expect(mock.logThrowable(eqException(e))).andReturn(true);</span><br></pre></td></tr></table></figure>
<p>Java 5.0 to the rescue: Instead of defining <code>eqException</code> with a Throwable as parameter and return value, we use a generic type that extends <code>Throwable</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Throwable&gt; eqException(T in) &#123;</span><br><span class="line">  reportMatcher(<span class="keyword">new</span> ThrowableEquals(in));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Refer to <a href="http://easymock.org/user-guide.html" target="_blank" rel="noopener">EasyMock user guide</a>.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/13/NLP_Statistical Machine Translation IBM Models 1 and 2/" rel="next" title="Statistical Machine Translation IBM Models 1 and 2">
                <i class="fa fa-chevron-left"></i> Statistical Machine Translation IBM Models 1 and 2
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/18/Developing_Autocomplete/" rel="prev" title="Autocomplete">
                Autocomplete <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/plusaber.jpg" alt="Plusaber">
            
              <p class="site-author-name" itemprop="name">Plusaber</p>
              <div class="site-description motion-element" itemprop="description">Plusaber's Blog</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">82</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jp.linkedin.com/in/zebangchen" title="https://jp.linkedin.com/in/zebangchen" rel="noopener" target="_blank">LinkedIn</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://indeed.com" title="https://indeed.com" rel="noopener" target="_blank">Indeed</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://baito.indeed.com" title="https://baito.indeed.com" rel="noopener" target="_blank">Baito</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.kaggle.com" title="https://www.kaggle.com" rel="noopener" target="_blank">Kaggle</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#installation"><span class="nav-number">1.</span> <span class="nav-text"> Installation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mocking"><span class="nav-number">2.</span> <span class="nav-text"> Mocking</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#the-first-mock-object"><span class="nav-number">2.1.</span> <span class="nav-text"> The first Mock Object</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#using-annotations"><span class="nav-number">2.2.</span> <span class="nav-text"> Using annotations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#easymocksupport"><span class="nav-number">2.3.</span> <span class="nav-text"> EasyMockSupport</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strict-mocks"><span class="nav-number">2.4.</span> <span class="nav-text"> Strict Mocks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nice-mocks"><span class="nav-number">2.5.</span> <span class="nav-text"> Nice mocks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#partial-mocking"><span class="nav-number">2.6.</span> <span class="nav-text"> Partial mocking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#selt-testing"><span class="nav-number">2.7.</span> <span class="nav-text"> Selt testing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#using-stub-behavior-for-methods"><span class="nav-number">2.8.</span> <span class="nav-text"> Using Stub Behavior for Methods</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#resuing-mock-object"><span class="nav-number">2.9.</span> <span class="nav-text"> Resuing mock object</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#behavior"><span class="nav-number">3.</span> <span class="nav-text"> Behavior</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#a-second-test"><span class="nav-number">3.1.</span> <span class="nav-text"> A second test</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#changing-behavior-for-the-same-method-call"><span class="nav-number">3.2.</span> <span class="nav-text"> ** Changing Behavior for the Same Method Call</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#altering-easymock-default-behavior"><span class="nav-number">3.3.</span> <span class="nav-text"> Altering EasyMock default behavior</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#using-stub-behavior-for-methods-2"><span class="nav-number">3.4.</span> <span class="nav-text"> ** Using Stub Behavior for Methods</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reusing-a-mock-object"><span class="nav-number">3.5.</span> <span class="nav-text"> ** Reusing a Mock Object</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#verification"><span class="nav-number">4.</span> <span class="nav-text"> Verification</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#a-first-verification"><span class="nav-number">4.1.</span> <span class="nav-text"> A first verification</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#expecting-an-explict-number-of-calls"><span class="nav-number">4.2.</span> <span class="nav-text"> Expecting an Explict Number of Calls</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#specifying-return-values"><span class="nav-number">4.3.</span> <span class="nav-text"> Specifying Return Values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#working-with-exceptions"><span class="nav-number">4.4.</span> <span class="nav-text"> Working with Exceptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#creating-return-values-or-exceptions"><span class="nav-number">4.5.</span> <span class="nav-text"> Creating Return Values or Exceptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#checking-method-call-order-between-mocks"><span class="nav-number">4.6.</span> <span class="nav-text"> Checking Method Call Order Between Mocks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#relaxing-call-counts"><span class="nav-number">4.7.</span> <span class="nav-text"> Relaxing Call Counts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#switching-order-checking-on-and-off"><span class="nav-number">4.8.</span> <span class="nav-text"> Switching Order Checking On and Off</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flexible-expectations-with-argument-matchers"><span class="nav-number">4.9.</span> <span class="nav-text"> ** Flexible Expectations with Argument Matchers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#defining-your-own-argument-matchers"><span class="nav-number">4.10.</span> <span class="nav-text"> Defining your own Argument Matchers</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Plusaber</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.1"></script>




  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://plusaber.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "http://yoursite.com/2016/12/05/Java_EasyMock/";
    this.page.identifier = "2016/12/05/Java_EasyMock/";
    this.page.title = 'Let\'s EasyMock';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://plusaber.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  




  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').not('.gist .highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('Copy');
      }, 300);
    }).append(e);
  })
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  

  

</body>
</html>
